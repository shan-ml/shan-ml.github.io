<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="Eureka分为Client端和Server端，Client端向Server端注册自己的服务信息，并且拉取所有服务的注册信息，Server端作为注册中心，负责接收Client端的注册信息，维护所有服务的注册信息，Server端也可以开启集群模式，相互之间同步服务的注册信息。 与缓存相关的三个变量 1.registry1private final ConcurrentHashMap&amp;lt;Strin">
<meta property="og:type" content="article">
<meta property="og:title" content="Eureka缓存机制">
<meta property="og:url" content="http://yoursite.com/2020/03/15/【Spring Cloud】Eureka缓存机制/index.html">
<meta property="og:site_name" content="SHAN">
<meta property="og:description" content="Eureka分为Client端和Server端，Client端向Server端注册自己的服务信息，并且拉取所有服务的注册信息，Server端作为注册中心，负责接收Client端的注册信息，维护所有服务的注册信息，Server端也可以开启集群模式，相互之间同步服务的注册信息。 与缓存相关的三个变量 1.registry1private final ConcurrentHashMap&amp;lt;Strin">
<meta property="og:locale" content="default">
<meta property="og:image" content="http://yoursite.com/images/cache.png">
<meta property="og:image" content="http://yoursite.com/images/fetchregistry.png">
<meta property="og:updated_time" content="2020-03-15T12:25:33.988Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Eureka缓存机制">
<meta name="twitter:description" content="Eureka分为Client端和Server端，Client端向Server端注册自己的服务信息，并且拉取所有服务的注册信息，Server端作为注册中心，负责接收Client端的注册信息，维护所有服务的注册信息，Server端也可以开启集群模式，相互之间同步服务的注册信息。 与缓存相关的三个变量 1.registry1private final ConcurrentHashMap&amp;lt;Strin">
<meta name="twitter:image" content="http://yoursite.com/images/cache.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2020/03/15/【Spring Cloud】Eureka缓存机制/"/>





  <title>Eureka缓存机制 | SHAN</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="default">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">SHAN</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/03/15/【Spring Cloud】Eureka缓存机制/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="shan">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="SHAN">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Eureka缓存机制</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-03-15T15:00:00+08:00">
                2020-03-15
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>Eureka分为Client端和Server端，Client端向Server端注册自己的服务信息，并且拉取所有服务的注册信息，Server端作为注册中心，负责接收Client端的注册信息，维护所有服务的注册信息，Server端也可以开启集群模式，相互之间同步服务的注册信息。</p>
<p><strong>与缓存相关的三个变量</strong></p>
<h5 id="1-registry"><a href="#1-registry" class="headerlink" title="1.registry"></a>1.registry</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ConcurrentHashMap&lt;String, Map&lt;String, Lease&lt;InstanceInfo&gt;&gt;&gt; registry</span><br></pre></td></tr></table></figure>
<p>AbstractInstanceRegistry的成员变量，相当于服务端的注册表，维护所有服务的注册信息，第一层Map的key是服务的应用名称，value也是一个map,其中key是实例id,value是实例的详细信息(Lease<instanceinfo>)。</instanceinfo></p>
<h5 id="2-readWriteCacheMap"><a href="#2-readWriteCacheMap" class="headerlink" title="2.readWriteCacheMap"></a>2.readWriteCacheMap</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> LoadingCache&lt;Key, ResponseCacheImpl.Value&gt; readWriteCacheMap;</span><br></pre></td></tr></table></figure>
<p>ResponseCacheImpl的成员变量,使用的是guava的LoadingCache构建的缓存，其中key为com.netflix.eureka.registry包下的Key对象，value是ResponseCacheImpl的内部类Value对象，从名称上可以看出它是一个读写缓存。</p>
<h5 id="3-readOnlyCacheMap"><a href="#3-readOnlyCacheMap" class="headerlink" title="3.readOnlyCacheMap"></a>3.readOnlyCacheMap</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ConcurrentMap&lt;Key, ResponseCacheImpl.Value&gt; readOnlyCacheMap = <span class="keyword">new</span> ConcurrentHashMap();</span><br></pre></td></tr></table></figure>
<p>ResponseCacheImpl的成员变量，同样是一个ConcurrentMap，从名称上可以看出它是一个只读的缓存对象。</p>
<p>所以Eureka Server使用了一个读写分离的两级缓存机制，registry负责维护所有服务的注册信息，当register数据有变化，将会更新readWriteCacheMap的内容，后台开启定时任务，默认30s从readWriteCacheMap同步数据到readOnlyCacheMap，Eureka Client拉取服务的注册信息时，从readOnlyCacheMap读取数据，并没有直接从readWriteCacheMap中获取数据:</p>
<p><img src="/images/cache.png" alt=""> </p>
<p>Client从Server端拉取数据流程：</p>
<p>（1）Client端DiscoveryClient的构造函数中，会初始化定时任务；</p>
<p>（2）缓存刷新任务，定时发送请求到Server端，拉取服务的注册数据，Server端收到请求，首先会根据请求信息构建key，根据key从缓存中获取数据；</p>
<p>（3）Server端根据key获取缓存数据时，会判断是否开启了使用readOnly缓存：</p>
<pre><code>如果开启：先从readOnlyCacheMap获取，如果从readOnlyCacheMap未获取到数据，再从readWriteCacheMap中查找；

如果未开启：直接从readWriteCacheMap中获取；
</code></pre><p>（4）从readWriteCacheMap获取数据也有两种结果：</p>
<pre><code>第一：获取到数据，如果开启了readOnly缓存，会将结果设置到readOnlyCacheMap中，否则直接返回结果即可；

第二：未获取到数据，由于readWriteCacheMap使用的是guava构建的缓存，从readWriteCacheMap根据key获取数据，假如key不存在的活，就会触发load方法，在这个方法中会调用generatePayload方法从registry中获取数据构并建缓存数据返回；
</code></pre><p>（5）Server端将结果设置到response返回到Client端；</p>
<p><img src="/images/fetchregistry.png" alt=""> </p>
<h3 id="源码"><a href="#源码" class="headerlink" title="源码"></a>源码</h3><h4 id="Eureka-Server"><a href="#Eureka-Server" class="headerlink" title="Eureka Server"></a>Eureka Server</h4><p><strong>AbstractInstanceRegistry</strong></p>
<p>以register服务注册方法看一下缓存更新的流程，在register方法中，服务进行注册的时候，会根据服务的应用名称appName,调用invalidateCache方法清除之前存在的缓存。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractInstanceRegistry</span> <span class="keyword">implements</span> <span class="title">InstanceRegistry</span></span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// server端的注册表，key是服务的应用名称，value又是一个map, key是实例id,value是实例的详细信息(Lease&lt;InstanceInfo&gt;)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ConcurrentHashMap&lt;String, Map&lt;String, Lease&lt;InstanceInfo&gt;&gt;&gt; registry = <span class="keyword">new</span> ConcurrentHashMap();</span><br><span class="line">    </span><br><span class="line">    ...</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 注册服务</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">register</span><span class="params">(InstanceInfo registrant, <span class="keyword">int</span> leaseDuration, <span class="keyword">boolean</span> isReplication)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.read.lock();</span><br><span class="line">            <span class="comment">// 根据应用名称从注册表中获取实例</span></span><br><span class="line">            Map&lt;String, Lease&lt;InstanceInfo&gt;&gt; gMap = (Map)<span class="keyword">this</span>.registry.get(registrant.getAppName());</span><br><span class="line">            EurekaMonitors.REGISTER.increment(isReplication);</span><br><span class="line">            <span class="comment">// 如果获取的实例为空</span></span><br><span class="line">            <span class="keyword">if</span>(gMap == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// 创建一个hashmap</span></span><br><span class="line">                ConcurrentHashMap&lt;String, Lease&lt;InstanceInfo&gt;&gt; gNewMap = <span class="keyword">new</span> ConcurrentHashMap();</span><br><span class="line">                <span class="comment">// 加入注册表</span></span><br><span class="line">                gMap = (Map)<span class="keyword">this</span>.registry.putIfAbsent(registrant.getAppName(), gNewMap);</span><br><span class="line">                <span class="keyword">if</span>(gMap == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    gMap = gNewMap;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 根据实例ID获取，实例的详细信息</span></span><br><span class="line">            Lease&lt;InstanceInfo&gt; existingLease = (Lease)((Map)gMap).get(registrant.getId());</span><br><span class="line">            </span><br><span class="line">            ...</span><br><span class="line">            </span><br><span class="line">            registrant.setActionType(ActionType.ADDED);</span><br><span class="line">            <span class="keyword">this</span>.recentlyChangedQueue.add(<span class="keyword">new</span> AbstractInstanceRegistry.RecentlyChangedItem(lease));</span><br><span class="line">            registrant.setLastUpdatedTimestamp();</span><br><span class="line">            <span class="comment">// 清除缓存</span></span><br><span class="line">            <span class="keyword">this</span>.invalidateCache(registrant.getAppName(), registrant.getVIPAddress(), registrant.getSecureVipAddress());</span><br><span class="line">            logger.info(<span class="string">"Registered instance &#123;&#125;/&#123;&#125; with status &#123;&#125; (replication=&#123;&#125;)"</span>, <span class="keyword">new</span> Object[]&#123;registrant.getAppName(), registrant.getId(), registrant.getStatus(), Boolean.valueOf(isReplication)&#125;);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.read.unlock();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 清除缓存</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">invalidateCache</span><span class="params">(String appName, @Nullable String vipAddress, @Nullable String secureVipAddress)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.responseCache.invalidate(appName, vipAddress, secureVipAddress);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>ResponseCacheImpl</strong></p>
<p>（1）ResponseCacheImpl中包含了readOnlyCacheMap只读缓存对象和readWriteCacheMap读写缓存对象，其中readWriteCacheMap使用的是guava的缓存机制，如果根据key从readWriteCacheMap获取数据时没有这个key，将会调用load方法，在load方法中是调用generatePayload构建Value对象的，在generatePayload是从registry获取数据的，也就是说当readWriteCacheMap不存在某个key是会从registry获取数据。</p>
<p>（2）在构造函数中，初始化了readWriteCacheMap对象，并判断是否使用readOnlyCacheMap缓存，如果开启，设置定时任务getCacheUpdateTask，定时从readWriteCacheMap同步数据到readOnlyCacheMap，同步方式是遍历readOnlyCacheMap，判断value是否与readWriteCacheMap的数据一致，如果不一致，以readWriteCacheMap的数据为准，更新readOnlyCacheMap的数据。</p>
<p>（3）invalidate方法用来清除readWriteCacheMap中的缓存.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ResponseCacheImpl</span> <span class="keyword">implements</span> <span class="title">ResponseCache</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// readOnlyCacheMap缓存</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ConcurrentMap&lt;Key, ResponseCacheImpl.Value&gt; readOnlyCacheMap = <span class="keyword">new</span> ConcurrentHashMap();</span><br><span class="line">    <span class="comment">// guava构建的readWriteCacheMap缓存</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> LoadingCache&lt;Key, ResponseCacheImpl.Value&gt; readWriteCacheMap;</span><br><span class="line">    ...</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 构造函数</span></span><br><span class="line">    ResponseCacheImpl(EurekaServerConfig serverConfig, ServerCodecs serverCodecs, AbstractInstanceRegistry registry) &#123;</span><br><span class="line">        <span class="keyword">this</span>.serverConfig = serverConfig;</span><br><span class="line">        <span class="keyword">this</span>.serverCodecs = serverCodecs;</span><br><span class="line">        <span class="comment">// 是否使用只读缓存</span></span><br><span class="line">        <span class="keyword">this</span>.shouldUseReadOnlyResponseCache = serverConfig.shouldUseReadOnlyResponseCache();</span><br><span class="line">        <span class="keyword">this</span>.registry = registry;</span><br><span class="line">        <span class="comment">// 缓存更新间隔</span></span><br><span class="line">        <span class="keyword">long</span> responseCacheUpdateIntervalMs = serverConfig.getResponseCacheUpdateIntervalMs();</span><br><span class="line">        <span class="comment">// 构建缓存对象，初始容量为1000</span></span><br><span class="line">        <span class="keyword">this</span>.readWriteCacheMap = CacheBuilder.newBuilder().initialCapacity(<span class="number">1000</span>).expireAfterWrite(serverConfig.getResponseCacheAutoExpirationInSeconds(), TimeUnit.SECONDS).removalListener(<span class="keyword">new</span> RemovalListener&lt;Key, ResponseCacheImpl.Value&gt;() &#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onRemoval</span><span class="params">(RemovalNotification&lt;Key, ResponseCacheImpl.Value&gt; notification)</span> </span>&#123;</span><br><span class="line">                Key removedKey = (Key)notification.getKey();</span><br><span class="line">                <span class="keyword">if</span>(removedKey.hasRegions()) &#123;</span><br><span class="line">                    Key cloneWithNoRegions = removedKey.cloneWithoutRegions();</span><br><span class="line">                    ResponseCacheImpl.<span class="keyword">this</span>.regionSpecificKeys.remove(cloneWithNoRegions, removedKey);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).build(<span class="keyword">new</span> CacheLoader&lt;Key, ResponseCacheImpl.Value&gt;() &#123;</span><br><span class="line">            <span class="comment">// 如果缓存中key不存在，会调用load方法</span></span><br><span class="line">            <span class="keyword">public</span> ResponseCacheImpl.<span class="function">Value <span class="title">load</span><span class="params">(Key key)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                <span class="keyword">if</span>(key.hasRegions()) &#123;</span><br><span class="line">                    Key cloneWithNoRegions = key.cloneWithoutRegions();</span><br><span class="line">                    ResponseCacheImpl.<span class="keyword">this</span>.regionSpecificKeys.put(cloneWithNoRegions, key);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 根据key构建缓存数据</span></span><br><span class="line">                ResponseCacheImpl.Value value = ResponseCacheImpl.<span class="keyword">this</span>.generatePayload(key);</span><br><span class="line">                <span class="keyword">return</span> value;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">// 如果使用只读缓存</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">this</span>.shouldUseReadOnlyResponseCache) &#123;</span><br><span class="line">            <span class="comment">// 注册定时任务，同步数据</span></span><br><span class="line">            <span class="keyword">this</span>.timer.schedule(<span class="keyword">this</span>.getCacheUpdateTask(), <span class="keyword">new</span> Date(System.currentTimeMillis() / responseCacheUpdateIntervalMs * responseCacheUpdateIntervalMs + responseCacheUpdateIntervalMs), responseCacheUpdateIntervalMs);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Monitors.registerObject(<span class="keyword">this</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable var7) &#123;</span><br><span class="line">            logger.warn(<span class="string">"Cannot register the JMX monitor for the InstanceRegistry"</span>, var7);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 清除缓存</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">invalidate</span><span class="params">(String appName, @Nullable String vipAddress, @Nullable String secureVipAddress)</span> </span>&#123;</span><br><span class="line">        KeyType[] var4 = KeyType.values();</span><br><span class="line">        <span class="keyword">int</span> var5 = var4.length;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> var6 = <span class="number">0</span>; var6 &lt; var5; ++var6) &#123;</span><br><span class="line">            KeyType type = var4[var6];</span><br><span class="line">            Version[] var8 = Version.values();</span><br><span class="line">            <span class="keyword">int</span> var9 = var8.length;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> var10 = <span class="number">0</span>; var10 &lt; var9; ++var10) &#123;</span><br><span class="line">                Version v = var8[var10];</span><br><span class="line">                <span class="comment">// 实际上调用的invalidate(Key... keys)方法</span></span><br><span class="line">                <span class="keyword">this</span>.invalidate(<span class="keyword">new</span> Key[]&#123;<span class="keyword">new</span> Key(EntityType.Application, appName, type, v, EurekaAccept.full), <span class="keyword">new</span> Key(EntityType.Application, appName, type, v, EurekaAccept.compact), <span class="keyword">new</span> Key(EntityType.Application, <span class="string">"ALL_APPS"</span>, type, v, EurekaAccept.full), <span class="keyword">new</span> Key(EntityType.Application, <span class="string">"ALL_APPS"</span>, type, v, EurekaAccept.compact), <span class="keyword">new</span> Key(EntityType.Application, <span class="string">"ALL_APPS_DELTA"</span>, type, v, EurekaAccept.full), <span class="keyword">new</span> Key(EntityType.Application, <span class="string">"ALL_APPS_DELTA"</span>, type, v, EurekaAccept.compact)&#125;);</span><br><span class="line">                <span class="keyword">if</span>(<span class="keyword">null</span> != vipAddress) &#123;</span><br><span class="line">                    <span class="keyword">this</span>.invalidate(<span class="keyword">new</span> Key[]&#123;<span class="keyword">new</span> Key(EntityType.VIP, vipAddress, type, v, EurekaAccept.full)&#125;);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span>(<span class="keyword">null</span> != secureVipAddress) &#123;</span><br><span class="line">                    <span class="keyword">this</span>.invalidate(<span class="keyword">new</span> Key[]&#123;<span class="keyword">new</span> Key(EntityType.SVIP, secureVipAddress, type, v, EurekaAccept.full)&#125;);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">invalidate</span><span class="params">(Key... keys)</span> </span>&#123;</span><br><span class="line">        Key[] var2 = keys;</span><br><span class="line">        <span class="keyword">int</span> var3 = keys.length;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> var4 = <span class="number">0</span>; var4 &lt; var3; ++var4) &#123;</span><br><span class="line">            Key key = var2[var4];</span><br><span class="line">            logger.debug(<span class="string">"Invalidating the response cache key : &#123;&#125; &#123;&#125; &#123;&#125; &#123;&#125;, &#123;&#125;"</span>, <span class="keyword">new</span> Object[]&#123;key.getEntityType(), key.getName(), key.getVersion(), key.getType(), key.getEurekaAccept()&#125;);</span><br><span class="line">            <span class="comment">// 根据key清除缓存</span></span><br><span class="line">            <span class="keyword">this</span>.readWriteCacheMap.invalidate(key);</span><br><span class="line">            Collection&lt;Key&gt; keysWithRegions = <span class="keyword">this</span>.regionSpecificKeys.get(key);</span><br><span class="line">            <span class="keyword">if</span>(<span class="keyword">null</span> != keysWithRegions &amp;&amp; !keysWithRegions.isEmpty()) &#123;</span><br><span class="line">                Iterator var7 = keysWithRegions.iterator();</span><br><span class="line"></span><br><span class="line">                <span class="keyword">while</span>(var7.hasNext()) &#123;</span><br><span class="line">                    Key keysWithRegion = (Key)var7.next();</span><br><span class="line">                    logger.debug(<span class="string">"Invalidating the response cache key : &#123;&#125; &#123;&#125; &#123;&#125; &#123;&#125; &#123;&#125;"</span>, <span class="keyword">new</span> Object[]&#123;key.getEntityType(), key.getName(), key.getVersion(), key.getType(), key.getEurekaAccept()&#125;);</span><br><span class="line">                    <span class="keyword">this</span>.readWriteCacheMap.invalidate(keysWithRegion);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 定时任务，从readWriteCacheMap同步数据到readOnlyCacheMap</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> TimerTask <span class="title">getCacheUpdateTask</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> TimerTask() &#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                ResponseCacheImpl.logger.debug(<span class="string">"Updating the client cache from response cache"</span>);</span><br><span class="line">                Iterator var1 = ResponseCacheImpl.<span class="keyword">this</span>.readOnlyCacheMap.keySet().iterator();</span><br><span class="line">                <span class="comment">// 遍历readOnlyCacheMap</span></span><br><span class="line">                <span class="keyword">while</span>(var1.hasNext()) &#123;</span><br><span class="line">                    Key key = (Key)var1.next();</span><br><span class="line">                    <span class="keyword">if</span>(ResponseCacheImpl.logger.isDebugEnabled()) &#123;</span><br><span class="line">                        ResponseCacheImpl.logger.debug(<span class="string">"Updating the client cache from response cache for key : &#123;&#125; &#123;&#125; &#123;&#125; &#123;&#125;"</span>, <span class="keyword">new</span> Object[]&#123;key.getEntityType(), key.getName(), key.getVersion(), key.getType()&#125;);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        CurrentRequestVersion.set(key.getVersion());</span><br><span class="line">                        <span class="comment">// 从readWriteCacheMap根据key获取数据</span></span><br><span class="line">                        ResponseCacheImpl.Value cacheValue = (ResponseCacheImpl.Value)ResponseCacheImpl.<span class="keyword">this</span>.readWriteCacheMap.get(key);</span><br><span class="line">                        <span class="comment">// 从readOnlyCacheMap获取数据</span></span><br><span class="line">                        ResponseCacheImpl.Value currentCacheValue = (ResponseCacheImpl.Value)ResponseCacheImpl.<span class="keyword">this</span>.readOnlyCacheMap.get(key);</span><br><span class="line">                        <span class="comment">// 对比数据是否一致</span></span><br><span class="line">                        <span class="keyword">if</span>(cacheValue != currentCacheValue) &#123;</span><br><span class="line">                           <span class="comment">// 如果数据不一致，更新readOnlyCacheMap的数据 ResponseCacheImpl.this.readOnlyCacheMap.put(key, cacheValue);</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Throwable var5) &#123;</span><br><span class="line">                        ResponseCacheImpl.logger.error(<span class="string">"Error while updating the client cache from response cache for key &#123;&#125;"</span>, key.toStringCompact(), var5);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 根据key生成ResponseCacheImpl.Value对象</span></span><br><span class="line">    <span class="keyword">private</span> ResponseCacheImpl.<span class="function">Value <span class="title">generatePayload</span><span class="params">(Key key)</span> </span>&#123;</span><br><span class="line">        Stopwatch tracer = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        ResponseCacheImpl.Value var8;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String payload;</span><br><span class="line">            <span class="keyword">switch</span>(<span class="keyword">null</span>.$SwitchMap$com$netflix$eureka$registry$Key$EntityType[key.getEntityType().ordinal()]) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">                <span class="keyword">boolean</span> isRemoteRegionRequested = key.hasRegions();</span><br><span class="line">                <span class="comment">// 全量获取</span></span><br><span class="line">                <span class="keyword">if</span>(<span class="string">"ALL_APPS"</span>.equals(key.getName())) &#123;</span><br><span class="line">                    <span class="keyword">if</span>(isRemoteRegionRequested) &#123;</span><br><span class="line">                        tracer = <span class="keyword">this</span>.serializeAllAppsWithRemoteRegionTimer.start();</span><br><span class="line">                        payload = <span class="keyword">this</span>.getPayLoad(key, <span class="keyword">this</span>.registry.getApplicationsFromMultipleRegions(key.getRegions()));</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        tracer = <span class="keyword">this</span>.serializeAllAppsTimer.start();</span><br><span class="line">                        <span class="comment">// 从registry获取数据</span></span><br><span class="line">                        payload = <span class="keyword">this</span>.getPayLoad(key, <span class="keyword">this</span>.registry.getApplications());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span>(<span class="string">"ALL_APPS_DELTA"</span>.equals(key.getName())) &#123;<span class="comment">// 增量获取</span></span><br><span class="line">                    <span class="keyword">if</span>(isRemoteRegionRequested) &#123;</span><br><span class="line">                        tracer = <span class="keyword">this</span>.serializeDeltaAppsWithRemoteRegionTimer.start();</span><br><span class="line">                        <span class="keyword">this</span>.versionDeltaWithRegions.incrementAndGet();</span><br><span class="line">                        versionDeltaWithRegionsLegacy.incrementAndGet();</span><br><span class="line">                        payload = <span class="keyword">this</span>.getPayLoad(key, <span class="keyword">this</span>.registry.getApplicationDeltasFromMultipleRegions(key.getRegions()));</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        tracer = <span class="keyword">this</span>.serializeDeltaAppsTimer.start();</span><br><span class="line">                        <span class="keyword">this</span>.versionDelta.incrementAndGet();</span><br><span class="line">                        versionDeltaLegacy.incrementAndGet();</span><br><span class="line">                        payload = <span class="keyword">this</span>.getPayLoad(key, <span class="keyword">this</span>.registry.getApplicationDeltas());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    tracer = <span class="keyword">this</span>.serializeOneApptimer.start();</span><br><span class="line">                    payload = <span class="keyword">this</span>.getPayLoad(key, <span class="keyword">this</span>.registry.getApplication(key.getName()));</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">            <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">                tracer = <span class="keyword">this</span>.serializeViptimer.start();</span><br><span class="line">                payload = <span class="keyword">this</span>.getPayLoad(key, getApplicationsForVip(key, <span class="keyword">this</span>.registry));</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                logger.error(<span class="string">"Unidentified entity type: &#123;&#125; found in the cache key."</span>, key.getEntityType());</span><br><span class="line">                payload = <span class="string">""</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            var8 = <span class="keyword">new</span> ResponseCacheImpl.Value(payload);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span>(tracer != <span class="keyword">null</span>) &#123;</span><br><span class="line">                tracer.stop();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> var8;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>ApplicationsResource</strong></p>
<p>ApplicationsResource的getContainers接收Client端的拉取请求，在getContainers方法中，首先会根据请求信息构建缓存Key，根据key从缓存中获取数据，并设置到response中返回给Client端。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ApplicationsResource</span> </span>&#123;</span><br><span class="line">    <span class="meta">@GET</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Response <span class="title">getContainers</span><span class="params">(@PathParam(<span class="string">"version"</span>)</span> String version, @<span class="title">HeaderParam</span><span class="params">(<span class="string">"Accept"</span>)</span> String acceptHeader, @<span class="title">HeaderParam</span><span class="params">(<span class="string">"Accept-Encoding"</span>)</span> String acceptEncoding, @<span class="title">HeaderParam</span><span class="params">(<span class="string">"X-Eureka-Accept"</span>)</span> String eurekaAccept, @Context UriInfo uriInfo, @Nullable @<span class="title">QueryParam</span><span class="params">(<span class="string">"regions"</span>)</span> String regionsStr) </span>&#123;</span><br><span class="line">        <span class="keyword">boolean</span> isRemoteRegionRequested = <span class="keyword">null</span> != regionsStr &amp;&amp; !regionsStr.isEmpty();</span><br><span class="line">        String[] regions = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span>(!isRemoteRegionRequested) &#123;</span><br><span class="line">            EurekaMonitors.GET_ALL.increment();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            regions = regionsStr.toLowerCase().split(<span class="string">","</span>);</span><br><span class="line">            Arrays.sort(regions);</span><br><span class="line">            EurekaMonitors.GET_ALL_WITH_REMOTE_REGIONS.increment();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(!<span class="keyword">this</span>.registry.shouldAllowAccess(isRemoteRegionRequested)) &#123;</span><br><span class="line">            <span class="keyword">return</span> Response.status(Status.FORBIDDEN).build();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            CurrentRequestVersion.set(Version.toEnum(version));</span><br><span class="line">            KeyType keyType = KeyType.JSON;</span><br><span class="line">            String returnMediaType = <span class="string">"application/json"</span>;</span><br><span class="line">            <span class="keyword">if</span>(acceptHeader == <span class="keyword">null</span> || !acceptHeader.contains(<span class="string">"json"</span>)) &#123;</span><br><span class="line">                keyType = KeyType.XML;</span><br><span class="line">                returnMediaType = <span class="string">"application/xml"</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 构建缓存key</span></span><br><span class="line">            Key cacheKey = <span class="keyword">new</span> Key(EntityType.Application, <span class="string">"ALL_APPS"</span>, keyType, CurrentRequestVersion.get(), EurekaAccept.fromString(eurekaAccept), regions);</span><br><span class="line">            Response response;</span><br><span class="line">            <span class="comment">// 如果acceptEncoding是gizp</span></span><br><span class="line">            <span class="keyword">if</span>(acceptEncoding != <span class="keyword">null</span> &amp;&amp; acceptEncoding.contains(<span class="string">"gzip"</span>)) &#123;</span><br><span class="line">                response = Response.ok(<span class="keyword">this</span>.responseCache.getGZIP(cacheKey)).header(<span class="string">"Content-Encoding"</span>, <span class="string">"gzip"</span>).header(<span class="string">"Content-Type"</span>, returnMediaType).build();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 从缓存中根据key获取数据设置到response中</span></span><br><span class="line">                response = Response.ok(<span class="keyword">this</span>.responseCache.get(cacheKey)).build();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> response;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>回到ResponseCacheImpl，get方法用来根据key从缓存中获取数据，最终调用的是getValue方法，在getValue方法中可以看到，如果开启了只读缓存，先从readOnlyCacheMap中获取数据，如果未获取到再从readWriteCacheMap中获取，如果未开启只读缓存，直接从readWriteCacheMap中获取，如果readWriteCacheMap不存在某个key，可以回看ResponseCacheImpl构造函数初始化readWriteCacheMap时有一个load方法，不存在某个key时触发该方法，实际上是去registry中取数据并构建缓存数据：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ResponseCacheImpl</span> <span class="keyword">implements</span> <span class="title">ResponseCache</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// 根据keky获取缓存数据</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">get</span><span class="params">(Key key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.get(key, <span class="keyword">this</span>.shouldUseReadOnlyResponseCache);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@VisibleForTesting</span></span><br><span class="line">    <span class="function">String <span class="title">get</span><span class="params">(Key key, <span class="keyword">boolean</span> useReadOnlyCache)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 根据key从缓存map中获取value</span></span><br><span class="line">        ResponseCacheImpl.Value payload = <span class="keyword">this</span>.getValue(key, useReadOnlyCache);</span><br><span class="line">        <span class="keyword">return</span> payload != <span class="keyword">null</span> &amp;&amp; !payload.getPayload().equals(<span class="string">""</span>)?payload.getPayload():<span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">     <span class="meta">@VisibleForTesting</span></span><br><span class="line">    ResponseCacheImpl.<span class="function">Value <span class="title">getValue</span><span class="params">(Key key, <span class="keyword">boolean</span> useReadOnlyCache)</span> </span>&#123;</span><br><span class="line">        ResponseCacheImpl.Value payload = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 如果使用ReadOnlyCache</span></span><br><span class="line">            <span class="keyword">if</span>(useReadOnlyCache) &#123;</span><br><span class="line">                <span class="comment">// 从ReadOnlyCache获取缓存数据</span></span><br><span class="line">                ResponseCacheImpl.Value currentPayload = (ResponseCacheImpl.Value)<span class="keyword">this</span>.readOnlyCacheMap.get(key);</span><br><span class="line">                <span class="comment">// 如果获取不为空</span></span><br><span class="line">                <span class="keyword">if</span>(currentPayload != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    payload = currentPayload;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// 如果获取为空，从readWriteCacheMap中获取数据</span></span><br><span class="line">                    payload = (ResponseCacheImpl.Value)<span class="keyword">this</span>.readWriteCacheMap.get(key);</span><br><span class="line">                    <span class="comment">// 将获取的数据加入readOnlyCacheMap中</span></span><br><span class="line">                    <span class="keyword">this</span>.readOnlyCacheMap.put(key, payload);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 如果不使用readOnlyCacheMap，直接从readWriteCacheMap获取数据</span></span><br><span class="line">                payload = (ResponseCacheImpl.Value)<span class="keyword">this</span>.readWriteCacheMap.get(key);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable var5) &#123;</span><br><span class="line">            logger.error(<span class="string">"Cannot get value for key : &#123;&#125;"</span>, key, var5);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> payload;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="Eureka-Client"><a href="#Eureka-Client" class="headerlink" title="Eureka Client"></a>Eureka Client</h4><p><strong>DiscoveryClient</strong></p>
<p>（1）在DiscoveryClient的构造方法中，会判断是否需要拉取数据，并且初始化定时任务；</p>
<p>（2）初始化定时任务方法中，会添加缓存更新的定时任务，是在CacheRefreshThread的run方法中实现的，在run方法中调用refreshRegistry刷新缓存，在refreshRegistry方法中又调用了fetchRegistry，所以最终使用的fetchRegistry方法从服务端拉取数据；</p>
<p>（3）fetchRegistry方法中会判断是全量还是增量从Server端拉取数据；<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DiscoveryClient</span> <span class="keyword">implements</span> <span class="title">EurekaClient</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">     DiscoveryClient(ApplicationInfoManager applicationInfoManager, EurekaClientConfig config, AbstractDiscoveryClientOptionalArgs args, Provider&lt;BackupRegistry&gt; backupRegistryProvider) &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">// 如果需要拉取数据</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">this</span>.clientConfig.shouldFetchRegistry() &amp;&amp; !<span class="keyword">this</span>.fetchRegistry(<span class="keyword">false</span>)) &#123;</span><br><span class="line">            <span class="comment">// 从备用服务拉取数据</span></span><br><span class="line">            <span class="keyword">this</span>.fetchRegistryFromBackup();</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 初始化定时任务</span></span><br><span class="line">        <span class="keyword">this</span>.initScheduledTasks();</span><br><span class="line">        </span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 初始化定时任务</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initScheduledTasks</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> renewalIntervalInSecs;</span><br><span class="line">        <span class="keyword">int</span> expBackOffBound;</span><br><span class="line">        <span class="comment">// 是否需要拉取数据</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">this</span>.clientConfig.shouldFetchRegistry()) &#123;</span><br><span class="line">            renewalIntervalInSecs = <span class="keyword">this</span>.clientConfig.getRegistryFetchIntervalSeconds();</span><br><span class="line">            expBackOffBound = <span class="keyword">this</span>.clientConfig.getCacheRefreshExecutorExponentialBackOffBound();</span><br><span class="line">            <span class="comment">// 注册刷新缓存的定时任务</span></span><br><span class="line">            <span class="keyword">this</span>.scheduler.schedule(<span class="keyword">new</span> TimedSupervisorTask(<span class="string">"cacheRefresh"</span>, <span class="keyword">this</span>.scheduler, <span class="keyword">this</span>.cacheRefreshExecutor, renewalIntervalInSecs, TimeUnit.SECONDS, expBackOffBound, <span class="keyword">new</span> DiscoveryClient.CacheRefreshThread()), (<span class="keyword">long</span>)renewalIntervalInSecs, TimeUnit.SECONDS);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">this</span>.clientConfig.shouldRegisterWithEureka()) &#123;</span><br><span class="line">            renewalIntervalInSecs = <span class="keyword">this</span>.instanceInfo.getLeaseInfo().getRenewalIntervalInSecs();</span><br><span class="line">            expBackOffBound = <span class="keyword">this</span>.clientConfig.getHeartbeatExecutorExponentialBackOffBound();</span><br><span class="line">            logger.info(<span class="string">"Starting heartbeat executor: renew interval is: &#123;&#125;"</span>, Integer.valueOf(renewalIntervalInSecs));</span><br><span class="line">            <span class="comment">// 注册发送心跳的定时任务</span></span><br><span class="line">            <span class="keyword">this</span>.scheduler.schedule(<span class="keyword">new</span> TimedSupervisorTask(<span class="string">"heartbeat"</span>, <span class="keyword">this</span>.scheduler, <span class="keyword">this</span>.heartbeatExecutor, renewalIntervalInSecs, TimeUnit.SECONDS, expBackOffBound, <span class="keyword">new</span> DiscoveryClient.HeartbeatThread(<span class="keyword">null</span>)), (<span class="keyword">long</span>)renewalIntervalInSecs, TimeUnit.SECONDS);</span><br><span class="line">            <span class="comment">// 构建InstanceInfoReplicator，其run方法中会调用discoveryClient.register()发送HTTP请求进行服务注册</span></span><br><span class="line">            <span class="keyword">this</span>.instanceInfoReplicator = <span class="keyword">new</span> InstanceInfoReplicator(<span class="keyword">this</span>, <span class="keyword">this</span>.instanceInfo, <span class="keyword">this</span>.clientConfig.getInstanceInfoReplicationIntervalSeconds(), <span class="number">2</span>);</span><br><span class="line">            <span class="keyword">this</span>.statusChangeListener = <span class="keyword">new</span> StatusChangeListener() &#123;</span><br><span class="line">                <span class="function"><span class="keyword">public</span> String <span class="title">getId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="string">"statusChangeListener"</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">notify</span><span class="params">(StatusChangeEvent statusChangeEvent)</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">if</span>(InstanceStatus.DOWN != statusChangeEvent.getStatus() &amp;&amp; InstanceStatus.DOWN != statusChangeEvent.getPreviousStatus()) &#123;</span><br><span class="line">                        DiscoveryClient.logger.info(<span class="string">"Saw local status change event &#123;&#125;"</span>, statusChangeEvent);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        DiscoveryClient.logger.warn(<span class="string">"Saw local status change event &#123;&#125;"</span>, statusChangeEvent);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    DiscoveryClient.<span class="keyword">this</span>.instanceInfoReplicator.onDemandUpdate();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="keyword">if</span>(<span class="keyword">this</span>.clientConfig.shouldOnDemandUpdateStatusChange()) &#123;</span><br><span class="line">                <span class="keyword">this</span>.applicationInfoManager.registerStatusChangeListener(<span class="keyword">this</span>.statusChangeListener);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">this</span>.instanceInfoReplicator.start(<span class="keyword">this</span>.clientConfig.getInitialInstanceInfoReplicationIntervalSeconds());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            logger.info(<span class="string">"Not registering with Eureka server per configuration"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 缓存刷新任务</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">CacheRefreshThread</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">        CacheRefreshThread() &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="comment">// 调用refreshRegistry刷新缓存</span></span><br><span class="line">            DiscoveryClient.<span class="keyword">this</span>.refreshRegistry();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@VisibleForTesting</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">refreshRegistry</span><span class="params">()</span> </span>&#123; </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ...</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 调用fetchRegistry从服务端拉取数据</span></span><br><span class="line">            <span class="keyword">boolean</span> success = <span class="keyword">this</span>.fetchRegistry(remoteRegionsModified);</span><br><span class="line">            <span class="keyword">if</span>(success) &#123;</span><br><span class="line">                <span class="keyword">this</span>.registrySize = ((Applications)<span class="keyword">this</span>.localRegionApps.get()).size();</span><br><span class="line">                <span class="keyword">this</span>.lastSuccessfulRegistryFetchTimestamp = System.currentTimeMillis();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ...</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable var9) &#123;</span><br><span class="line">            logger.error(<span class="string">"Cannot fetch registry from server"</span>, var9);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 拉取数据</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">fetchRegistry</span><span class="params">(<span class="keyword">boolean</span> forceFullRegistryFetch)</span> </span>&#123;</span><br><span class="line">        Stopwatch tracer = <span class="keyword">this</span>.FETCH_REGISTRY_TIMER.start();</span><br><span class="line"></span><br><span class="line">        label122: &#123;</span><br><span class="line">            <span class="keyword">boolean</span> var4;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Applications applications = <span class="keyword">this</span>.getApplications();</span><br><span class="line">                <span class="keyword">if</span>(!<span class="keyword">this</span>.clientConfig.shouldDisableDelta() &amp;&amp; Strings.isNullOrEmpty(<span class="keyword">this</span>.clientConfig.getRegistryRefreshSingleVipAddress()) &amp;&amp; !forceFullRegistryFetch &amp;&amp; applications != <span class="keyword">null</span> &amp;&amp; applications.getRegisteredApplications().size() != <span class="number">0</span> &amp;&amp; applications.getVersion().longValue() != -<span class="number">1L</span>) &#123;</span><br><span class="line">                    <span class="comment">// 增量拉取数据</span></span><br><span class="line">                    <span class="keyword">this</span>.getAndUpdateDelta(applications);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    logger.info(<span class="string">"Disable delta property : &#123;&#125;"</span>, Boolean.valueOf(<span class="keyword">this</span>.clientConfig.shouldDisableDelta()));</span><br><span class="line">                    logger.info(<span class="string">"Single vip registry refresh property : &#123;&#125;"</span>, <span class="keyword">this</span>.clientConfig.getRegistryRefreshSingleVipAddress());</span><br><span class="line">                    logger.info(<span class="string">"Force full registry fetch : &#123;&#125;"</span>, Boolean.valueOf(forceFullRegistryFetch));</span><br><span class="line">                    logger.info(<span class="string">"Application is null : &#123;&#125;"</span>, Boolean.valueOf(applications == <span class="keyword">null</span>));</span><br><span class="line">                    logger.info(<span class="string">"Registered Applications size is zero : &#123;&#125;"</span>, Boolean.valueOf(applications.getRegisteredApplications().size() == <span class="number">0</span>));</span><br><span class="line">                    logger.info(<span class="string">"Application version is -1: &#123;&#125;"</span>, Boolean.valueOf(applications.getVersion().longValue() == -<span class="number">1L</span>));</span><br><span class="line">                    <span class="comment">// 全量拉取数据</span></span><br><span class="line">                    <span class="keyword">this</span>.getAndStoreFullRegistry();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                applications.setAppsHashCode(applications.getReconcileHashCode());</span><br><span class="line">                <span class="keyword">this</span>.logTotalInstances();</span><br><span class="line">                <span class="keyword">break</span> label122;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable var8) &#123;</span><br><span class="line">                logger.error(<span class="string">"DiscoveryClient_&#123;&#125; - was unable to refresh its cache! status = &#123;&#125;"</span>, <span class="keyword">new</span> Object[]&#123;<span class="keyword">this</span>.appPathIdentifier, var8.getMessage(), var8&#125;);</span><br><span class="line">                var4 = <span class="keyword">false</span>;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="keyword">if</span>(tracer != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    tracer.stop();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> var4;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 缓存刷新事件</span></span><br><span class="line">        <span class="keyword">this</span>.onCacheRefreshed();</span><br><span class="line">        <span class="keyword">this</span>.updateInstanceRemoteStatus();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>参考：</strong></p>
<p><a href="https://blog.csdn.net/u012394095/article/details/80894140" target="_blank" rel="noopener">sharedCode:深入理解Eureka缓存机制（八）</a></p>
<p>[xmz_java:Eureka 缓存结构以及服务感知优化](<a href="https://www.cnblogs.com/xmzJava/p/11359636.html）" target="_blank" rel="noopener">https://www.cnblogs.com/xmzJava/p/11359636.html）</a></p>
<p>[宜信技术:详解Eureka 缓存机制](<a href="https://www.cnblogs.com/yixinjishu/p/10871243.html）" target="_blank" rel="noopener">https://www.cnblogs.com/yixinjishu/p/10871243.html）</a></p>
<p><strong>Spring Cloud版本：Finchley.RELEASE</strong></p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2020/02/09/【MySQL】更新语句执行流程/" rel="next" title="【MySQL】更新语句执行流程">
                <i class="fa fa-chevron-left"></i> 【MySQL】更新语句执行流程
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2020/05/03/【MySQL】MVVC机制/" rel="prev" title="【MySQL】MVVC机制">
                【MySQL】MVVC机制 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">shan</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">33</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                
                  <span class="site-state-item-count">10</span>
                  <span class="site-state-item-name">tags</span>
                
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-5"><a class="nav-link" href="#1-registry"><span class="nav-number">1.</span> <span class="nav-text">1.registry</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-readWriteCacheMap"><span class="nav-number">2.</span> <span class="nav-text">2.readWriteCacheMap</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-readOnlyCacheMap"><span class="nav-number">3.</span> <span class="nav-text">3.readOnlyCacheMap</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#源码"><span class="nav-number"></span> <span class="nav-text">源码</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Eureka-Server"><span class="nav-number"></span> <span class="nav-text">Eureka Server</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Eureka-Client"><span class="nav-number"></span> <span class="nav-text">Eureka Client</span></a></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">shan</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
