<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta property="og:type" content="website">
<meta property="og:title" content="SHAN">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="SHAN">
<meta property="og:locale" content="default">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="SHAN">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/"/>





  <title>SHAN</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="default">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">SHAN</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/03/20/【RokectMQ】Broker服务注册/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="shan">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="SHAN">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/03/20/【RokectMQ】Broker服务注册/" itemprop="url">【RocketMQ】Broker服务注册</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2021-03-20T21:00:00+08:00">
                2021-03-20
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Broker服务注册"><a href="#Broker服务注册" class="headerlink" title="Broker服务注册"></a>Broker服务注册</h2><h3 id="BrokerOuterAPI"><a href="#BrokerOuterAPI" class="headerlink" title="BrokerOuterAPI"></a>BrokerOuterAPI</h3><h4 id="服务注册"><a href="#服务注册" class="headerlink" title="服务注册"></a>服务注册</h4><p>Broker服务注册的详细代码在BrokerOuterAPI的registerBrokerAll方法中：</p>
<p>1.构建Request请求头和请求体，并设置相关的参数；</p>
<p>2.因为Broker会向所有的NameServer注册，所以构建CountDownLatch，用来等待向所有的NameServer注册的任务都执行完毕；</p>
<p>3.使用线程池执行向每一个NameServer注册的任务，底层是通过Netty Client向NameServer发送注册请求的；</p>
<p>4.将注册结果放入结果集中，等待所有NameServer执行完毕返回结果列表；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 注册的详细代码</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> List&lt;RegisterBrokerResult&gt; <span class="title">registerBrokerAll</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">       <span class="keyword">final</span> String clusterName,</span></span></span><br><span class="line"><span class="function"><span class="params">       <span class="keyword">final</span> String brokerAddr,</span></span></span><br><span class="line"><span class="function"><span class="params">       <span class="keyword">final</span> String brokerName,</span></span></span><br><span class="line"><span class="function"><span class="params">       <span class="keyword">final</span> <span class="keyword">long</span> brokerId,</span></span></span><br><span class="line"><span class="function"><span class="params">       <span class="keyword">final</span> String haServerAddr,</span></span></span><br><span class="line"><span class="function"><span class="params">       <span class="keyword">final</span> TopicConfigSerializeWrapper topicConfigWrapper,</span></span></span><br><span class="line"><span class="function"><span class="params">       <span class="keyword">final</span> List&lt;String&gt; filterServerList,</span></span></span><br><span class="line"><span class="function"><span class="params">       <span class="keyword">final</span> <span class="keyword">boolean</span> oneway,</span></span></span><br><span class="line"><span class="function"><span class="params">       <span class="keyword">final</span> <span class="keyword">int</span> timeoutMills,</span></span></span><br><span class="line"><span class="function"><span class="params">       <span class="keyword">final</span> <span class="keyword">boolean</span> compressed)</span> </span>&#123;</span><br><span class="line">       <span class="comment">// 创建一个列表保存注册结果</span></span><br><span class="line">       <span class="keyword">final</span> List&lt;RegisterBrokerResult&gt; registerBrokerResultList = Lists.newArrayList();</span><br><span class="line">       <span class="comment">// 获取NameServer地址列表</span></span><br><span class="line">       List&lt;String&gt; nameServerAddressList = <span class="keyword">this</span>.remotingClient.getNameServerAddressList();</span><br><span class="line">       <span class="keyword">if</span> (nameServerAddressList != <span class="keyword">null</span> &amp;&amp; nameServerAddressList.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">           <span class="comment">// 构建Request请求头</span></span><br><span class="line">           <span class="keyword">final</span> RegisterBrokerRequestHeader requestHeader = <span class="keyword">new</span> RegisterBrokerRequestHeader();</span><br><span class="line">           <span class="comment">// 设置broker地址</span></span><br><span class="line">           requestHeader.setBrokerAddr(brokerAddr);</span><br><span class="line">           <span class="comment">// 设置broker id</span></span><br><span class="line">           requestHeader.setBrokerId(brokerId);</span><br><span class="line">           <span class="comment">// 设置broker name</span></span><br><span class="line">           requestHeader.setBrokerName(brokerName);</span><br><span class="line">           <span class="comment">// 设置集群名称</span></span><br><span class="line">           requestHeader.setClusterName(clusterName);</span><br><span class="line">           requestHeader.setHaServerAddr(haServerAddr);</span><br><span class="line">           requestHeader.setCompressed(compressed);</span><br><span class="line">           <span class="comment">// 创建请求体</span></span><br><span class="line">           RegisterBrokerBody requestBody = <span class="keyword">new</span> RegisterBrokerBody();</span><br><span class="line">           requestBody.setTopicConfigSerializeWrapper(topicConfigWrapper);</span><br><span class="line">           requestBody.setFilterServerList(filterServerList);</span><br><span class="line">           <span class="keyword">final</span> <span class="keyword">byte</span>[] body = requestBody.encode(compressed);</span><br><span class="line">           <span class="keyword">final</span> <span class="keyword">int</span> bodyCrc32 = UtilAll.crc32(body);</span><br><span class="line">           requestHeader.setBodyCrc32(bodyCrc32);</span><br><span class="line">           <span class="comment">// 构建了一个CountDownLatch</span></span><br><span class="line">           <span class="keyword">final</span> CountDownLatch countDownLatch = <span class="keyword">new</span> CountDownLatch(nameServerAddressList.size());</span><br><span class="line">           <span class="keyword">for</span> (<span class="keyword">final</span> String namesrvAddr : nameServerAddressList) &#123;</span><br><span class="line">               <span class="comment">// 使用线程池执行注册任务</span></span><br><span class="line">               brokerOuterExecutor.execute(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                   <span class="meta">@Override</span></span><br><span class="line">                   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                       <span class="keyword">try</span> &#123;</span><br><span class="line">                           <span class="comment">// 向NameServer注册</span></span><br><span class="line">                           RegisterBrokerResult result = registerBroker(namesrvAddr,oneway, timeoutMills,requestHeader,body);</span><br><span class="line">                           <span class="keyword">if</span> (result != <span class="keyword">null</span>) &#123;</span><br><span class="line">                               <span class="comment">// 添加注册结果</span></span><br><span class="line">                               registerBrokerResultList.add(result);</span><br><span class="line">                           &#125;</span><br><span class="line"></span><br><span class="line">                           log.info(<span class="string">"register broker[&#123;&#125;]to name server &#123;&#125; OK"</span>, brokerId, namesrvAddr);</span><br><span class="line">                       &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                           log.warn(<span class="string">"registerBroker Exception, &#123;&#125;"</span>, namesrvAddr, e);</span><br><span class="line">                       &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                           countDownLatch.countDown();</span><br><span class="line">                       &#125;</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;);</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="keyword">try</span> &#123;</span><br><span class="line">               <span class="comment">// 等待Broker对所有的NameServer注册完毕</span></span><br><span class="line">               countDownLatch.await(timeoutMills, TimeUnit.MILLISECONDS);</span><br><span class="line">           &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">return</span> registerBrokerResultList;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<h4 id="服务注册请求的发送"><a href="#服务注册请求的发送" class="headerlink" title="服务注册请求的发送"></a>服务注册请求的发送</h4><p>进入到registerBroker看一下服务注册请求发送的详细代码，可以看到底层是使用Netty Client进行请求发送的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> RegisterBrokerResult <span class="title">registerBroker</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">     <span class="keyword">final</span> String namesrvAddr,</span></span></span><br><span class="line"><span class="function"><span class="params">     <span class="keyword">final</span> <span class="keyword">boolean</span> oneway,</span></span></span><br><span class="line"><span class="function"><span class="params">     <span class="keyword">final</span> <span class="keyword">int</span> timeoutMills,</span></span></span><br><span class="line"><span class="function"><span class="params">     <span class="keyword">final</span> RegisterBrokerRequestHeader requestHeader,</span></span></span><br><span class="line"><span class="function"><span class="params">     <span class="keyword">final</span> <span class="keyword">byte</span>[] body</span></span></span><br><span class="line"><span class="function"><span class="params"> )</span> <span class="keyword">throws</span> RemotingCommandException, MQBrokerException, RemotingConnectException, RemotingSendRequestException, RemotingTimeoutException,</span></span><br><span class="line"><span class="function">     InterruptedException </span>&#123;</span><br><span class="line">     <span class="comment">// 创建RemotingCommand，封装请求头和请求体</span></span><br><span class="line">     RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.REGISTER_BROKER, requestHeader);</span><br><span class="line">     <span class="comment">// 设置请求体</span></span><br><span class="line">     request.setBody(body);</span><br><span class="line">     <span class="comment">// 先不管</span></span><br><span class="line">     <span class="keyword">if</span> (oneway) &#123;</span><br><span class="line">         <span class="keyword">try</span> &#123;</span><br><span class="line">             <span class="keyword">this</span>.remotingClient.invokeOneway(namesrvAddr, request, timeoutMills);</span><br><span class="line">         &#125; <span class="keyword">catch</span> (RemotingTooMuchRequestException e) &#123;</span><br><span class="line">             <span class="comment">// Ignore</span></span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="comment">// 使用Netty Client发送网络请求</span></span><br><span class="line">     RemotingCommand response = <span class="keyword">this</span>.remotingClient.invokeSync(namesrvAddr, request, timeoutMills);</span><br><span class="line">     <span class="keyword">assert</span> response != <span class="keyword">null</span>;</span><br><span class="line">     <span class="comment">// 处理请求响应结果</span></span><br><span class="line">     <span class="keyword">switch</span> (response.getCode()) &#123;</span><br><span class="line">         <span class="keyword">case</span> ResponseCode.SUCCESS: &#123;</span><br><span class="line">             RegisterBrokerResponseHeader responseHeader =</span><br><span class="line">                 (RegisterBrokerResponseHeader) response.decodeCommandCustomHeader(RegisterBrokerResponseHeader.class);</span><br><span class="line">             RegisterBrokerResult result = <span class="keyword">new</span> RegisterBrokerResult();</span><br><span class="line">             result.setMasterAddr(responseHeader.getMasterAddr());</span><br><span class="line">             result.setHaServerAddr(responseHeader.getHaServerAddr());</span><br><span class="line">             <span class="keyword">if</span> (response.getBody() != <span class="keyword">null</span>) &#123;</span><br><span class="line">                 result.setKvTable(KVTable.decode(response.getBody(), KVTable.class));</span><br><span class="line">             &#125;</span><br><span class="line">             <span class="keyword">return</span> result;</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">default</span>:</span><br><span class="line">             <span class="keyword">break</span>;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">throw</span> <span class="keyword">new</span> MQBrokerException(response.getCode(), response.getRemark());</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<h5 id="NettyRemotingClient"><a href="#NettyRemotingClient" class="headerlink" title="NettyRemotingClient"></a>NettyRemotingClient</h5><p>进入NettyRemotingClient中的invokeSync方法，看下详细的发送过程：</p>
<p>1.获取一个Channel，也就是获取和NameServer的一个连接，在获取Channel的时候首先会从缓存中获取Channel，如果没有获取到才会创建新的Channel；</p>
<p>2.调用invokeSyncImpl方法，通过Channel向NameServer发送请求；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">  <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RemotingCommand <span class="title">invokeSync</span><span class="params">(String addr, <span class="keyword">final</span> RemotingCommand request, <span class="keyword">long</span> timeoutMillis)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> InterruptedException, RemotingConnectException, RemotingSendRequestException, RemotingTimeoutException </span>&#123;</span><br><span class="line">        <span class="comment">// 获取当前时间</span></span><br><span class="line">        <span class="keyword">long</span> beginStartTime = System.currentTimeMillis();</span><br><span class="line">        <span class="comment">// 获取Channel,也就是获取了一个和NameServer的一个连接</span></span><br><span class="line">        <span class="keyword">final</span> Channel channel = <span class="keyword">this</span>.getAndCreateChannel(addr);</span><br><span class="line">        <span class="keyword">if</span> (channel != <span class="keyword">null</span> &amp;&amp; channel.isActive()) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                doBeforeRpcHooks(addr, request);</span><br><span class="line">                <span class="keyword">long</span> costTime = System.currentTimeMillis() - beginStartTime;</span><br><span class="line">                <span class="keyword">if</span> (timeoutMillis &lt; costTime) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> RemotingTimeoutException(<span class="string">"invokeSync call timeout"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 真正发送请求的地方</span></span><br><span class="line">                RemotingCommand response = <span class="keyword">this</span>.invokeSyncImpl(channel, request, timeoutMillis - costTime);</span><br><span class="line">                doAfterRpcHooks(RemotingHelper.parseChannelRemoteAddr(channel), request, response);</span><br><span class="line">                <span class="keyword">return</span> response;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (RemotingSendRequestException e) &#123;</span><br><span class="line">                log.warn(<span class="string">"invokeSync: send request exception, so close the channel[&#123;&#125;]"</span>, addr);</span><br><span class="line">                <span class="keyword">this</span>.closeChannel(addr, channel);</span><br><span class="line">                <span class="keyword">throw</span> e;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (RemotingTimeoutException e) &#123;</span><br><span class="line">                <span class="keyword">if</span> (nettyClientConfig.isClientCloseSocketIfTimeout()) &#123;</span><br><span class="line">                    <span class="keyword">this</span>.closeChannel(addr, channel);</span><br><span class="line">                    log.warn(<span class="string">"invokeSync: close socket because of timeout, &#123;&#125;ms, &#123;&#125;"</span>, timeoutMillis, addr);</span><br><span class="line">                &#125;</span><br><span class="line">                log.warn(<span class="string">"invokeSync: wait response timeout exception, the channel[&#123;&#125;]"</span>, addr);</span><br><span class="line">                <span class="keyword">throw</span> e;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.closeChannel(addr, channel);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RemotingConnectException(addr);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// 获取Channel</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Channel <span class="title">getAndCreateChannel</span><span class="params">(<span class="keyword">final</span> String addr)</span> <span class="keyword">throws</span> RemotingConnectException, InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == addr) &#123;</span><br><span class="line">            <span class="comment">// 获取Channel</span></span><br><span class="line">            <span class="keyword">return</span> getAndCreateNameserverChannel();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 从缓存中获取channel</span></span><br><span class="line">        ChannelWrapper cw = <span class="keyword">this</span>.channelTables.get(addr);</span><br><span class="line">        <span class="keyword">if</span> (cw != <span class="keyword">null</span> &amp;&amp; cw.isOK()) &#123;</span><br><span class="line">            <span class="keyword">return</span> cw.getChannel();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 创建channel</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.createChannel(addr);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>创建Channel的代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建Channel</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Channel <span class="title">createChannel</span><span class="params">(<span class="keyword">final</span> String addr)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="comment">// 先从缓存中获取连接</span></span><br><span class="line">        ChannelWrapper cw = <span class="keyword">this</span>.channelTables.get(addr);</span><br><span class="line">        <span class="keyword">if</span> (cw != <span class="keyword">null</span> &amp;&amp; cw.isOK()) &#123;</span><br><span class="line">            <span class="keyword">return</span> cw.getChannel();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 加锁</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.lockChannelTables.tryLock(LOCK_TIMEOUT_MILLIS, TimeUnit.MILLISECONDS)) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 同样是从缓存中获取连接</span></span><br><span class="line">                <span class="keyword">boolean</span> createNewConnection;</span><br><span class="line">                cw = <span class="keyword">this</span>.channelTables.get(addr);</span><br><span class="line">                <span class="keyword">if</span> (cw != <span class="keyword">null</span>) &#123;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (cw.isOK()) &#123;</span><br><span class="line">                        <span class="keyword">return</span> cw.getChannel();</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!cw.getChannelFuture().isDone()) &#123;</span><br><span class="line">                        createNewConnection = <span class="keyword">false</span>;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="keyword">this</span>.channelTables.remove(addr);</span><br><span class="line">                        createNewConnection = <span class="keyword">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    createNewConnection = <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (createNewConnection) &#123;</span><br><span class="line">                    <span class="comment">// 创建连接的地方</span></span><br><span class="line">                    ChannelFuture channelFuture = <span class="keyword">this</span>.bootstrap.connect(RemotingHelper.string2SocketAddress(addr));</span><br><span class="line">                    log.info(<span class="string">"createChannel: begin to connect remote host[&#123;&#125;] asynchronously"</span>, addr);</span><br><span class="line">                    cw = <span class="keyword">new</span> ChannelWrapper(channelFuture);</span><br><span class="line">                    <span class="comment">// 将连接放入缓存</span></span><br><span class="line">                    <span class="keyword">this</span>.channelTables.put(addr, cw);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                log.error(<span class="string">"createChannel: create channel exception"</span>, e);</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="keyword">this</span>.lockChannelTables.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            log.warn(<span class="string">"createChannel: try to lock channel table, but timeout, &#123;&#125;ms"</span>, LOCK_TIMEOUT_MILLIS);</span><br><span class="line">        &#125;</span><br><span class="line">      <span class="comment">// 先不管</span></span><br><span class="line">        <span class="keyword">if</span> (cw != <span class="keyword">null</span>) &#123;</span><br><span class="line">            ChannelFuture channelFuture = cw.getChannelFuture();</span><br><span class="line">            <span class="keyword">if</span> (channelFuture.awaitUninterruptibly(<span class="keyword">this</span>.nettyClientConfig.getConnectTimeoutMillis())) &#123;</span><br><span class="line">                <span class="keyword">if</span> (cw.isOK()) &#123;</span><br><span class="line">                    log.info(<span class="string">"createChannel: connect remote host[&#123;&#125;] success, &#123;&#125;"</span>, addr, channelFuture.toString());</span><br><span class="line">                    <span class="keyword">return</span> cw.getChannel();</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    log.warn(<span class="string">"createChannel: connect remote host["</span> + addr + <span class="string">"] failed, "</span> + channelFuture.toString(), channelFuture.cause());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                log.warn(<span class="string">"createChannel: connect remote host[&#123;&#125;] timeout &#123;&#125;ms, &#123;&#125;"</span>, addr, <span class="keyword">this</span>.nettyClientConfig.getConnectTimeoutMillis(),</span><br><span class="line">                    channelFuture.toString());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>发送网络请求的代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 发送网络请求的代码</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> RemotingCommand <span class="title">invokeSyncImpl</span><span class="params">(<span class="keyword">final</span> Channel channel, <span class="keyword">final</span> RemotingCommand request,</span></span></span><br><span class="line"><span class="function"><span class="params">       <span class="keyword">final</span> <span class="keyword">long</span> timeoutMillis)</span></span></span><br><span class="line"><span class="function">       <span class="keyword">throws</span> InterruptedException, RemotingSendRequestException, RemotingTimeoutException </span>&#123;</span><br><span class="line">       <span class="keyword">final</span> <span class="keyword">int</span> opaque = request.getOpaque();</span><br><span class="line"></span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           <span class="keyword">final</span> ResponseFuture responseFuture = <span class="keyword">new</span> ResponseFuture(channel, opaque, timeoutMillis, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">           <span class="keyword">this</span>.responseTable.put(opaque, responseFuture);</span><br><span class="line">           <span class="keyword">final</span> SocketAddress addr = channel.remoteAddress();</span><br><span class="line">           channel.writeAndFlush(request).addListener(<span class="keyword">new</span> ChannelFutureListener() &#123;</span><br><span class="line">               <span class="meta">@Override</span></span><br><span class="line">               <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">operationComplete</span><span class="params">(ChannelFuture f)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                   <span class="keyword">if</span> (f.isSuccess()) &#123;</span><br><span class="line">                       responseFuture.setSendRequestOK(<span class="keyword">true</span>);</span><br><span class="line">                       <span class="keyword">return</span>;</span><br><span class="line">                   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                       responseFuture.setSendRequestOK(<span class="keyword">false</span>);</span><br><span class="line">                   &#125;</span><br><span class="line"></span><br><span class="line">                   responseTable.remove(opaque);</span><br><span class="line">                   responseFuture.setCause(f.cause());</span><br><span class="line">                   responseFuture.putResponse(<span class="keyword">null</span>);</span><br><span class="line">                   log.warn(<span class="string">"send a request command to channel &lt;"</span> + addr + <span class="string">"&gt; failed."</span>);</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;);</span><br><span class="line"></span><br><span class="line">           RemotingCommand responseCommand = responseFuture.waitResponse(timeoutMillis);</span><br><span class="line">           <span class="keyword">if</span> (<span class="keyword">null</span> == responseCommand) &#123;</span><br><span class="line">               <span class="keyword">if</span> (responseFuture.isSendRequestOK()) &#123;</span><br><span class="line">                   <span class="keyword">throw</span> <span class="keyword">new</span> RemotingTimeoutException(RemotingHelper.parseSocketAddressAddr(addr), timeoutMillis,</span><br><span class="line">                       responseFuture.getCause());</span><br><span class="line">               &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                   <span class="keyword">throw</span> <span class="keyword">new</span> RemotingSendRequestException(RemotingHelper.parseSocketAddressAddr(addr), responseFuture.getCause());</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="keyword">return</span> responseCommand;</span><br><span class="line">       &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">           <span class="keyword">this</span>.responseTable.remove(opaque);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<h3 id="心跳机制"><a href="#心跳机制" class="headerlink" title="心跳机制"></a>心跳机制</h3><p>为了让NameServer感知到Broker是否有异常，Broker会定时发送心跳到NameServer，告诉NameServer自己的服务正常。</p>
<h4 id="BrokerController"><a href="#BrokerController" class="headerlink" title="BrokerController"></a>BrokerController</h4><p>回到start方法中，可以看到注册了一个定时任务，定时会向NameServer进行注册，默认每30s进行一次注册：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// 定时向NameServer注册</span></span><br><span class="line">    <span class="keyword">this</span>.scheduledExecutorService.scheduleAtFixedRate(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// 向NameServer注册</span></span><br><span class="line">                    BrokerController.<span class="keyword">this</span>.registerBrokerAll(<span class="keyword">true</span>, <span class="keyword">false</span>, brokerConfig.isForceRegister());</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                    log.error(<span class="string">"registerBrokerAll Exception"</span>, e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,  <span class="number">1000</span> * <span class="number">10</span>, Math.max(<span class="number">10000</span>, Math.min(brokerConfig.getRegisterNameServerPeriod(), <span class="number">60000</span>)), TimeUnit.MILLISECONDS);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>图片</p>
<h2 id="NameServer注册处理"><a href="#NameServer注册处理" class="headerlink" title="NameServer注册处理"></a>NameServer注册处理</h2><h3 id="Broker的注册请求处理"><a href="#Broker的注册请求处理" class="headerlink" title="Broker的注册请求处理"></a>Broker的注册请求处理</h3><h4 id="NamesrvController"><a href="#NamesrvController" class="headerlink" title="NamesrvController"></a>NamesrvController</h4><p>回到NamesrvController的initialize方法中，有一个注册处理器的方法registerProcessor：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">initialize</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// 注册请求处理器</span></span><br><span class="line">    <span class="keyword">this</span>.registerProcessor();</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">registerProcessor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 是否是集群测试</span></span><br><span class="line">    <span class="keyword">if</span> (namesrvConfig.isClusterTest()) &#123;</span><br><span class="line">        <span class="keyword">this</span>.remotingServer.registerDefaultProcessor(<span class="keyword">new</span> ClusterTestRequestProcessor(<span class="keyword">this</span>, namesrvConfig.getProductEnvName()),</span><br><span class="line">        <span class="keyword">this</span>.remotingExecutor);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">         <span class="comment">// 注册默认的处理器,创建了一个DefaultRequestProcessor</span></span><br><span class="line">        <span class="keyword">this</span>.remotingServer.registerDefaultProcessor(<span class="keyword">new</span> DefaultRequestProcessor(<span class="keyword">this</span>), <span class="keyword">this</span>.remotingExecutor);</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<h4 id="DefaultRequestProcessor"><a href="#DefaultRequestProcessor" class="headerlink" title="DefaultRequestProcessor"></a>DefaultRequestProcessor</h4><p>DefaultRequestProcessor的processRequest对请求进行处理，会判断请求类型，然后处理对应的请求，找到Broker的注册类型，可以看到调用registerBroker方法对Broker的请求进行处理，最终是调用RouteInfoManager的registerBroker进行注册的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultRequestProcessor</span></span>&#123;</span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RemotingCommand <span class="title">processRequest</span><span class="params">(ChannelHandlerContext ctx,</span></span></span><br><span class="line"><span class="function"><span class="params">        RemotingCommand request)</span> <span class="keyword">throws</span> RemotingCommandException </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ctx != <span class="keyword">null</span>) &#123;</span><br><span class="line">            log.debug(<span class="string">"receive request, &#123;&#125; &#123;&#125; &#123;&#125;"</span>,</span><br><span class="line">                request.getCode(),</span><br><span class="line">                RemotingHelper.parseChannelRemoteAddr(ctx.channel()),</span><br><span class="line">                request);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 判断请求类型，处理不同的请求</span></span><br><span class="line">        <span class="keyword">switch</span> (request.getCode()) &#123;</span><br><span class="line">            <span class="keyword">case</span> RequestCode.PUT_KV_CONFIG:</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">this</span>.putKVConfig(ctx, request);</span><br><span class="line">            <span class="keyword">case</span> RequestCode.GET_KV_CONFIG:</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">this</span>.getKVConfig(ctx, request);</span><br><span class="line">            <span class="keyword">case</span> RequestCode.DELETE_KV_CONFIG:</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">this</span>.deleteKVConfig(ctx, request);</span><br><span class="line">            <span class="keyword">case</span> RequestCode.QUERY_DATA_VERSION:</span><br><span class="line">                <span class="keyword">return</span> queryBrokerTopicConfig(ctx, request);</span><br><span class="line">            <span class="keyword">case</span> RequestCode.REGISTER_BROKER: <span class="comment">// 如果是Broker的注册请求</span></span><br><span class="line">                Version brokerVersion = MQVersion.value2Version(request.getVersion());</span><br><span class="line">                <span class="comment">// 版本判断</span></span><br><span class="line">                <span class="keyword">if</span> (brokerVersion.ordinal() &gt;= MQVersion.Version.V3_0_11.ordinal()) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">this</span>.registerBrokerWithFilterServer(ctx, request);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// Broker注册</span></span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">this</span>.registerBroker(ctx, request);</span><br><span class="line">                &#125;</span><br><span class="line">            <span class="keyword">case</span> RequestCode.UNREGISTER_BROKER:</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">this</span>.unregisterBroker(ctx, request);</span><br><span class="line">            <span class="keyword">case</span> RequestCode.GET_ROUTEINFO_BY_TOPIC:</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">this</span>.getRouteInfoByTopic(ctx, request);</span><br><span class="line">            <span class="keyword">case</span> RequestCode.GET_BROKER_CLUSTER_INFO:</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">this</span>.getBrokerClusterInfo(ctx, request);</span><br><span class="line">            <span class="keyword">case</span> RequestCode.WIPE_WRITE_PERM_OF_BROKER:</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">this</span>.wipeWritePermOfBroker(ctx, request);</span><br><span class="line">            <span class="keyword">case</span> RequestCode.GET_ALL_TOPIC_LIST_FROM_NAMESERVER:</span><br><span class="line">                <span class="keyword">return</span> getAllTopicListFromNameserver(ctx, request);</span><br><span class="line">            <span class="keyword">case</span> RequestCode.DELETE_TOPIC_IN_NAMESRV:</span><br><span class="line">                <span class="keyword">return</span> deleteTopicInNamesrv(ctx, request);</span><br><span class="line">            <span class="keyword">case</span> RequestCode.GET_KVLIST_BY_NAMESPACE:</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">this</span>.getKVListByNamespace(ctx, request);</span><br><span class="line">            <span class="keyword">case</span> RequestCode.GET_TOPICS_BY_CLUSTER:</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">this</span>.getTopicsByCluster(ctx, request);</span><br><span class="line">            <span class="keyword">case</span> RequestCode.GET_SYSTEM_TOPIC_LIST_FROM_NS:</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">this</span>.getSystemTopicListFromNs(ctx, request);</span><br><span class="line">            <span class="keyword">case</span> RequestCode.GET_UNIT_TOPIC_LIST:</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">this</span>.getUnitTopicList(ctx, request);</span><br><span class="line">            <span class="keyword">case</span> RequestCode.GET_HAS_UNIT_SUB_TOPIC_LIST:</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">this</span>.getHasUnitSubTopicList(ctx, request);</span><br><span class="line">            <span class="keyword">case</span> RequestCode.GET_HAS_UNIT_SUB_UNUNIT_TOPIC_LIST:</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">this</span>.getHasUnitSubUnUnitTopicList(ctx, request);</span><br><span class="line">            <span class="keyword">case</span> RequestCode.UPDATE_NAMESRV_CONFIG:</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">this</span>.updateConfig(ctx, request);</span><br><span class="line">            <span class="keyword">case</span> RequestCode.GET_NAMESRV_CONFIG:</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">this</span>.getConfig(ctx, request);</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Broker的注册</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RemotingCommand <span class="title">registerBroker</span><span class="params">(ChannelHandlerContext ctx,</span></span></span><br><span class="line"><span class="function"><span class="params">        RemotingCommand request)</span> <span class="keyword">throws</span> RemotingCommandException </span>&#123;</span><br><span class="line">        <span class="comment">// 构造请求响应</span></span><br><span class="line">        <span class="keyword">final</span> RemotingCommand response = RemotingCommand.createResponseCommand(RegisterBrokerResponseHeader.class);</span><br><span class="line">        <span class="keyword">final</span> RegisterBrokerResponseHeader responseHeader = (RegisterBrokerResponseHeader) response.readCustomHeader();</span><br><span class="line">        <span class="comment">// 获取请求头</span></span><br><span class="line">        <span class="keyword">final</span> RegisterBrokerRequestHeader requestHeader =</span><br><span class="line">            (RegisterBrokerRequestHeader) request.decodeCommandCustomHeader(RegisterBrokerRequestHeader.class);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!checksum(ctx, request, requestHeader)) &#123;</span><br><span class="line">            response.setCode(ResponseCode.SYSTEM_ERROR);</span><br><span class="line">            response.setRemark(<span class="string">"crc32 not match"</span>);</span><br><span class="line">            <span class="keyword">return</span> response;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        TopicConfigSerializeWrapper topicConfigWrapper;</span><br><span class="line">        <span class="keyword">if</span> (request.getBody() != <span class="keyword">null</span>) &#123;</span><br><span class="line">            topicConfigWrapper = TopicConfigSerializeWrapper.decode(request.getBody(), TopicConfigSerializeWrapper.class);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            topicConfigWrapper = <span class="keyword">new</span> TopicConfigSerializeWrapper();</span><br><span class="line">            topicConfigWrapper.getDataVersion().setCounter(<span class="keyword">new</span> AtomicLong(<span class="number">0</span>));</span><br><span class="line">            topicConfigWrapper.getDataVersion().setTimestamp(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 这里调用RouteInfoManager的registerBroker对Broker进行注册，可以看到从请求中获取了Broker的信息作为参数传入</span></span><br><span class="line">        RegisterBrokerResult result = <span class="keyword">this</span>.namesrvController.getRouteInfoManager().registerBroker(</span><br><span class="line">            requestHeader.getClusterName(),</span><br><span class="line">            requestHeader.getBrokerAddr(),</span><br><span class="line">            requestHeader.getBrokerName(),</span><br><span class="line">            requestHeader.getBrokerId(),</span><br><span class="line">            requestHeader.getHaServerAddr(),</span><br><span class="line">            topicConfigWrapper,</span><br><span class="line">            <span class="keyword">null</span>,</span><br><span class="line">            ctx.channel()</span><br><span class="line">        );</span><br><span class="line">        <span class="comment">// 设置响应头</span></span><br><span class="line">        responseHeader.setHaServerAddr(result.getHaServerAddr());</span><br><span class="line">        responseHeader.setMasterAddr(result.getMasterAddr());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">byte</span>[] jsonValue = <span class="keyword">this</span>.namesrvController.getKvConfigManager().getKVListByNamespace(NamesrvUtil.NAMESPACE_ORDER_TOPIC_CONFIG);</span><br><span class="line">        response.setBody(jsonValue);</span><br><span class="line">        response.setCode(ResponseCode.SUCCESS);</span><br><span class="line">        response.setRemark(<span class="keyword">null</span>);</span><br><span class="line">        <span class="comment">// 返回响应</span></span><br><span class="line">        <span class="keyword">return</span> response;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="RouteInfoManager"><a href="#RouteInfoManager" class="headerlink" title="RouteInfoManager"></a>RouteInfoManager</h4><p>RouteInfoManager的registerBroker对Broker进行了注册：</p>
<p>1.根据集群名称获取对应的broker集合，然后将当前的broker加入集合中；</p>
<p>2.根据Broker的name获取brokerAddrsMap，其中key为broker的id，value为IP+端口，然后处理重复数据，保证brokerAddrTable核心路由表同一个IP和端口只有一条记录；</p>
<p>3.判断是否是Master，如果是并且Topic发生了变化或者是Broker首次注册，将会创建或者更新当前broker的Topic队列信息；</p>
<p>4.记录当前Broker的LiveInfo，Broker每次定时发送请求作为心跳的时候，都会有一个新的BrokerLiveInfo记录Broker的注册信息，包括注册时间、连接channel等信息，后续可以用来感知Broker是否有异常；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> RegisterBrokerResult <span class="title">registerBroker</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">       <span class="keyword">final</span> String clusterName,</span></span></span><br><span class="line"><span class="function"><span class="params">       <span class="keyword">final</span> String brokerAddr,</span></span></span><br><span class="line"><span class="function"><span class="params">       <span class="keyword">final</span> String brokerName,</span></span></span><br><span class="line"><span class="function"><span class="params">       <span class="keyword">final</span> <span class="keyword">long</span> brokerId,</span></span></span><br><span class="line"><span class="function"><span class="params">       <span class="keyword">final</span> String haServerAddr,</span></span></span><br><span class="line"><span class="function"><span class="params">       <span class="keyword">final</span> TopicConfigSerializeWrapper topicConfigWrapper,</span></span></span><br><span class="line"><span class="function"><span class="params">       <span class="keyword">final</span> List&lt;String&gt; filterServerList,</span></span></span><br><span class="line"><span class="function"><span class="params">       <span class="keyword">final</span> Channel channel)</span> </span>&#123;</span><br><span class="line">       <span class="comment">// 构建注册结果</span></span><br><span class="line">       RegisterBrokerResult result = <span class="keyword">new</span> RegisterBrokerResult();</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           <span class="keyword">try</span> &#123;</span><br><span class="line">               <span class="comment">// 加锁</span></span><br><span class="line">               <span class="keyword">this</span>.lock.writeLock().lockInterruptibly();</span><br><span class="line">               <span class="comment">// 根据集群名称获取对应的broker集合，这里用set集合，当Broker发送心跳机制的时候集合不会有重复数据</span></span><br><span class="line">               Set&lt;String&gt; brokerNames = <span class="keyword">this</span>.clusterAddrTable.get(clusterName);</span><br><span class="line">               <span class="keyword">if</span> (<span class="keyword">null</span> == brokerNames) &#123;</span><br><span class="line">                   brokerNames = <span class="keyword">new</span> HashSet&lt;String&gt;();</span><br><span class="line">                   <span class="keyword">this</span>.clusterAddrTable.put(clusterName, brokerNames);</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="comment">// 向集合中添加当前的broker</span></span><br><span class="line">               brokerNames.add(brokerName);</span><br><span class="line"></span><br><span class="line">               <span class="keyword">boolean</span> registerFirst = <span class="keyword">false</span>;</span><br><span class="line">               <span class="comment">// 根据Broker name获取BrokerData</span></span><br><span class="line">               BrokerData brokerData = <span class="keyword">this</span>.brokerAddrTable.get(brokerName);</span><br><span class="line">               <span class="comment">// 首次注册的时候为空</span></span><br><span class="line">               <span class="keyword">if</span> (<span class="keyword">null</span> == brokerData) &#123;</span><br><span class="line">                   registerFirst = <span class="keyword">true</span>;</span><br><span class="line">                   <span class="comment">// 如果获取为空，构造BrokerData加入brokerAddrTable中</span></span><br><span class="line">                   brokerData = <span class="keyword">new</span> BrokerData(clusterName, brokerName, <span class="keyword">new</span> HashMap&lt;Long, String&gt;());</span><br><span class="line">                   <span class="keyword">this</span>.brokerAddrTable.put(brokerName, brokerData);</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="comment">// 根据broker name获取所有broker的地址，key为brokerId，value为IP:PROT</span></span><br><span class="line">               Map&lt;Long, String&gt; brokerAddrsMap = brokerData.getBrokerAddrs();</span><br><span class="line">               <span class="comment">//Switch slave to master: first remove &lt;1, IP:PORT&gt; in namesrv, then add &lt;0, IP:PORT&gt;</span></span><br><span class="line">               <span class="comment">//The same IP:PORT must only have one record in brokerAddrTable</span></span><br><span class="line">               <span class="comment">// 这里处理重复数据，保证同一个IP和端口只在brokerAddrTable有一条记录</span></span><br><span class="line">               Iterator&lt;Entry&lt;Long, String&gt;&gt; it = brokerAddrsMap.entrySet().iterator();</span><br><span class="line">               <span class="keyword">while</span> (it.hasNext()) &#123;</span><br><span class="line">                   Entry&lt;Long, String&gt; item = it.next();</span><br><span class="line">                   <span class="comment">// 如果IP和端口一致，但是brokerID不一致，移除旧的记录</span></span><br><span class="line">                   <span class="keyword">if</span> (<span class="keyword">null</span> != brokerAddr &amp;&amp; brokerAddr.equals(item.getValue()) &amp;&amp; brokerId != item.getKey()) &#123;</span><br><span class="line">                       it.remove();</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="comment">// 加入当前的broker信息</span></span><br><span class="line">               String oldAddr = brokerData.getBrokerAddrs().put(brokerId, brokerAddr);</span><br><span class="line">               <span class="comment">// 判断是否是首次注册</span></span><br><span class="line">               registerFirst = registerFirst || (<span class="keyword">null</span> == oldAddr);</span><br><span class="line">               <span class="comment">// 如果topicConfigWrapper不为空，并且当前的broker是master</span></span><br><span class="line">               <span class="keyword">if</span> (<span class="keyword">null</span> != topicConfigWrapper</span><br><span class="line">                   &amp;&amp; MixAll.MASTER_ID == brokerId) &#123;</span><br><span class="line">                   <span class="comment">// 如果Topic有变化或者是首次注册</span></span><br><span class="line">                   <span class="keyword">if</span> (<span class="keyword">this</span>.isBrokerTopicConfigChanged(brokerAddr, topicConfigWrapper.getDataVersion())</span><br><span class="line">                       || registerFirst) &#123;</span><br><span class="line">                       <span class="comment">// 获取当前broker的所有的Topic</span></span><br><span class="line">                       ConcurrentMap&lt;String, TopicConfig&gt; tcTable =</span><br><span class="line">                           topicConfigWrapper.getTopicConfigTable();</span><br><span class="line">                       <span class="keyword">if</span> (tcTable != <span class="keyword">null</span>) &#123;</span><br><span class="line">                           <span class="comment">// 遍历topic</span></span><br><span class="line">                           <span class="keyword">for</span> (Map.Entry&lt;String, TopicConfig&gt; entry : tcTable.entrySet()) &#123;</span><br><span class="line">                               <span class="comment">// 创建或者更新当前broker的Topic队列信息</span></span><br><span class="line">                               <span class="keyword">this</span>.createAndUpdateQueueData(brokerName, entry.getValue());</span><br><span class="line">                           &#125;</span><br><span class="line">                       &#125;</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="comment">// 构建BrokerLiveInfo,记录Broker的LiveInfo，当Broker定时发送请求作为心跳的时候，都会有一个新的BrokerLiveInfo记录Broker的注册信息，包括注册时间、连接channel等信息</span></span><br><span class="line">               BrokerLiveInfo prevBrokerLiveInfo = <span class="keyword">this</span>.brokerLiveTable.put(brokerAddr,</span><br><span class="line">                   <span class="keyword">new</span> BrokerLiveInfo(</span><br><span class="line">                       System.currentTimeMillis(),</span><br><span class="line">                       topicConfigWrapper.getDataVersion(),</span><br><span class="line">                       channel,</span><br><span class="line">                       haServerAddr));</span><br><span class="line">               <span class="keyword">if</span> (<span class="keyword">null</span> == prevBrokerLiveInfo) &#123;</span><br><span class="line">                   log.info(<span class="string">"new broker registered, &#123;&#125; HAServer: &#123;&#125;"</span>, brokerAddr, haServerAddr);</span><br><span class="line">               &#125;</span><br><span class="line"></span><br><span class="line">               <span class="keyword">if</span> (filterServerList != <span class="keyword">null</span>) &#123;</span><br><span class="line">                   <span class="keyword">if</span> (filterServerList.isEmpty()) &#123;</span><br><span class="line">                       <span class="keyword">this</span>.filterServerTable.remove(brokerAddr);</span><br><span class="line">                   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                       <span class="keyword">this</span>.filterServerTable.put(brokerAddr, filterServerList);</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="comment">// 如果不是master </span></span><br><span class="line">               <span class="keyword">if</span> (MixAll.MASTER_ID != brokerId) &#123;</span><br><span class="line">                   <span class="comment">// 获取master信息</span></span><br><span class="line">                   String masterAddr = brokerData.getBrokerAddrs().get(MixAll.MASTER_ID);</span><br><span class="line">                   <span class="keyword">if</span> (masterAddr != <span class="keyword">null</span>) &#123;</span><br><span class="line">                       <span class="comment">// 获取master的LiveInfo</span></span><br><span class="line">                       BrokerLiveInfo brokerLiveInfo = <span class="keyword">this</span>.brokerLiveTable.get(masterAddr);</span><br><span class="line">                       <span class="keyword">if</span> (brokerLiveInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line">                           result.setHaServerAddr(brokerLiveInfo.getHaServerAddr());</span><br><span class="line">                           result.setMasterAddr(masterAddr);</span><br><span class="line">                       &#125;</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">               <span class="keyword">this</span>.lock.writeLock().unlock();</span><br><span class="line">           &#125;</span><br><span class="line">       &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">           log.error(<span class="string">"registerBroker Exception"</span>, e);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">return</span> result;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<h3 id="异常感知"><a href="#异常感知" class="headerlink" title="异常感知"></a>异常感知</h3><p>在NamesrvController的初始化方法中启动了一个定时任务，调用了routeInfoManager的scanNotActiveBroker方法扫描不活跃的Broker，默认10s扫描一次：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NamesrvController</span> </span>&#123;</span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">initialize</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">// 定时任务线程池，启动了routeInfoManager的扫描不活跃的Broker方法</span></span><br><span class="line">        <span class="keyword">this</span>.scheduledExecutorService.scheduleAtFixedRate(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                NamesrvController.<span class="keyword">this</span>.routeInfoManager.scanNotActiveBroker();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="number">5</span>, <span class="number">10</span>, TimeUnit.SECONDS);</span><br><span class="line">        ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="RouteInfoManager-1"><a href="#RouteInfoManager-1" class="headerlink" title="RouteInfoManager"></a>RouteInfoManager</h4><p>RouteInfoManager的scanNotActiveBroker会扫描超时未发送心跳的Broker，默认是120s，如果超过120s没有收到心跳注册，就会移除Broker的路由信息：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 扫描不活跃的Broker</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">scanNotActiveBroker</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 遍历所有的BrokerLiveInfo</span></span><br><span class="line">        Iterator&lt;Entry&lt;String, BrokerLiveInfo&gt;&gt; it = <span class="keyword">this</span>.brokerLiveTable.entrySet().iterator();</span><br><span class="line">        <span class="keyword">while</span> (it.hasNext()) &#123;</span><br><span class="line">            Entry&lt;String, BrokerLiveInfo&gt; next = it.next();</span><br><span class="line">            <span class="comment">// 获取最后一次注册的时间戳</span></span><br><span class="line">            <span class="keyword">long</span> last = next.getValue().getLastUpdateTimestamp();</span><br><span class="line">            <span class="comment">// 判断是否超过设定的时间，默认是120s</span></span><br><span class="line">            <span class="keyword">if</span> ((last + BROKER_CHANNEL_EXPIRED_TIME) &lt; System.currentTimeMillis()) &#123;</span><br><span class="line">                RemotingUtil.closeChannel(next.getValue().getChannel());</span><br><span class="line">                it.remove();</span><br><span class="line">                log.warn(<span class="string">"The broker channel expired, &#123;&#125; &#123;&#125;ms"</span>, next.getKey(), BROKER_CHANNEL_EXPIRED_TIME);</span><br><span class="line">                <span class="comment">// 将移除Broker的路由信息</span></span><br><span class="line">                <span class="keyword">this</span>.onChannelDestroy(next.getKey(), next.getValue().getChannel());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p><img src="/images/broker注册.jpg" alt=""> </p>
<p>注：图片来自于儒猿技术窝-从 0 开始带你成为消息中间件实战高手</p>
<p><strong>参考</strong></p>
<p>儒猿技术窝：从 0 开始带你成为消息中间件实战高手</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/03/20/【RocketMQ】Broker的启动/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="shan">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="SHAN">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/03/20/【RocketMQ】Broker的启动/" itemprop="url">【RocketMQ】Broker的启动</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2021-03-20T21:00:00+08:00">
                2021-03-20
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="BrokerStartup"><a href="#BrokerStartup" class="headerlink" title="BrokerStartup"></a>BrokerStartup</h3><p>BrokerStartup是Broker的启动类：</p>
<p>1.与NameServer启动时一样，会初始化相关配置参数，与NameServer不一样的地方是，Broker不仅会创建Netty Server的配置， 也会创建Netty Client的配置，因为Broker作为Client，需要向NameServer发送请求进行注册，同时Broker又需要作为Server接受Producer和Consumer的请求生产/消费消息；</p>
<p>2.Broker会从配置文件中获取NameServer的地址列表，后续向NameServer注册；</p>
<p>3.创建BrokerController，BrokerController是Broker的核心组件；</p>
<p>4.注册关闭时的钩子函数，在关闭前处理资源的关闭。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BrokerStartup</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 入口</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        start(createBrokerController(args));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> BrokerController <span class="title">start</span><span class="params">(BrokerController controller)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 启动</span></span><br><span class="line">            controller.start();</span><br><span class="line"></span><br><span class="line">            String tip = <span class="string">"The broker["</span> + controller.getBrokerConfig().getBrokerName() + <span class="string">", "</span></span><br><span class="line">                + controller.getBrokerAddr() + <span class="string">"] boot success. serializeType="</span> + RemotingCommand.getSerializeTypeConfigInThisServer();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">null</span> != controller.getBrokerConfig().getNamesrvAddr()) &#123;</span><br><span class="line">                tip += <span class="string">" and name server is "</span> + controller.getBrokerConfig().getNamesrvAddr();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            log.info(tip);</span><br><span class="line">            System.out.printf(<span class="string">"%s%n"</span>, tip);</span><br><span class="line">            <span class="keyword">return</span> controller;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            System.exit(-<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建BrokerController</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> BrokerController <span class="title">createBrokerController</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        System.setProperty(RemotingCommand.REMOTING_VERSION_KEY, Integer.toString(MQVersion.CURRENT_VERSION));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == System.getProperty(NettySystemConfig.COM_ROCKETMQ_REMOTING_SOCKET_SNDBUF_SIZE)) &#123;</span><br><span class="line">            NettySystemConfig.socketSndbufSize = <span class="number">131072</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == System.getProperty(NettySystemConfig.COM_ROCKETMQ_REMOTING_SOCKET_RCVBUF_SIZE)) &#123;</span><br><span class="line">            NettySystemConfig.socketRcvbufSize = <span class="number">131072</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 处理命令行相关参数</span></span><br><span class="line">            Options options = ServerUtil.buildCommandlineOptions(<span class="keyword">new</span> Options());</span><br><span class="line">            commandLine = ServerUtil.parseCmdLine(<span class="string">"mqbroker"</span>, args, buildCommandlineOptions(options),</span><br><span class="line">                <span class="keyword">new</span> PosixParser());</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">null</span> == commandLine) &#123;</span><br><span class="line">                System.exit(-<span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 创建Broker配置</span></span><br><span class="line">            <span class="keyword">final</span> BrokerConfig brokerConfig = <span class="keyword">new</span> BrokerConfig();</span><br><span class="line">            <span class="comment">// 创建Netty Server配置</span></span><br><span class="line">            <span class="keyword">final</span> NettyServerConfig nettyServerConfig = <span class="keyword">new</span> NettyServerConfig();</span><br><span class="line">            <span class="comment">// 创建Netty Client配置</span></span><br><span class="line">            <span class="keyword">final</span> NettyClientConfig nettyClientConfig = <span class="keyword">new</span> NettyClientConfig();</span><br><span class="line">            <span class="comment">// 设置Netty Cliet TLS</span></span><br><span class="line">            nettyClientConfig.setUseTLS(Boolean.parseBoolean(System.getProperty(TLS_ENABLE,</span><br><span class="line">                String.valueOf(TlsSystemConfig.tlsMode == TlsMode.ENFORCING))));</span><br><span class="line">            <span class="comment">// 设置Netty Server默认端口</span></span><br><span class="line">            nettyServerConfig.setListenPort(<span class="number">10911</span>);</span><br><span class="line">            <span class="comment">// 创建MessageStoreConfig，从名字上可以看出是存储消息的一些配置</span></span><br><span class="line">            <span class="keyword">final</span> MessageStoreConfig messageStoreConfig = <span class="keyword">new</span> MessageStoreConfig();</span><br><span class="line">            <span class="comment">// 如果是SLAVE</span></span><br><span class="line">            <span class="keyword">if</span> (BrokerRole.SLAVE == messageStoreConfig.getBrokerRole()) &#123;</span><br><span class="line">                <span class="keyword">int</span> ratio = messageStoreConfig.getAccessMessageInMemoryMaxRatio() - <span class="number">10</span>;</span><br><span class="line">                messageStoreConfig.setAccessMessageInMemoryMaxRatio(ratio);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 如果启动的时候命令行中带了-c参数</span></span><br><span class="line">            <span class="keyword">if</span> (commandLine.hasOption(<span class="string">'c'</span>)) &#123;</span><br><span class="line">                String file = commandLine.getOptionValue(<span class="string">'c'</span>);</span><br><span class="line">                <span class="comment">// 读取自定义配置文件</span></span><br><span class="line">                <span class="keyword">if</span> (file != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    configFile = file;</span><br><span class="line">                    InputStream in = <span class="keyword">new</span> BufferedInputStream(<span class="keyword">new</span> FileInputStream(file));</span><br><span class="line">                    properties = <span class="keyword">new</span> Properties();</span><br><span class="line">                    properties.load(in);</span><br><span class="line"></span><br><span class="line">                    properties2SystemEnv(properties);</span><br><span class="line">                    MixAll.properties2Object(properties, brokerConfig);</span><br><span class="line">                    MixAll.properties2Object(properties, nettyServerConfig);</span><br><span class="line">                    MixAll.properties2Object(properties, nettyClientConfig);</span><br><span class="line">                    MixAll.properties2Object(properties, messageStoreConfig);</span><br><span class="line"></span><br><span class="line">                    BrokerPathConfigHelper.setBrokerConfigPath(file);</span><br><span class="line">                    in.close();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 将命令行中的参数设置到BrokerConfig中</span></span><br><span class="line">            MixAll.properties2Object(ServerUtil.commandLine2Properties(commandLine), brokerConfig);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">null</span> == brokerConfig.getRocketmqHome()) &#123;</span><br><span class="line">                System.out.printf(<span class="string">"Please set the %s variable in your environment to match the location of the RocketMQ installation"</span>, MixAll.ROCKETMQ_HOME_ENV);</span><br><span class="line">                System.exit(-<span class="number">2</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 获取NameServer地址</span></span><br><span class="line">            String namesrvAddr = brokerConfig.getNamesrvAddr();</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">null</span> != namesrvAddr) &#123;</span><br><span class="line">                <span class="comment">// 解析NameServer地址</span></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    String[] addrArray = namesrvAddr.split(<span class="string">";"</span>);</span><br><span class="line">                    <span class="keyword">for</span> (String addr : addrArray) &#123;</span><br><span class="line">                        RemotingUtil.string2SocketAddress(addr);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    System.out.printf(</span><br><span class="line">                        <span class="string">"The Name Server Address[%s] illegal, please set it as follows, \"127.0.0.1:9876;192.168.0.1:9876\"%n"</span>,</span><br><span class="line">                        namesrvAddr);</span><br><span class="line">                    System.exit(-<span class="number">3</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 判断Broker角色</span></span><br><span class="line">            <span class="keyword">switch</span> (messageStoreConfig.getBrokerRole()) &#123;</span><br><span class="line">                <span class="keyword">case</span> ASYNC_MASTER:</span><br><span class="line">                <span class="keyword">case</span> SYNC_MASTER:</span><br><span class="line">                    brokerConfig.setBrokerId(MixAll.MASTER_ID);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> SLAVE:</span><br><span class="line">                    <span class="keyword">if</span> (brokerConfig.getBrokerId() &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                        System.out.printf(<span class="string">"Slave's brokerId must be &gt; 0"</span>);</span><br><span class="line">                        System.exit(-<span class="number">3</span>);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 是否基于delger管理主从同步和commitlog</span></span><br><span class="line">            <span class="keyword">if</span> (messageStoreConfig.isEnableDLegerCommitLog()) &#123;</span><br><span class="line">                brokerConfig.setBrokerId(-<span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 设置HA监听端口</span></span><br><span class="line">            messageStoreConfig.setHaListenPort(nettyServerConfig.getListenPort() + <span class="number">1</span>);</span><br><span class="line">            <span class="comment">// 日志相关</span></span><br><span class="line">            LoggerContext lc = (LoggerContext) LoggerFactory.getILoggerFactory();</span><br><span class="line">            JoranConfigurator configurator = <span class="keyword">new</span> JoranConfigurator();</span><br><span class="line">            configurator.setContext(lc);</span><br><span class="line">            lc.reset();</span><br><span class="line">            configurator.doConfigure(brokerConfig.getRocketmqHome() + <span class="string">"/conf/logback_broker.xml"</span>);</span><br><span class="line">            <span class="comment">// 如果启动带了-p参数</span></span><br><span class="line">            <span class="keyword">if</span> (commandLine.hasOption(<span class="string">'p'</span>)) &#123;</span><br><span class="line">                InternalLogger console = InternalLoggerFactory.getLogger(LoggerName.BROKER_CONSOLE_NAME);</span><br><span class="line">                MixAll.printObjectProperties(console, brokerConfig);</span><br><span class="line">                MixAll.printObjectProperties(console, nettyServerConfig);</span><br><span class="line">                MixAll.printObjectProperties(console, nettyClientConfig);</span><br><span class="line">                MixAll.printObjectProperties(console, messageStoreConfig);</span><br><span class="line">                System.exit(<span class="number">0</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (commandLine.hasOption(<span class="string">'m'</span>)) &#123;</span><br><span class="line">                InternalLogger console = InternalLoggerFactory.getLogger(LoggerName.BROKER_CONSOLE_NAME);</span><br><span class="line">                MixAll.printObjectProperties(console, brokerConfig, <span class="keyword">true</span>);</span><br><span class="line">                MixAll.printObjectProperties(console, nettyServerConfig, <span class="keyword">true</span>);</span><br><span class="line">                MixAll.printObjectProperties(console, nettyClientConfig, <span class="keyword">true</span>);</span><br><span class="line">                MixAll.printObjectProperties(console, messageStoreConfig, <span class="keyword">true</span>);</span><br><span class="line">                System.exit(<span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 打印配置参数</span></span><br><span class="line">            log = InternalLoggerFactory.getLogger(LoggerName.BROKER_LOGGER_NAME);</span><br><span class="line">            MixAll.printObjectProperties(log, brokerConfig);</span><br><span class="line">            MixAll.printObjectProperties(log, nettyServerConfig);</span><br><span class="line">            MixAll.printObjectProperties(log, nettyClientConfig);</span><br><span class="line">            MixAll.printObjectProperties(log, messageStoreConfig);</span><br><span class="line">            <span class="comment">// 创建BrokerController</span></span><br><span class="line">            <span class="keyword">final</span> BrokerController controller = <span class="keyword">new</span> BrokerController(</span><br><span class="line">                brokerConfig,</span><br><span class="line">                nettyServerConfig,</span><br><span class="line">                nettyClientConfig,</span><br><span class="line">                messageStoreConfig);</span><br><span class="line">            <span class="comment">// remember all configs to prevent discard</span></span><br><span class="line">            controller.getConfiguration().registerConfig(properties);</span><br><span class="line">            <span class="comment">// 初始化BrokerStartup</span></span><br><span class="line">            <span class="keyword">boolean</span> initResult = controller.initialize();</span><br><span class="line">            <span class="keyword">if</span> (!initResult) &#123;</span><br><span class="line">                controller.shutdown();</span><br><span class="line">                System.exit(-<span class="number">3</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 注册关闭时的钩子函数</span></span><br><span class="line">            Runtime.getRuntime().addShutdownHook(<span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> hasShutdown = <span class="keyword">false</span>;</span><br><span class="line">                <span class="keyword">private</span> AtomicInteger shutdownTimes = <span class="keyword">new</span> AtomicInteger(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">                        log.info(<span class="string">"Shutdown hook was invoked, &#123;&#125;"</span>, <span class="keyword">this</span>.shutdownTimes.incrementAndGet());</span><br><span class="line">                        <span class="keyword">if</span> (!<span class="keyword">this</span>.hasShutdown) &#123;</span><br><span class="line">                            <span class="keyword">this</span>.hasShutdown = <span class="keyword">true</span>;</span><br><span class="line">                            <span class="keyword">long</span> beginTime = System.currentTimeMillis();</span><br><span class="line">                            <span class="comment">// 调用BrokerController的shutdown方法进行关资源的关闭</span></span><br><span class="line">                            controller.shutdown();</span><br><span class="line">                            <span class="keyword">long</span> consumingTimeTotal = System.currentTimeMillis() - beginTime;</span><br><span class="line">                            log.info(<span class="string">"Shutdown hook over, consuming total time(ms): &#123;&#125;"</span>, consumingTimeTotal);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;, <span class="string">"ShutdownHook"</span>));</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> controller;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            System.exit(-<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="BrokerController"><a href="#BrokerController" class="headerlink" title="BrokerController"></a>BrokerController</h3><p>BrokerController是Broker的核心组件，包含了一些核心的功能组件和线程池，管理Broker的请求处理、后台线程和磁盘数据。</p>
<h4 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h4><p>1.从磁盘上加载一些相关配置，如Topic配置、Consumer的Offset等数据；</p>
<p>2.创建消息管理组件DefaultMessageStore，如果开启了Dleger，初始化DLeger相关配置；</p>
<p>3.创建Netty Server服务器；</p>
<p>4.创建了一系列的线程池，用来定时调度后台任务，如处理消息拉取的任务、处理发送消息的任务；</p>
<p>5.处理NameServer地址列表;</p>
<p>6.一些其他的操作，暂时先不管。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">initialize</span><span class="params">()</span> <span class="keyword">throws</span> CloneNotSupportedException </span>&#123;</span><br><span class="line">      <span class="comment">// 从磁盘上加载Topic的配置</span></span><br><span class="line">      <span class="keyword">boolean</span> result = <span class="keyword">this</span>.topicConfigManager.load();</span><br><span class="line">      <span class="comment">// 加载Consumer的Offset</span></span><br><span class="line">      result = result &amp;&amp; <span class="keyword">this</span>.consumerOffsetManager.load();</span><br><span class="line">      <span class="comment">// 加载订阅组</span></span><br><span class="line">      result = result &amp;&amp; <span class="keyword">this</span>.subscriptionGroupManager.load();</span><br><span class="line">      <span class="comment">// 加载过滤器</span></span><br><span class="line">      result = result &amp;&amp; <span class="keyword">this</span>.consumerFilterManager.load();</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (result) &#123;</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">              <span class="comment">// 创建消息管理组件DefaultMessageStore</span></span><br><span class="line">              <span class="keyword">this</span>.messageStore =</span><br><span class="line">                  <span class="keyword">new</span> DefaultMessageStore(<span class="keyword">this</span>.messageStoreConfig, <span class="keyword">this</span>.brokerStatsManager, <span class="keyword">this</span>.messageArrivingListener,</span><br><span class="line">                      <span class="keyword">this</span>.brokerConfig);</span><br><span class="line">              <span class="comment">// 初始化DLeger相关配置</span></span><br><span class="line">              <span class="keyword">if</span> (messageStoreConfig.isEnableDLegerCommitLog()) &#123;</span><br><span class="line">                  DLedgerRoleChangeHandler roleChangeHandler = <span class="keyword">new</span> DLedgerRoleChangeHandler(<span class="keyword">this</span>, (DefaultMessageStore) messageStore);</span><br><span class="line">                  ((DLedgerCommitLog)((DefaultMessageStore) messageStore).getCommitLog()).getdLedgerServer().getdLedgerLeaderElector().addRoleChangeHandler(roleChangeHandler);</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">this</span>.brokerStats = <span class="keyword">new</span> BrokerStats((DefaultMessageStore) <span class="keyword">this</span>.messageStore);</span><br><span class="line">              <span class="comment">//load plugin</span></span><br><span class="line">              MessageStorePluginContext context = <span class="keyword">new</span> MessageStorePluginContext(messageStoreConfig, brokerStatsManager, messageArrivingListener, brokerConfig);</span><br><span class="line">              <span class="keyword">this</span>.messageStore = MessageStoreFactory.build(context, <span class="keyword">this</span>.messageStore);</span><br><span class="line">              <span class="keyword">this</span>.messageStore.getDispatcherList().addFirst(<span class="keyword">new</span> CommitLogDispatcherCalcBitMap(<span class="keyword">this</span>.brokerConfig, <span class="keyword">this</span>.consumerFilterManager));</span><br><span class="line">          &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">              result = <span class="keyword">false</span>;</span><br><span class="line">              log.error(<span class="string">"Failed to initialize"</span>, e);</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      result = result &amp;&amp; <span class="keyword">this</span>.messageStore.load();</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (result) &#123;</span><br><span class="line">          <span class="comment">// 创建Netty Server</span></span><br><span class="line">          <span class="keyword">this</span>.remotingServer = <span class="keyword">new</span> NettyRemotingServer(<span class="keyword">this</span>.nettyServerConfig, <span class="keyword">this</span>.clientHousekeepingService);</span><br><span class="line">          NettyServerConfig fastConfig = (NettyServerConfig) <span class="keyword">this</span>.nettyServerConfig.clone();</span><br><span class="line">          <span class="comment">// 设置监听端口</span></span><br><span class="line">          fastConfig.setListenPort(nettyServerConfig.getListenPort() - <span class="number">2</span>);</span><br><span class="line">          <span class="keyword">this</span>.fastRemotingServer = <span class="keyword">new</span> NettyRemotingServer(fastConfig, <span class="keyword">this</span>.clientHousekeepingService);</span><br><span class="line">          <span class="comment">// 发送消息的线程池，处理发送过来的消息</span></span><br><span class="line">          <span class="keyword">this</span>.sendMessageExecutor = <span class="keyword">new</span> BrokerFixedThreadPoolExecutor(</span><br><span class="line">              <span class="keyword">this</span>.brokerConfig.getSendMessageThreadPoolNums(),</span><br><span class="line">              <span class="keyword">this</span>.brokerConfig.getSendMessageThreadPoolNums(),</span><br><span class="line">              <span class="number">1000</span> * <span class="number">60</span>,</span><br><span class="line">              TimeUnit.MILLISECONDS,</span><br><span class="line">              <span class="keyword">this</span>.sendThreadPoolQueue,</span><br><span class="line">              <span class="keyword">new</span> ThreadFactoryImpl(<span class="string">"SendMessageThread_"</span>));</span><br><span class="line">          <span class="comment">// 拉取消息的线程池，处理消息的拉取</span></span><br><span class="line">          <span class="keyword">this</span>.pullMessageExecutor = <span class="keyword">new</span> BrokerFixedThreadPoolExecutor(</span><br><span class="line">              <span class="keyword">this</span>.brokerConfig.getPullMessageThreadPoolNums(),</span><br><span class="line">              <span class="keyword">this</span>.brokerConfig.getPullMessageThreadPoolNums(),</span><br><span class="line">              <span class="number">1000</span> * <span class="number">60</span>,</span><br><span class="line">              TimeUnit.MILLISECONDS,</span><br><span class="line">              <span class="keyword">this</span>.pullThreadPoolQueue,</span><br><span class="line">              <span class="keyword">new</span> ThreadFactoryImpl(<span class="string">"PullMessageThread_"</span>));</span><br><span class="line">          <span class="comment">// 处理回复消息的线程池</span></span><br><span class="line">          <span class="keyword">this</span>.replyMessageExecutor = <span class="keyword">new</span> BrokerFixedThreadPoolExecutor(</span><br><span class="line">              <span class="keyword">this</span>.brokerConfig.getProcessReplyMessageThreadPoolNums(),</span><br><span class="line">              <span class="keyword">this</span>.brokerConfig.getProcessReplyMessageThreadPoolNums(),</span><br><span class="line">              <span class="number">1000</span> * <span class="number">60</span>,</span><br><span class="line">              TimeUnit.MILLISECONDS,</span><br><span class="line">              <span class="keyword">this</span>.replyThreadPoolQueue,</span><br><span class="line">              <span class="keyword">new</span> ThreadFactoryImpl(<span class="string">"ProcessReplyMessageThread_"</span>));</span><br><span class="line">          <span class="comment">// 处理消息查询的线程池</span></span><br><span class="line">          <span class="keyword">this</span>.queryMessageExecutor = <span class="keyword">new</span> BrokerFixedThreadPoolExecutor(</span><br><span class="line">              <span class="keyword">this</span>.brokerConfig.getQueryMessageThreadPoolNums(),</span><br><span class="line">              <span class="keyword">this</span>.brokerConfig.getQueryMessageThreadPoolNums(),</span><br><span class="line">              <span class="number">1000</span> * <span class="number">60</span>,</span><br><span class="line">              TimeUnit.MILLISECONDS,</span><br><span class="line">              <span class="keyword">this</span>.queryThreadPoolQueue,</span><br><span class="line">              <span class="keyword">new</span> ThreadFactoryImpl(<span class="string">"QueryMessageThread_"</span>));</span><br><span class="line"></span><br><span class="line">          <span class="keyword">this</span>.adminBrokerExecutor =</span><br><span class="line">              Executors.newFixedThreadPool(<span class="keyword">this</span>.brokerConfig.getAdminBrokerThreadPoolNums(), <span class="keyword">new</span> ThreadFactoryImpl(</span><br><span class="line">                  <span class="string">"AdminBrokerThread_"</span>));</span><br><span class="line">          <span class="comment">// 管理客户端的线程池</span></span><br><span class="line">          <span class="keyword">this</span>.clientManageExecutor = <span class="keyword">new</span> ThreadPoolExecutor(</span><br><span class="line">              <span class="keyword">this</span>.brokerConfig.getClientManageThreadPoolNums(),</span><br><span class="line">              <span class="keyword">this</span>.brokerConfig.getClientManageThreadPoolNums(),</span><br><span class="line">              <span class="number">1000</span> * <span class="number">60</span>,</span><br><span class="line">              TimeUnit.MILLISECONDS,</span><br><span class="line">              <span class="keyword">this</span>.clientManagerThreadPoolQueue,</span><br><span class="line">              <span class="keyword">new</span> ThreadFactoryImpl(<span class="string">"ClientManageThread_"</span>));</span><br><span class="line">          <span class="comment">// 处理心跳机制的线程池</span></span><br><span class="line">          <span class="keyword">this</span>.heartbeatExecutor = <span class="keyword">new</span> BrokerFixedThreadPoolExecutor(</span><br><span class="line">              <span class="keyword">this</span>.brokerConfig.getHeartbeatThreadPoolNums(),</span><br><span class="line">              <span class="keyword">this</span>.brokerConfig.getHeartbeatThreadPoolNums(),</span><br><span class="line">              <span class="number">1000</span> * <span class="number">60</span>,</span><br><span class="line">              TimeUnit.MILLISECONDS,</span><br><span class="line">              <span class="keyword">this</span>.heartbeatThreadPoolQueue,</span><br><span class="line">              <span class="keyword">new</span> ThreadFactoryImpl(<span class="string">"HeartbeatThread_"</span>, <span class="keyword">true</span>));</span><br><span class="line">          <span class="comment">// 处理事务结束的线程池</span></span><br><span class="line">          <span class="keyword">this</span>.endTransactionExecutor = <span class="keyword">new</span> BrokerFixedThreadPoolExecutor(</span><br><span class="line">              <span class="keyword">this</span>.brokerConfig.getEndTransactionThreadPoolNums(),</span><br><span class="line">              <span class="keyword">this</span>.brokerConfig.getEndTransactionThreadPoolNums(),</span><br><span class="line">              <span class="number">1000</span> * <span class="number">60</span>,</span><br><span class="line">              TimeUnit.MILLISECONDS,</span><br><span class="line">              <span class="keyword">this</span>.endTransactionThreadPoolQueue,</span><br><span class="line">              <span class="keyword">new</span> ThreadFactoryImpl(<span class="string">"EndTransactionThread_"</span>));</span><br><span class="line">          <span class="comment">// 管理消费者的线程池</span></span><br><span class="line">          <span class="keyword">this</span>.consumerManageExecutor =</span><br><span class="line">              Executors.newFixedThreadPool(<span class="keyword">this</span>.brokerConfig.getConsumerManageThreadPoolNums(), <span class="keyword">new</span> ThreadFactoryImpl(</span><br><span class="line">                  <span class="string">"ConsumerManageThread_"</span>));</span><br><span class="line"></span><br><span class="line">          <span class="keyword">this</span>.registerProcessor();</span><br><span class="line">          <span class="comment">/**一些后台任务的定时调度线程池**/</span></span><br><span class="line">          <span class="keyword">final</span> <span class="keyword">long</span> initialDelay = UtilAll.computeNextMorningTimeMillis() - System.currentTimeMillis();</span><br><span class="line">          <span class="keyword">final</span> <span class="keyword">long</span> period = <span class="number">1000</span> * <span class="number">60</span> * <span class="number">60</span> * <span class="number">24</span>;</span><br><span class="line">          <span class="comment">// 处理Broker统计任务</span></span><br><span class="line">          <span class="keyword">this</span>.scheduledExecutorService.scheduleAtFixedRate(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">              <span class="meta">@Override</span></span><br><span class="line">              <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                  <span class="keyword">try</span> &#123;</span><br><span class="line">                      BrokerController.<span class="keyword">this</span>.getBrokerStats().record();</span><br><span class="line">                  &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                      log.error(<span class="string">"schedule record error."</span>, e);</span><br><span class="line">                  &#125;</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;, initialDelay, period, TimeUnit.MILLISECONDS);</span><br><span class="line">          <span class="comment">// 处理消费者offset持久化到磁盘的定时任务</span></span><br><span class="line">          <span class="keyword">this</span>.scheduledExecutorService.scheduleAtFixedRate(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">              <span class="meta">@Override</span></span><br><span class="line">              <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                  <span class="keyword">try</span> &#123;</span><br><span class="line">                      BrokerController.<span class="keyword">this</span>.consumerOffsetManager.persist();</span><br><span class="line">                  &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                      log.error(<span class="string">"schedule persist consumerOffset error."</span>, e);</span><br><span class="line">                  &#125;</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;, <span class="number">1000</span> * <span class="number">10</span>, <span class="keyword">this</span>.brokerConfig.getFlushConsumerOffsetInterval(), TimeUnit.MILLISECONDS);</span><br><span class="line">          <span class="comment">// 处理过滤器持久化到磁盘的定时任务</span></span><br><span class="line">          <span class="keyword">this</span>.scheduledExecutorService.scheduleAtFixedRate(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">              <span class="meta">@Override</span></span><br><span class="line">              <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                  <span class="keyword">try</span> &#123;</span><br><span class="line">                      BrokerController.<span class="keyword">this</span>.consumerFilterManager.persist();</span><br><span class="line">                  &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                      log.error(<span class="string">"schedule persist consumer filter error."</span>, e);</span><br><span class="line">                  &#125;</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;, <span class="number">1000</span> * <span class="number">10</span>, <span class="number">1000</span> * <span class="number">10</span>, TimeUnit.MILLISECONDS);</span><br><span class="line">          <span class="comment">// 对broker保护的定时任务</span></span><br><span class="line">          <span class="keyword">this</span>.scheduledExecutorService.scheduleAtFixedRate(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">              <span class="meta">@Override</span></span><br><span class="line">              <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                  <span class="keyword">try</span> &#123;</span><br><span class="line">                      BrokerController.<span class="keyword">this</span>.protectBroker();</span><br><span class="line">                  &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                      log.error(<span class="string">"protectBroker error."</span>, e);</span><br><span class="line">                  &#125;</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;, <span class="number">3</span>, <span class="number">3</span>, TimeUnit.MINUTES);</span><br><span class="line"></span><br><span class="line">          <span class="keyword">this</span>.scheduledExecutorService.scheduleAtFixedRate(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">              <span class="meta">@Override</span></span><br><span class="line">              <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                  <span class="keyword">try</span> &#123;</span><br><span class="line">                      BrokerController.<span class="keyword">this</span>.printWaterMark();</span><br><span class="line">                  &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                      log.error(<span class="string">"printWaterMark error."</span>, e);</span><br><span class="line">                  &#125;</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;, <span class="number">10</span>, <span class="number">1</span>, TimeUnit.SECONDS);</span><br><span class="line">          <span class="comment">// 定时进行落后commitlog分发的任务</span></span><br><span class="line">          <span class="keyword">this</span>.scheduledExecutorService.scheduleAtFixedRate(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line"></span><br><span class="line">              <span class="meta">@Override</span></span><br><span class="line">              <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                  <span class="keyword">try</span> &#123;</span><br><span class="line">                      log.info(<span class="string">"dispatch behind commit log &#123;&#125; bytes"</span>, BrokerController.<span class="keyword">this</span>.getMessageStore().dispatchBehindBytes());</span><br><span class="line">                  &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                      log.error(<span class="string">"schedule dispatchBehindBytes error."</span>, e);</span><br><span class="line">                  &#125;</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;, <span class="number">1000</span> * <span class="number">10</span>, <span class="number">1000</span> * <span class="number">60</span>, TimeUnit.MILLISECONDS);</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (<span class="keyword">this</span>.brokerConfig.getNamesrvAddr() != <span class="keyword">null</span>) &#123;</span><br><span class="line">              <span class="comment">// 更新NameServer地址列表</span></span><br><span class="line">              <span class="keyword">this</span>.brokerOuterAPI.updateNameServerAddressList(<span class="keyword">this</span>.brokerConfig.getNamesrvAddr());</span><br><span class="line">              log.info(<span class="string">"Set user specified name server address: &#123;&#125;"</span>, <span class="keyword">this</span>.brokerConfig.getNamesrvAddr());</span><br><span class="line">          &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">this</span>.brokerConfig.isFetchNamesrvAddrByAddressServer()) &#123;</span><br><span class="line">              <span class="keyword">this</span>.scheduledExecutorService.scheduleAtFixedRate(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line"></span><br><span class="line">                  <span class="meta">@Override</span></span><br><span class="line">                  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                      <span class="keyword">try</span> &#123;</span><br><span class="line">                          <span class="comment">// 拉取NameServer地址列表</span></span><br><span class="line">                          BrokerController.<span class="keyword">this</span>.brokerOuterAPI.fetchNameServerAddr();</span><br><span class="line">                      &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                          log.error(<span class="string">"ScheduledTask fetchNameServerAddr exception"</span>, e);</span><br><span class="line">                      &#125;</span><br><span class="line">                  &#125;</span><br><span class="line">              &#125;, <span class="number">1000</span> * <span class="number">10</span>, <span class="number">1000</span> * <span class="number">60</span> * <span class="number">2</span>, TimeUnit.MILLISECONDS);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="comment">// Dleger相关的处理代码</span></span><br><span class="line">          <span class="keyword">if</span> (!messageStoreConfig.isEnableDLegerCommitLog()) &#123;</span><br><span class="line">              <span class="keyword">if</span> (BrokerRole.SLAVE == <span class="keyword">this</span>.messageStoreConfig.getBrokerRole()) &#123;</span><br><span class="line">                  <span class="keyword">if</span> (<span class="keyword">this</span>.messageStoreConfig.getHaMasterAddress() != <span class="keyword">null</span> &amp;&amp; <span class="keyword">this</span>.messageStoreConfig.getHaMasterAddress().length() &gt;= <span class="number">6</span>) &#123;</span><br><span class="line">                      <span class="keyword">this</span>.messageStore.updateHaMasterAddress(<span class="keyword">this</span>.messageStoreConfig.getHaMasterAddress());</span><br><span class="line">                      <span class="keyword">this</span>.updateMasterHAServerAddrPeriodically = <span class="keyword">false</span>;</span><br><span class="line">                  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                      <span class="keyword">this</span>.updateMasterHAServerAddrPeriodically = <span class="keyword">true</span>;</span><br><span class="line">                  &#125;</span><br><span class="line">              &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                  <span class="keyword">this</span>.scheduledExecutorService.scheduleAtFixedRate(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                      <span class="meta">@Override</span></span><br><span class="line">                      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                          <span class="keyword">try</span> &#123;</span><br><span class="line">                              BrokerController.<span class="keyword">this</span>.printMasterAndSlaveDiff();</span><br><span class="line">                          &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                              log.error(<span class="string">"schedule printMasterAndSlaveDiff error."</span>, e);</span><br><span class="line">                          &#125;</span><br><span class="line">                      &#125;</span><br><span class="line">                  &#125;, <span class="number">1000</span> * <span class="number">10</span>, <span class="number">1000</span> * <span class="number">60</span>, TimeUnit.MILLISECONDS);</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="comment">// 先不管</span></span><br><span class="line">          <span class="keyword">if</span> (TlsSystemConfig.tlsMode != TlsMode.DISABLED) &#123;</span><br><span class="line">              <span class="comment">// Register a listener to reload SslContext</span></span><br><span class="line">              <span class="keyword">try</span> &#123;</span><br><span class="line">                  fileWatchService = <span class="keyword">new</span> FileWatchService(</span><br><span class="line">                      <span class="keyword">new</span> String[] &#123;</span><br><span class="line">                          TlsSystemConfig.tlsServerCertPath,</span><br><span class="line">                          TlsSystemConfig.tlsServerKeyPath,</span><br><span class="line">                          TlsSystemConfig.tlsServerTrustCertPath</span><br><span class="line">                      &#125;,</span><br><span class="line">                      <span class="keyword">new</span> FileWatchService.Listener() &#123;</span><br><span class="line">                          <span class="keyword">boolean</span> certChanged, keyChanged = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">                          <span class="meta">@Override</span></span><br><span class="line">                          <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onChanged</span><span class="params">(String path)</span> </span>&#123;</span><br><span class="line">                              <span class="keyword">if</span> (path.equals(TlsSystemConfig.tlsServerTrustCertPath)) &#123;</span><br><span class="line">                                  log.info(<span class="string">"The trust certificate changed, reload the ssl context"</span>);</span><br><span class="line">                                  reloadServerSslContext();</span><br><span class="line">                              &#125;</span><br><span class="line">                              <span class="keyword">if</span> (path.equals(TlsSystemConfig.tlsServerCertPath)) &#123;</span><br><span class="line">                                  certChanged = <span class="keyword">true</span>;</span><br><span class="line">                              &#125;</span><br><span class="line">                              <span class="keyword">if</span> (path.equals(TlsSystemConfig.tlsServerKeyPath)) &#123;</span><br><span class="line">                                  keyChanged = <span class="keyword">true</span>;</span><br><span class="line">                              &#125;</span><br><span class="line">                              <span class="keyword">if</span> (certChanged &amp;&amp; keyChanged) &#123;</span><br><span class="line">                                  log.info(<span class="string">"The certificate and private key changed, reload the ssl context"</span>);</span><br><span class="line">                                  certChanged = keyChanged = <span class="keyword">false</span>;</span><br><span class="line">                                  reloadServerSslContext();</span><br><span class="line">                              &#125;</span><br><span class="line">                          &#125;</span><br><span class="line"></span><br><span class="line">                          <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">reloadServerSslContext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                              ((NettyRemotingServer) remotingServer).loadSslContext();</span><br><span class="line">                              ((NettyRemotingServer) fastRemotingServer).loadSslContext();</span><br><span class="line">                          &#125;</span><br><span class="line">                      &#125;);</span><br><span class="line">              &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                  log.warn(<span class="string">"FileWatchService created error, can't load the certificate dynamically"</span>);</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="comment">// 处理事务相关的代码</span></span><br><span class="line">          initialTransaction();</span><br><span class="line">          initialAcl();</span><br><span class="line">          initialRpcHooks();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> result;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h4 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h4><p>1.start方法中启动了一系列的组件，比较核心的是Netty Server服务器的启动和BrokerOuterAPI的启动。Netty启动之后就可以接收网络请求，BrokerOuterAPI处理一些核心的功能，比如通过Netty Client向外发送请求；</p>
<p>2.向NameServer注册；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">     <span class="comment">// 启动消息存储组件</span></span><br><span class="line">     <span class="keyword">if</span> (<span class="keyword">this</span>.messageStore != <span class="keyword">null</span>) &#123;</span><br><span class="line">         <span class="keyword">this</span>.messageStore.start();</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="comment">// 启动Netty Server服务器</span></span><br><span class="line">     <span class="keyword">if</span> (<span class="keyword">this</span>.remotingServer != <span class="keyword">null</span>) &#123;</span><br><span class="line">         <span class="keyword">this</span>.remotingServer.start();</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">if</span> (<span class="keyword">this</span>.fastRemotingServer != <span class="keyword">null</span>) &#123;</span><br><span class="line">         <span class="keyword">this</span>.fastRemotingServer.start();</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="comment">// 文件相关的服务组件启动</span></span><br><span class="line">     <span class="keyword">if</span> (<span class="keyword">this</span>.fileWatchService != <span class="keyword">null</span>) &#123;</span><br><span class="line">         <span class="keyword">this</span>.fileWatchService.start();</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="comment">// 核心组件，通过Netty Client发送请求等</span></span><br><span class="line">     <span class="keyword">if</span> (<span class="keyword">this</span>.brokerOuterAPI != <span class="keyword">null</span>) &#123;</span><br><span class="line">         <span class="keyword">this</span>.brokerOuterAPI.start();</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="comment">// 先不关注</span></span><br><span class="line">     <span class="keyword">if</span> (<span class="keyword">this</span>.pullRequestHoldService != <span class="keyword">null</span>) &#123;</span><br><span class="line">         <span class="keyword">this</span>.pullRequestHoldService.start();</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">if</span> (<span class="keyword">this</span>.clientHousekeepingService != <span class="keyword">null</span>) &#123;</span><br><span class="line">         <span class="keyword">this</span>.clientHousekeepingService.start();</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">if</span> (<span class="keyword">this</span>.filterServerManager != <span class="keyword">null</span>) &#123;</span><br><span class="line">         <span class="keyword">this</span>.filterServerManager.start();</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">if</span> (!messageStoreConfig.isEnableDLegerCommitLog()) &#123;</span><br><span class="line">         startProcessorByHa(messageStoreConfig.getBrokerRole());</span><br><span class="line">         handleSlaveSynchronize(messageStoreConfig.getBrokerRole());</span><br><span class="line">         <span class="keyword">this</span>.registerBrokerAll(<span class="keyword">true</span>, <span class="keyword">false</span>, <span class="keyword">true</span>);</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="comment">// 定时任务向NameServer注册</span></span><br><span class="line">     <span class="keyword">this</span>.scheduledExecutorService.scheduleAtFixedRate(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line"></span><br><span class="line">         <span class="meta">@Override</span></span><br><span class="line">         <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">             <span class="keyword">try</span> &#123;</span><br><span class="line">                 <span class="comment">// 向NameServer注册</span></span><br><span class="line">                 BrokerController.<span class="keyword">this</span>.registerBrokerAll(<span class="keyword">true</span>, <span class="keyword">false</span>, brokerConfig.isForceRegister());</span><br><span class="line">             &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                 log.error(<span class="string">"registerBrokerAll Exception"</span>, e);</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;, <span class="number">1000</span> * <span class="number">10</span>, Math.max(<span class="number">10000</span>, Math.min(brokerConfig.getRegisterNameServerPeriod(), <span class="number">60000</span>)), TimeUnit.MILLISECONDS);</span><br><span class="line"></span><br><span class="line">     <span class="keyword">if</span> (<span class="keyword">this</span>.brokerStatsManager != <span class="keyword">null</span>) &#123;</span><br><span class="line">         <span class="keyword">this</span>.brokerStatsManager.start();</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">if</span> (<span class="keyword">this</span>.brokerFastFailure != <span class="keyword">null</span>) &#123;</span><br><span class="line">         <span class="keyword">this</span>.brokerFastFailure.start();</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<h4 id="服务注册"><a href="#服务注册" class="headerlink" title="服务注册"></a>服务注册</h4><p>在注册的代码中会判断是否需要注册，如果需要注册，将会通过brokerOuterAPI核心组件发送请求到NameServer进行注册，Broker会把自己注册给所有的NameServer，然后对注册的结果进行处理。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">registerBrokerAll</span><span class="params">(<span class="keyword">final</span> <span class="keyword">boolean</span> checkOrderConfig, <span class="keyword">boolean</span> oneway, <span class="keyword">boolean</span> forceRegister)</span> </span>&#123;</span><br><span class="line">     <span class="comment">// Topic配置相关的东西</span></span><br><span class="line">     TopicConfigSerializeWrapper topicConfigWrapper = <span class="keyword">this</span>.getTopicConfigManager().buildTopicConfigSerializeWrapper();</span><br><span class="line"></span><br><span class="line">     <span class="keyword">if</span> (!PermName.isWriteable(<span class="keyword">this</span>.getBrokerConfig().getBrokerPermission())</span><br><span class="line">         || !PermName.isReadable(<span class="keyword">this</span>.getBrokerConfig().getBrokerPermission())) &#123;</span><br><span class="line">         ConcurrentHashMap&lt;String, TopicConfig&gt; topicConfigTable = <span class="keyword">new</span> ConcurrentHashMap&lt;String, TopicConfig&gt;();</span><br><span class="line">         <span class="keyword">for</span> (TopicConfig topicConfig : topicConfigWrapper.getTopicConfigTable().values()) &#123;</span><br><span class="line">             TopicConfig tmp =</span><br><span class="line">                 <span class="keyword">new</span> TopicConfig(topicConfig.getTopicName(), topicConfig.getReadQueueNums(), topicConfig.getWriteQueueNums(),</span><br><span class="line">                     <span class="keyword">this</span>.brokerConfig.getBrokerPermission());</span><br><span class="line">             topicConfigTable.put(topicConfig.getTopicName(), tmp);</span><br><span class="line">         &#125;</span><br><span class="line">         topicConfigWrapper.setTopicConfigTable(topicConfigTable);</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="comment">// 判断是否需要注册</span></span><br><span class="line">     <span class="keyword">if</span> (forceRegister || needRegister(<span class="keyword">this</span>.brokerConfig.getBrokerClusterName(),</span><br><span class="line">         <span class="keyword">this</span>.getBrokerAddr(),</span><br><span class="line">         <span class="keyword">this</span>.brokerConfig.getBrokerName(),</span><br><span class="line">         <span class="keyword">this</span>.brokerConfig.getBrokerId(),</span><br><span class="line">         <span class="keyword">this</span>.brokerConfig.getRegisterBrokerTimeoutMills())) &#123;</span><br><span class="line">         <span class="comment">// 注册</span></span><br><span class="line">         doRegisterBrokerAll(checkOrderConfig, oneway, topicConfigWrapper);</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doRegisterBrokerAll</span><span class="params">(<span class="keyword">boolean</span> checkOrderConfig, <span class="keyword">boolean</span> oneway,</span></span></span><br><span class="line"><span class="function"><span class="params">     TopicConfigSerializeWrapper topicConfigWrapper)</span> </span>&#123;</span><br><span class="line">     <span class="comment">// 通过brokerOuterAPI核心组件发送请求到NameServer进行注册，Broker会把自己注册给所有的NameServer</span></span><br><span class="line">     List&lt;RegisterBrokerResult&gt; registerBrokerResultList = <span class="keyword">this</span>.brokerOuterAPI.registerBrokerAll(</span><br><span class="line">         <span class="keyword">this</span>.brokerConfig.getBrokerClusterName(),</span><br><span class="line">         <span class="keyword">this</span>.getBrokerAddr(),</span><br><span class="line">         <span class="keyword">this</span>.brokerConfig.getBrokerName(),</span><br><span class="line">         <span class="keyword">this</span>.brokerConfig.getBrokerId(),</span><br><span class="line">         <span class="keyword">this</span>.getHAServerAddr(),</span><br><span class="line">         topicConfigWrapper,</span><br><span class="line">         <span class="keyword">this</span>.filterServerManager.buildNewFilterServerList(),</span><br><span class="line">         oneway,</span><br><span class="line">         <span class="keyword">this</span>.brokerConfig.getRegisterBrokerTimeoutMills(),</span><br><span class="line">         <span class="keyword">this</span>.brokerConfig.isCompressedRegister());</span><br><span class="line">     <span class="comment">// 对注册的结果进行处理</span></span><br><span class="line">     <span class="keyword">if</span> (registerBrokerResultList.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">         RegisterBrokerResult registerBrokerResult = registerBrokerResultList.get(<span class="number">0</span>);</span><br><span class="line">         <span class="keyword">if</span> (registerBrokerResult != <span class="keyword">null</span>) &#123;</span><br><span class="line">             <span class="keyword">if</span> (<span class="keyword">this</span>.updateMasterHAServerAddrPeriodically &amp;&amp; registerBrokerResult.getHaServerAddr() != <span class="keyword">null</span>) &#123;</span><br><span class="line">                 <span class="keyword">this</span>.messageStore.updateHaMasterAddress(registerBrokerResult.getHaServerAddr());</span><br><span class="line">             &#125;</span><br><span class="line"></span><br><span class="line">             <span class="keyword">this</span>.slaveSynchronize.setMasterAddr(registerBrokerResult.getMasterAddr());</span><br><span class="line"></span><br><span class="line">             <span class="keyword">if</span> (checkOrderConfig) &#123;</span><br><span class="line">                 <span class="keyword">this</span>.getTopicConfigManager().updateOrderTopicConfig(registerBrokerResult.getKvTable());</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p><strong>Broker的启动过程简单总结：</strong></p>
<p>1.初始化相关配置参数，包括Broker的配置、Netty Client、Netty Server的配置等；</p>
<p>2.创建核心组件BrokerController，初始化了一系列的组件，并创建Netty Server和一系列的后台任务线程池，Netty Server用来接收网络请求，线程池用来调度各种任务；</p>
<p>3.启动BrokerController中的一系列的组件，并通过BrokerOuterAPI向NameServer注册；</p>
<p><img src="/images/broker启动.jpg" alt=""> </p>
<p>注：图片来自于儒猿技术窝-从 0 开始带你成为消息中间件实战高手</p>
<p><strong>参考</strong></p>
<p>儒猿技术窝：从 0 开始带你成为消息中间件实战高手</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/03/15/【RocketMQ】NameServer的启动/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="shan">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="SHAN">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/03/15/【RocketMQ】NameServer的启动/" itemprop="url">【RocketMQ】NameServer的启动</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2021-03-15T21:00:00+08:00">
                2021-03-15
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="NameServer"><a href="#NameServer" class="headerlink" title="NameServer"></a>NameServer</h3><p>NameServer是一个注册中心，支持Broker的注册与发现，Broker在启动的时候会向NameServer注册（服务注册），Producer和Consumer会通过NameServer拉取信息，获取Topic的路由信息（服务发现）。</p>
<h3 id="NamesrvStartup"><a href="#NamesrvStartup" class="headerlink" title="NamesrvStartup"></a>NamesrvStartup</h3><p>NameServer的启动类是NamesrvStartup。</p>
<p>1.NameServer在启动的时候会创建一个NamesrvController，它是NameServer的核心组件；</p>
<blockquote>
<p>在创建NamesrvController的方法中，主要是对一些配置信息的处理，比如在启动的时候命令行中指定了配置文件，那么就会读取这个配置文件的参数，如果没有指定，就使用默认的配置来初始化NameServer（NamesrvConfig）和Netty（NettyServerConfig）网络配置的相关参数。</p>
</blockquote>
<p>2.初始化NamesrvController，注册JVM服务器关闭时的钩子函数，以便在关闭的时候做一些处理，最后通过创建的NamesrvController启动NameServer；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NamesrvStartup</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> InternalLogger log;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Properties properties = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> CommandLine commandLine = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        main0(args);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 启动入口</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> NamesrvController <span class="title">main0</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 创建NamesrvController</span></span><br><span class="line">            NamesrvController controller = createNamesrvController(args);</span><br><span class="line">            <span class="comment">// 启动</span></span><br><span class="line">            start(controller);</span><br><span class="line">            String tip = <span class="string">"The Name Server boot success. serializeType="</span> + RemotingCommand.getSerializeTypeConfigInThisServer();</span><br><span class="line">            log.info(tip);</span><br><span class="line">            System.out.printf(<span class="string">"%s%n"</span>, tip);</span><br><span class="line">            <span class="keyword">return</span> controller;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            System.exit(-<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> NamesrvController <span class="title">createNamesrvController</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, JoranException </span>&#123;</span><br><span class="line">        System.setProperty(RemotingCommand.REMOTING_VERSION_KEY, Integer.toString(MQVersion.CURRENT_VERSION));</span><br><span class="line">        <span class="comment">//PackageConflictDetect.detectFastjson();</span></span><br><span class="line">        <span class="comment">// 启动nameserver的时候使用命令启动的，会带一下参数，这里处理命令行相关参数</span></span><br><span class="line">        Options options = ServerUtil.buildCommandlineOptions(<span class="keyword">new</span> Options());</span><br><span class="line">        commandLine = ServerUtil.parseCmdLine(<span class="string">"mqnamesrv"</span>, args, buildCommandlineOptions(options), <span class="keyword">new</span> PosixParser());</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == commandLine) &#123;</span><br><span class="line">            System.exit(-<span class="number">1</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 创建NamesrvConfig，主要是一些nameserver的相关配置参数</span></span><br><span class="line">        <span class="keyword">final</span> NamesrvConfig namesrvConfig = <span class="keyword">new</span> NamesrvConfig();</span><br><span class="line">        <span class="comment">// 创建Netty服务相关配置，主要是Netty的相关配置参数</span></span><br><span class="line">        <span class="keyword">final</span> NettyServerConfig nettyServerConfig = <span class="keyword">new</span> NettyServerConfig();</span><br><span class="line">        <span class="comment">// 设置Netty默认端口为9876</span></span><br><span class="line">        nettyServerConfig.setListenPort(<span class="number">9876</span>);</span><br><span class="line">        <span class="comment">// 如果启动的时候命令行参数中带了-c选项，也就是启动的时候指定了配置文件</span></span><br><span class="line">        <span class="keyword">if</span> (commandLine.hasOption(<span class="string">'c'</span>)) &#123;</span><br><span class="line">            String file = commandLine.getOptionValue(<span class="string">'c'</span>);</span><br><span class="line">            <span class="comment">// 读取指定的配置文件，从文件中解析参数设置到namesrvConfig和nettyServerConfig中</span></span><br><span class="line">            <span class="keyword">if</span> (file != <span class="keyword">null</span>) &#123;</span><br><span class="line">                InputStream in = <span class="keyword">new</span> BufferedInputStream(<span class="keyword">new</span> FileInputStream(file));</span><br><span class="line">                properties = <span class="keyword">new</span> Properties();</span><br><span class="line">                properties.load(in);</span><br><span class="line">                MixAll.properties2Object(properties, namesrvConfig);</span><br><span class="line">                MixAll.properties2Object(properties, nettyServerConfig);</span><br><span class="line"></span><br><span class="line">                namesrvConfig.setConfigStorePath(file);</span><br><span class="line"></span><br><span class="line">                System.out.printf(<span class="string">"load config properties file OK, %s%n"</span>, file);</span><br><span class="line">                in.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 如果带了-p参数，就会打印NameServer的所有配置信息</span></span><br><span class="line">        <span class="keyword">if</span> (commandLine.hasOption(<span class="string">'p'</span>)) &#123;</span><br><span class="line">            InternalLogger console = InternalLoggerFactory.getLogger(LoggerName.NAMESRV_CONSOLE_NAME);</span><br><span class="line">            MixAll.printObjectProperties(console, namesrvConfig);</span><br><span class="line">            MixAll.printObjectProperties(console, nettyServerConfig);</span><br><span class="line">            System.exit(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 将启动命令时所带的参数覆盖到namesrvConfig中</span></span><br><span class="line">        MixAll.properties2Object(ServerUtil.commandLine2Properties(commandLine), namesrvConfig);</span><br><span class="line">        <span class="comment">// 如果ROCKET_HOME为空，输出异常日志</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == namesrvConfig.getRocketmqHome()) &#123;</span><br><span class="line">            System.out.printf(<span class="string">"Please set the %s variable in your environment to match the location of the RocketMQ installation%n"</span>, MixAll.ROCKETMQ_HOME_ENV);</span><br><span class="line">            System.exit(-<span class="number">2</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 日志相关的设置</span></span><br><span class="line">        LoggerContext lc = (LoggerContext) LoggerFactory.getILoggerFactory();</span><br><span class="line">        JoranConfigurator configurator = <span class="keyword">new</span> JoranConfigurator();</span><br><span class="line">        configurator.setContext(lc);</span><br><span class="line">        lc.reset();</span><br><span class="line">        configurator.doConfigure(namesrvConfig.getRocketmqHome() + <span class="string">"/conf/logback_namesrv.xml"</span>);</span><br><span class="line"></span><br><span class="line">        log = InternalLoggerFactory.getLogger(LoggerName.NAMESRV_LOGGER_NAME);</span><br><span class="line">        <span class="comment">// 打印日志</span></span><br><span class="line">        MixAll.printObjectProperties(log, namesrvConfig);</span><br><span class="line">        MixAll.printObjectProperties(log, nettyServerConfig);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> NamesrvController controller = <span class="keyword">new</span> NamesrvController(namesrvConfig, nettyServerConfig);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// remember all configs to prevent discard</span></span><br><span class="line">        controller.getConfiguration().registerConfig(properties);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> controller;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 启动</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> NamesrvController <span class="title">start</span><span class="params">(<span class="keyword">final</span> NamesrvController controller)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == controller) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"NamesrvController is null"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 初始化controller</span></span><br><span class="line">        <span class="keyword">boolean</span> initResult = controller.initialize();</span><br><span class="line">        <span class="keyword">if</span> (!initResult) &#123;</span><br><span class="line">            controller.shutdown();</span><br><span class="line">            System.exit(-<span class="number">3</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 注册关闭时的钩子函数，在JVM关闭的时候做一些处理</span></span><br><span class="line">        Runtime.getRuntime().addShutdownHook(<span class="keyword">new</span> ShutdownHookThread(log, <span class="keyword">new</span> Callable&lt;Void&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> Void <span class="title">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                controller.shutdown();</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;));</span><br><span class="line">        <span class="comment">// 启动NameServer</span></span><br><span class="line">        controller.start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> controller;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="NamesrvController"><a href="#NamesrvController" class="headerlink" title="NamesrvController"></a>NamesrvController</h3><h4 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h4><p>NmaeServer作为一个注册中心，是需要接收Broker的注册，以及Producer和Consumer的数据拉取，NameServer必然要启动一个服务器接收这些请求，所以初始化代码中，主要是初始化Netty服务器，和一些定时任务线程池。</p>
<p>进入controller.initialize()方法，看一下初始化的代码:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NamesrvController</span> </span>&#123;</span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">initialize</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 加载一些kv配置数据</span></span><br><span class="line">        <span class="keyword">this</span>.kvConfigManager.load();</span><br><span class="line">        <span class="comment">// 创建NettyRemotingServer,初始化Netty服务器</span></span><br><span class="line">        <span class="keyword">this</span>.remotingServer = <span class="keyword">new</span> NettyRemotingServer(<span class="keyword">this</span>.nettyServerConfig, <span class="keyword">this</span>.brokerHousekeepingService);</span><br><span class="line">        <span class="comment">// 设置netty服务器的工作线程池</span></span><br><span class="line">        <span class="keyword">this</span>.remotingExecutor =</span><br><span class="line">            Executors.newFixedThreadPool(nettyServerConfig.getServerWorkerThreads(), <span class="keyword">new</span> ThreadFactoryImpl(<span class="string">"RemotingExecutorThread_"</span>));</span><br><span class="line">        <span class="comment">// 注册处理器，先不管</span></span><br><span class="line">        <span class="keyword">this</span>.registerProcessor();</span><br><span class="line">        <span class="comment">// 定时任务线程池，启动了routeInfoManager的扫描不活跃的Broker方法</span></span><br><span class="line">        <span class="keyword">this</span>.scheduledExecutorService.scheduleAtFixedRate(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                NamesrvController.<span class="keyword">this</span>.routeInfoManager.scanNotActiveBroker();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="number">5</span>, <span class="number">10</span>, TimeUnit.SECONDS);</span><br><span class="line">        <span class="comment">// 定时任务，打印KV配置信息</span></span><br><span class="line">        <span class="keyword">this</span>.scheduledExecutorService.scheduleAtFixedRate(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                NamesrvController.<span class="keyword">this</span>.kvConfigManager.printAllPeriodically();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="number">1</span>, <span class="number">10</span>, TimeUnit.MINUTES);</span><br><span class="line">        <span class="comment">// 先不管</span></span><br><span class="line">        <span class="keyword">if</span> (TlsSystemConfig.tlsMode != TlsMode.DISABLED) &#123;</span><br><span class="line">            <span class="comment">// Register a listener to reload SslContext</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                fileWatchService = <span class="keyword">new</span> FileWatchService(</span><br><span class="line">                    <span class="keyword">new</span> String[] &#123;</span><br><span class="line">                        TlsSystemConfig.tlsServerCertPath,</span><br><span class="line">                        TlsSystemConfig.tlsServerKeyPath,</span><br><span class="line">                        TlsSystemConfig.tlsServerTrustCertPath</span><br><span class="line">                    &#125;,</span><br><span class="line">                    <span class="keyword">new</span> FileWatchService.Listener() &#123;</span><br><span class="line">                        <span class="keyword">boolean</span> certChanged, keyChanged = <span class="keyword">false</span>;</span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onChanged</span><span class="params">(String path)</span> </span>&#123;</span><br><span class="line">                            <span class="keyword">if</span> (path.equals(TlsSystemConfig.tlsServerTrustCertPath)) &#123;</span><br><span class="line">                                log.info(<span class="string">"The trust certificate changed, reload the ssl context"</span>);</span><br><span class="line">                                reloadServerSslContext();</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">if</span> (path.equals(TlsSystemConfig.tlsServerCertPath)) &#123;</span><br><span class="line">                                certChanged = <span class="keyword">true</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">if</span> (path.equals(TlsSystemConfig.tlsServerKeyPath)) &#123;</span><br><span class="line">                                keyChanged = <span class="keyword">true</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">if</span> (certChanged &amp;&amp; keyChanged) &#123;</span><br><span class="line">                                log.info(<span class="string">"The certificate and private key changed, reload the ssl context"</span>);</span><br><span class="line">                                certChanged = keyChanged = <span class="keyword">false</span>;</span><br><span class="line">                                reloadServerSslContext();</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">reloadServerSslContext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                            ((NettyRemotingServer) remotingServer).loadSslContext();</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                log.warn(<span class="string">"FileWatchService created error, can't load the certificate dynamically"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h4><p>初始化Controller之后就可以启动NameServer了，其实主要就是启动Netty服务器：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 启动NameServer</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="comment">// 启动Netty服务器</span></span><br><span class="line">    <span class="keyword">this</span>.remotingServer.start();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.fileWatchService != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">this</span>.fileWatchService.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>NettyRemotingServer</strong></p>
<p>进入NettyRemotingServer的start的方法，这里主要是Netty相关的代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NettyRemotingServer</span> <span class="keyword">extends</span> <span class="title">NettyRemotingAbstract</span> <span class="keyword">implements</span> <span class="title">RemotingServer</span> </span>&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.defaultEventExecutorGroup = <span class="keyword">new</span> DefaultEventExecutorGroup(</span><br><span class="line">            nettyServerConfig.getServerWorkerThreads(),</span><br><span class="line">            <span class="keyword">new</span> ThreadFactory() &#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">private</span> AtomicInteger threadIndex = <span class="keyword">new</span> AtomicInteger(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> Thread <span class="title">newThread</span><span class="params">(Runnable r)</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">new</span> Thread(r, <span class="string">"NettyServerCodecThread_"</span> + <span class="keyword">this</span>.threadIndex.incrementAndGet());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">        prepareSharableHandlers();</span><br><span class="line"></span><br><span class="line">        ServerBootstrap childHandler =</span><br><span class="line">            <span class="keyword">this</span>.serverBootstrap.group(<span class="keyword">this</span>.eventLoopGroupBoss, <span class="keyword">this</span>.eventLoopGroupSelector)</span><br><span class="line">                .channel(useEpoll() ? EpollServerSocketChannel.class : NioServerSocketChannel.class)</span><br><span class="line">                .option(ChannelOption.SO_BACKLOG, <span class="number">1024</span>)</span><br><span class="line">                .option(ChannelOption.SO_REUSEADDR, <span class="keyword">true</span>)</span><br><span class="line">                .option(ChannelOption.SO_KEEPALIVE, <span class="keyword">false</span>)</span><br><span class="line">                .childOption(ChannelOption.TCP_NODELAY, <span class="keyword">true</span>)</span><br><span class="line">                .childOption(ChannelOption.SO_SNDBUF, nettyServerConfig.getServerSocketSndBufSize())</span><br><span class="line">                .childOption(ChannelOption.SO_RCVBUF, nettyServerConfig.getServerSocketRcvBufSize())</span><br><span class="line">                .localAddress(<span class="keyword">new</span> InetSocketAddress(<span class="keyword">this</span>.nettyServerConfig.getListenPort()))</span><br><span class="line">                .childHandler(<span class="keyword">new</span> ChannelInitializer&lt;SocketChannel&gt;() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initChannel</span><span class="params">(SocketChannel ch)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                        ch.pipeline()</span><br><span class="line">                            .addLast(defaultEventExecutorGroup, HANDSHAKE_HANDLER_NAME, handshakeHandler)</span><br><span class="line">                            .addLast(defaultEventExecutorGroup,</span><br><span class="line">                                encoder,</span><br><span class="line">                                <span class="keyword">new</span> NettyDecoder(),</span><br><span class="line">                                <span class="keyword">new</span> IdleStateHandler(<span class="number">0</span>, <span class="number">0</span>, nettyServerConfig.getServerChannelMaxIdleTimeSeconds()),</span><br><span class="line">                                connectionManageHandler,</span><br><span class="line">                                serverHandler</span><br><span class="line">                            );</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (nettyServerConfig.isServerPooledByteBufAllocatorEnable()) &#123;</span><br><span class="line">            childHandler.childOption(ChannelOption.ALLOCATOR, PooledByteBufAllocator.DEFAULT);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ChannelFuture sync = <span class="keyword">this</span>.serverBootstrap.bind().sync();</span><br><span class="line">            InetSocketAddress addr = (InetSocketAddress) sync.channel().localAddress();</span><br><span class="line">            <span class="keyword">this</span>.port = addr.getPort();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e1) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"this.serverBootstrap.bind().sync() InterruptedException"</span>, e1);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.channelEventListener != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">this</span>.nettyEventExecutor.start();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.timer.scheduleAtFixedRate(<span class="keyword">new</span> TimerTask() &#123;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    NettyRemotingServer.<span class="keyword">this</span>.scanResponseTable();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                    log.error(<span class="string">"scanResponseTable exception"</span>, e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="number">1000</span> * <span class="number">3</span>, <span class="number">1000</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>总结</strong></p>
<p>NameServer的启动主要就是初始化相关配置参数，构建一个基于Netty的网络服务器，启动Netty服务器，接收Broker和Producer、Consumer的网络请求，进行网络通信。</p>
<p><img src="/images/nameserver启动.jpg" alt=""> </p>
<p>注：图片来自于儒猿技术窝-从 0 开始带你成为消息中间件实战高手</p>
<p><strong>参考</strong></p>
<p>儒猿技术窝：从 0 开始带你成为消息中间件实战高手</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/02/13/Ribbon调用过程/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="shan">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="SHAN">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/02/13/Ribbon调用过程/" itemprop="url">Ribbon调用过程</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2021-02-13T22:00:00+08:00">
                2021-02-13
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="负载均衡的实现方式"><a href="#负载均衡的实现方式" class="headerlink" title="负载均衡的实现方式"></a>负载均衡的实现方式</h2><h3 id="RibbonClient"><a href="#RibbonClient" class="headerlink" title="@RibbonClient"></a>@RibbonClient</h3><h3 id="LoadBalanced"><a href="#LoadBalanced" class="headerlink" title="@LoadBalanced"></a>@LoadBalanced</h3><p>@LoadBalanced实现负载均衡的代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableEurekaClient</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServiceribbonApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(ServiceribbonApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@LoadBalanced</span></span><br><span class="line">    <span class="function">RestTemplate <span class="title">restTemplate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RestTemplate();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>restTemplate调用：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    RestTemplate restTemplate;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span>  String <span class="title">helloService</span><span class="params">(String name)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> restTemplate.getForObject(<span class="string">"http://SERVICE-HI/hello?name="</span>+name,String.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>@LoadBalanced注解的原理可参考：</p>
<p>胖波：<a href="https://blog.csdn.net/xl_1803/article/details/109547421" target="_blank" rel="noopener">Ribbon中@LoadBalanced注解的原理</a></p>
<h2 id="Robbon负载均衡源码分析"><a href="#Robbon负载均衡源码分析" class="headerlink" title="Robbon负载均衡源码分析"></a>Robbon负载均衡源码分析</h2><h3 id="RestTemplate"><a href="#RestTemplate" class="headerlink" title="RestTemplate"></a>RestTemplate</h3><p>进入restTemplate的getForObject方法，进行一系列的调用，最终会进入到doExecute方法中，将请求信息封装为ClientHttpRequest对象，调用它的execute方法执行请求：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RestTemplate</span> <span class="keyword">extends</span> <span class="title">InterceptingHttpAccessor</span> <span class="keyword">implements</span> <span class="title">RestOperations</span> </span>&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">getForObject</span><span class="params">(String url, Class&lt;T&gt; responseType, Object... uriVariables)</span> <span class="keyword">throws</span> RestClientException </span>&#123;</span><br><span class="line">        RequestCallback requestCallback = <span class="keyword">this</span>.acceptHeaderRequestCallback(responseType);</span><br><span class="line">        HttpMessageConverterExtractor&lt;T&gt; responseExtractor = <span class="keyword">new</span> HttpMessageConverterExtractor(responseType, <span class="keyword">this</span>.getMessageConverters(), <span class="keyword">this</span>.logger);</span><br><span class="line">        <span class="comment">// 调用了execute方法</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.execute(url, HttpMethod.GET, requestCallback, responseExtractor, (Object[])uriVariables);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">execute</span><span class="params">(String url, HttpMethod method, @Nullable RequestCallback requestCallback, @Nullable ResponseExtractor&lt;T&gt; responseExtractor, Object... uriVariables)</span> <span class="keyword">throws</span> RestClientException </span>&#123;</span><br><span class="line">        URI expanded = <span class="keyword">this</span>.getUriTemplateHandler().expand(url, uriVariables);</span><br><span class="line">        <span class="comment">// 调用doExecute方法</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.doExecute(expanded, method, requestCallback, responseExtractor);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="keyword">protected</span> &lt;T&gt; <span class="function">T <span class="title">doExecute</span><span class="params">(URI url, @Nullable HttpMethod method, @Nullable RequestCallback requestCallback,</span></span></span><br><span class="line"><span class="function"><span class="params">            @Nullable ResponseExtractor&lt;T&gt; responseExtractor)</span> <span class="keyword">throws</span> RestClientException </span>&#123;</span><br><span class="line"></span><br><span class="line">        Assert.notNull(url, <span class="string">"URI is required"</span>);</span><br><span class="line">        Assert.notNull(method, <span class="string">"HttpMethod is required"</span>);</span><br><span class="line">        ClientHttpResponse response = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 封装请求</span></span><br><span class="line">            ClientHttpRequest request = createRequest(url, method);</span><br><span class="line">            <span class="keyword">if</span> (requestCallback != <span class="keyword">null</span>) &#123;</span><br><span class="line">                requestCallback.doWithRequest(request);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 调用execute方法执行请求</span></span><br><span class="line">            response = request.execute();</span><br><span class="line">            handleResponse(url, method, response);</span><br><span class="line">            <span class="keyword">return</span> (responseExtractor != <span class="keyword">null</span> ? responseExtractor.extractData(response) : <span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">            String resource = url.toString();</span><br><span class="line">            String query = url.getRawQuery();</span><br><span class="line">            resource = (query != <span class="keyword">null</span> ? resource.substring(<span class="number">0</span>, resource.indexOf(<span class="string">'?'</span>)) : resource);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ResourceAccessException(<span class="string">"I/O error on "</span> + method.name() +</span><br><span class="line">                    <span class="string">" request for \""</span> + resource + <span class="string">"\": "</span> + ex.getMessage(), ex);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (response != <span class="keyword">null</span>) &#123;</span><br><span class="line">                response.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>HttpAccessor</strong></p>
<p>调用createRequest方法是在HttpAccessor类中实现的，在该方法中调用了getRequestFactory获取RequestFactory，由于RestTemplate继承了InterceptingHttpAccessor，InterceptingHttpAccessor又继承了HttpAccessor，所以执行getRequestFactory的时候会进入到InterceptingHttpAccessor的getRequestFactory创建请求：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">HttpAccessor</span> </span>&#123; </span><br><span class="line">    <span class="comment">// 默认是SimpleClientHttpRequestFactory</span></span><br><span class="line">    <span class="keyword">private</span> ClientHttpRequestFactory requestFactory = <span class="keyword">new</span> SimpleClientHttpRequestFactory();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 使用工厂模式创建ClientHttpRequest</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> ClientHttpRequest <span class="title">createRequest</span><span class="params">(URI url, HttpMethod method)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        ClientHttpRequest request = getRequestFactory().createRequest(url, method);</span><br><span class="line">        <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">            logger.debug(<span class="string">"HTTP "</span> + method.name() + <span class="string">" "</span> + url);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> request;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>InterceptingHttpAccessor</strong></p>
<p>在InterceptingHttpAccessor中的getRequestFactory中，会判断拦截器是否为空，如果不为空判断当前RequestFactory是否为空，如果为空将创建一个InterceptingClientHttpRequestFactory类型的工厂：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">InterceptingHttpAccessor</span> <span class="keyword">extends</span> <span class="title">HttpAccessor</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ClientHttpRequestFactory <span class="title">getRequestFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 获取拦截器</span></span><br><span class="line">        List&lt;ClientHttpRequestInterceptor&gt; interceptors = getInterceptors();</span><br><span class="line">        <span class="comment">// 如果拦截器不为空</span></span><br><span class="line">        <span class="keyword">if</span> (!CollectionUtils.isEmpty(interceptors)) &#123;</span><br><span class="line">            ClientHttpRequestFactory factory = <span class="keyword">this</span>.interceptingRequestFactory;</span><br><span class="line">            <span class="comment">// 如果factory为空</span></span><br><span class="line">            <span class="keyword">if</span> (factory == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// 创建InterceptingClientHttpRequestFactory</span></span><br><span class="line">                factory = <span class="keyword">new</span> InterceptingClientHttpRequestFactory(<span class="keyword">super</span>.getRequestFactory(), interceptors);</span><br><span class="line">                <span class="keyword">this</span>.interceptingRequestFactory = factory;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> factory;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">super</span>.getRequestFactory();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>InterceptingClientHttpRequestFactory</strong></p>
<p>InterceptingClientHttpRequestFactory当然创建的是InterceptingClientHttpRequest类型的请求类，所以最终会进入到InterceptingClientHttpRequest的execute方法中：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InterceptingClientHttpRequestFactory</span> <span class="keyword">extends</span> <span class="title">AbstractClientHttpRequestFactoryWrapper</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;ClientHttpRequestInterceptor&gt; interceptors;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> ClientHttpRequest <span class="title">createRequest</span><span class="params">(URI uri, HttpMethod httpMethod, ClientHttpRequestFactory requestFactory)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> InterceptingClientHttpRequest(requestFactory, <span class="keyword">this</span>.interceptors, uri, httpMethod);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="InterceptingClientHttpRequest"><a href="#InterceptingClientHttpRequest" class="headerlink" title="InterceptingClientHttpRequest"></a>InterceptingClientHttpRequest</h3><p>InterceptingClientHttpRequest继承了AbstractClientHttpRequest，它们都是ClientHttpRequest的子类,InterceptingClientHttpRequest中有一个内部类InterceptingRequestExecution，它有一个拦截器类型的ClientHttpRequestInterceptor迭代器iterator，还实现了execute方法，在execute方法中会获取拦截器，对请求进行拦截:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">InterceptingClientHttpRequest</span> <span class="keyword">extends</span> <span class="title">AbstractBufferingClientHttpRequest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">InterceptingRequestExecution</span> <span class="keyword">implements</span> <span class="title">ClientHttpRequestExecution</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> Iterator&lt;ClientHttpRequestInterceptor&gt; iterator;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">InterceptingRequestExecution</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.iterator = interceptors.iterator();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> ClientHttpResponse <span class="title">execute</span><span class="params">(HttpRequest request, <span class="keyword">byte</span>[] body)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.iterator.hasNext()) &#123;</span><br><span class="line">                <span class="comment">// 获取拦截器</span></span><br><span class="line">                ClientHttpRequestInterceptor nextInterceptor = <span class="keyword">this</span>.iterator.next();</span><br><span class="line">                <span class="keyword">return</span> nextInterceptor.intercept(request, body, <span class="keyword">this</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                HttpMethod method = request.getMethod();</span><br><span class="line">                Assert.state(method != <span class="keyword">null</span>, <span class="string">"No standard HTTP method"</span>);</span><br><span class="line">                ClientHttpRequest delegate = requestFactory.createRequest(request.getURI(), method);</span><br><span class="line">                request.getHeaders().forEach((key, value) -&gt; delegate.getHeaders().addAll(key, value));</span><br><span class="line">                <span class="keyword">if</span> (body.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (delegate <span class="keyword">instanceof</span> StreamingHttpOutputMessage) &#123;</span><br><span class="line">                        StreamingHttpOutputMessage streamingOutputMessage = (StreamingHttpOutputMessage) delegate;</span><br><span class="line">                        streamingOutputMessage.setBody(outputStream -&gt; StreamUtils.copy(body, outputStream));</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span> &#123;</span><br><span class="line">                        StreamUtils.copy(body, delegate.getBody());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> delegate.execute();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ClientHttpRequestInterceptor的实现类如下：<br><img src="/images/interceptor.jpg" alt=""> </p>
<h3 id="LoadBalancerInterceptor"><a href="#LoadBalancerInterceptor" class="headerlink" title="LoadBalancerInterceptor"></a>LoadBalancerInterceptor</h3><p>进入到LoadBalancerInterceptor拦截器中，查看拦截器的intercept方法，在该方法中调用了LoadBalancerClient的execute方法执行请求，也就是说请求会被负载均衡拦截器所拦截，然后调用负载均衡客户端 LoadBalancerClient的execute方法执行请求：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoadBalancerInterceptor</span> <span class="keyword">implements</span> <span class="title">ClientHttpRequestInterceptor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 负载均衡客户端</span></span><br><span class="line">    <span class="keyword">private</span> LoadBalancerClient loadBalancer;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> LoadBalancerRequestFactory requestFactory;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LoadBalancerInterceptor</span><span class="params">(LoadBalancerClient loadBalancer,</span></span></span><br><span class="line"><span class="function"><span class="params">            LoadBalancerRequestFactory requestFactory)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.loadBalancer = loadBalancer;</span><br><span class="line">        <span class="keyword">this</span>.requestFactory = requestFactory;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LoadBalancerInterceptor</span><span class="params">(LoadBalancerClient loadBalancer)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// for backwards compatibility</span></span><br><span class="line">        <span class="keyword">this</span>(loadBalancer, <span class="keyword">new</span> LoadBalancerRequestFactory(loadBalancer));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ClientHttpResponse <span class="title">intercept</span><span class="params">(<span class="keyword">final</span> HttpRequest request, <span class="keyword">final</span> <span class="keyword">byte</span>[] body,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">final</span> ClientHttpRequestExecution execution)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> URI originalUri = request.getURI();</span><br><span class="line">        <span class="comment">// 获取服务名称</span></span><br><span class="line">        String serviceName = originalUri.getHost();</span><br><span class="line">        Assert.state(serviceName != <span class="keyword">null</span>,</span><br><span class="line">                <span class="string">"Request URI does not contain a valid hostname: "</span> + originalUri);</span><br><span class="line">        <span class="comment">// 调用负载均衡客户端的execute方法执行请求</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.loadBalancer.execute(serviceName,</span><br><span class="line">                <span class="keyword">this</span>.requestFactory.createRequest(request, body, execution));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="RibbonLoadBalancerClient"><a href="#RibbonLoadBalancerClient" class="headerlink" title="RibbonLoadBalancerClient"></a>RibbonLoadBalancerClient</h3><p>LoadBalancerClient是一个接口，RibbonLoadBalancerClient实现了它，在execute方法中，首先调用getLoadBalancer方法获取LoadBalancer的实现类，选取一个负载均衡实现类，默认情况下会返回ZoneAwareLoadBalancer的负载均衡器，然后调用getServer（在此方法中又调用了chooseServer），根据负载均衡规则选取一个服务，之后就知道往哪个服务上发送请求，执行发送请求操作了：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RibbonLoadBalancerClient</span> <span class="keyword">implements</span> <span class="title">LoadBalancerClient</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">execute</span><span class="params">(String serviceId, LoadBalancerRequest&lt;T&gt; request)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> execute(serviceId, request, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">execute</span><span class="params">(String serviceId, LoadBalancerRequest&lt;T&gt; request, Object hint)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="comment">// 获取LoadBalancer实现类</span></span><br><span class="line">        ILoadBalancer loadBalancer = getLoadBalancer(serviceId);</span><br><span class="line">        <span class="comment">// 根据负载均衡规则选取一个服务</span></span><br><span class="line">        Server server = getServer(loadBalancer, hint);</span><br><span class="line">        <span class="keyword">if</span> (server == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"No instances available for "</span> + serviceId);</span><br><span class="line">        &#125;</span><br><span class="line">        RibbonServer ribbonServer = <span class="keyword">new</span> RibbonServer(serviceId, server,</span><br><span class="line">                isSecure(server, serviceId),</span><br><span class="line">                serverIntrospector(serviceId).getMetadata(server));</span><br><span class="line">        <span class="comment">// 调用execute方法执行请求</span></span><br><span class="line">        <span class="keyword">return</span> execute(serviceId, ribbonServer, request);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">protected</span> ILoadBalancer <span class="title">getLoadBalancer</span><span class="params">(String serviceId)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 获取LoadBalancer实现类</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.clientFactory.getLoadBalancer(serviceId);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Server <span class="title">getServer</span><span class="params">(ILoadBalancer loadBalancer, Object hint)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (loadBalancer == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 调用chooseServer选择一个服务</span></span><br><span class="line">        <span class="keyword">return</span> loadBalancer.chooseServer(hint != <span class="keyword">null</span> ? hint : <span class="string">"default"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 执行发送请求的方法</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">execute</span><span class="params">(String serviceId, ServiceInstance serviceInstance,</span></span></span><br><span class="line"><span class="function"><span class="params">            LoadBalancerRequest&lt;T&gt; request)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        Server server = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (serviceInstance <span class="keyword">instanceof</span> RibbonServer) &#123;</span><br><span class="line">            server = ((RibbonServer) serviceInstance).getServer();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (server == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"No instances available for "</span> + serviceId);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        RibbonLoadBalancerContext context = <span class="keyword">this</span>.clientFactory</span><br><span class="line">                .getLoadBalancerContext(serviceId);</span><br><span class="line">        RibbonStatsRecorder statsRecorder = <span class="keyword">new</span> RibbonStatsRecorder(context, server);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 执行请求</span></span><br><span class="line">            T returnVal = request.apply(serviceInstance);</span><br><span class="line">            statsRecorder.recordStats(returnVal);</span><br><span class="line">            <span class="keyword">return</span> returnVal;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// catch IOException and rethrow so RestTemplate behaves correctly</span></span><br><span class="line">        <span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">            statsRecorder.recordStats(ex);</span><br><span class="line">            <span class="keyword">throw</span> ex;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">            statsRecorder.recordStats(ex);</span><br><span class="line">            ReflectionUtils.rethrowRuntimeException(ex);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="负载均衡策略"><a href="#负载均衡策略" class="headerlink" title="负载均衡策略"></a>负载均衡策略</h2><p><img src="/images/loadbalancer.jpg" alt=""></p>
<h3 id="ILoadBalancer"><a href="#ILoadBalancer" class="headerlink" title="ILoadBalancer"></a>ILoadBalancer</h3><p>ILoadBalancer是一个接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ILoadBalancer</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">addServers</span><span class="params">(List&lt;Server&gt; var1)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">Server <span class="title">chooseServer</span><span class="params">(Object var1)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">markServerDown</span><span class="params">(Server var1)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** <span class="doctag">@deprecated</span> */</span></span><br><span class="line">    <span class="meta">@Deprecated</span></span><br><span class="line">    <span class="function">List&lt;Server&gt; <span class="title">getServerList</span><span class="params">(<span class="keyword">boolean</span> var1)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">List&lt;Server&gt; <span class="title">getReachableServers</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">List&lt;Server&gt; <span class="title">getAllServers</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>BaseLoadBalancer中实现了chooseServer方法，在BaseLoadBalancer中有一个默认的负载均衡策略是RoundRobinRule：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseLoadBalancer</span> <span class="keyword">extends</span> <span class="title">AbstractLoadBalancer</span> <span class="keyword">implements</span></span></span><br><span class="line"><span class="class">        <span class="title">PrimeConnections</span>.<span class="title">PrimeConnectionListener</span>, <span class="title">IClientConfigAware</span> </span>&#123;</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> IRule DEFAULT_RULE = <span class="keyword">new</span> RoundRobinRule();</span><br><span class="line">    <span class="comment">// 默认策略RoundRobinRule</span></span><br><span class="line">    <span class="keyword">protected</span> IRule rule = DEFAULT_RULE;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Server <span class="title">chooseServer</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (counter == <span class="keyword">null</span>) &#123;</span><br><span class="line">            counter = createCounter();</span><br><span class="line">        &#125;</span><br><span class="line">        counter.increment();</span><br><span class="line">        <span class="keyword">if</span> (rule == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 选取服务</span></span><br><span class="line">                <span class="keyword">return</span> rule.choose(key);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                logger.warn(<span class="string">"LoadBalancer [&#123;&#125;]:  Error choosing server for key &#123;&#125;"</span>, name, key, e);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="七种负载均衡策略"><a href="#七种负载均衡策略" class="headerlink" title="七种负载均衡策略"></a>七种负载均衡策略</h3><ol>
<li>RoundRobinRule</li>
<li>RandomRule</li>
<li>AvailabilityFilteringRule</li>
<li>WeightedResponseTimeRule</li>
<li>RetryRule</li>
<li>BestAvailableRule</li>
<li>ZoneAvoidanceRule</li>
</ol>
<p><img src="/images/rule.jpg" alt=""> </p>
<p><strong>参考：</strong></p>
<p><a href="https://juejin.cn/book/6844733831069564941" target="_blank" rel="noopener">【掘金小册】LinkedBear:SpringCloudNetflix 源码解读与原理分析</a></p>
<p><strong>SpringBoot版本:2.1.9</strong></p>
<p><strong>SpringCloud版本: Greenwich.SR4 </strong></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/01/10/【SpringBoot】自动装配原理/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="shan">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="SHAN">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/01/10/【SpringBoot】自动装配原理/" itemprop="url">SpringBoot自动装配原理</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2021-01-10T17:30:00+08:00">
                2021-01-10
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="SpringBootApplication"><a href="#SpringBootApplication" class="headerlink" title="SpringBootApplication"></a>SpringBootApplication</h3><p>springboot项目一般都会有一个主程序入口，使用@SpringBootApplication注解标注：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringbootdemoApplication</span> <span class="keyword">implements</span> <span class="title">CommandLineRunner</span></span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		SpringApplication.run(SpringbootdemoApplication.class, args);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>点进@SpringBootApplication，可以看到又引入了其他的注解，主要关注以下几个注解：</p>
<ul>
<li>@SpringBootConfiguration</li>
<li>@ComponentScan</li>
<li>@EnableAutoConfiguration</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@Target</span>(&#123;ElementType.TYPE&#125;)</span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Inherited</span></span><br><span class="line"><span class="meta">@SpringBootConfiguration</span></span><br><span class="line"><span class="meta">@EnableAutoConfiguration</span></span><br><span class="line"><span class="meta">@ComponentScan</span>(</span><br><span class="line">    excludeFilters = &#123;<span class="meta">@Filter</span>(</span><br><span class="line">    type = FilterType.CUSTOM,</span><br><span class="line">    classes = &#123;TypeExcludeFilter.class&#125;</span><br><span class="line">), <span class="meta">@Filter</span>(</span><br><span class="line">    type = FilterType.CUSTOM,</span><br><span class="line">    classes = &#123;AutoConfigurationExcludeFilter.class&#125;</span><br><span class="line">)&#125;</span><br><span class="line">)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> SpringBootApplication &#123;</span><br><span class="line">    <span class="meta">@AliasFor</span>(</span><br><span class="line">        annotation = EnableAutoConfiguration.class</span><br><span class="line">    )</span><br><span class="line">    Class&lt;?&gt;[] exclude() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@AliasFor</span>(</span><br><span class="line">        annotation = EnableAutoConfiguration.class</span><br><span class="line">    )</span><br><span class="line">    String[] excludeName() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@AliasFor</span>(</span><br><span class="line">        annotation = ComponentScan.class,</span><br><span class="line">        attribute = <span class="string">"basePackages"</span></span><br><span class="line">    )</span><br><span class="line">    String[] scanBasePackages() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@AliasFor</span>(</span><br><span class="line">        annotation = ComponentScan.class,</span><br><span class="line">        attribute = <span class="string">"basePackageClasses"</span></span><br><span class="line">    )</span><br><span class="line">    Class&lt;?&gt;[] scanBasePackageClasses() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@AliasFor</span>(</span><br><span class="line">        annotation = ComponentScan.class,</span><br><span class="line">        attribute = <span class="string">"nameGenerator"</span></span><br><span class="line">    )</span><br><span class="line">    Class&lt;? extends BeanNameGenerator&gt; nameGenerator() <span class="keyword">default</span> BeanNameGenerator.class;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@AliasFor</span>(</span><br><span class="line">        annotation = Configuration.class</span><br><span class="line">    )</span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">proxyBeanMethods</span><span class="params">()</span> <span class="keyword">default</span> <span class="keyword">true</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="SpringBootConfiguration"><a href="#SpringBootConfiguration" class="headerlink" title="@SpringBootConfiguration"></a>@SpringBootConfiguration</h3><p>@SpringBootConfiguration比较简单，它只导入了一个@Configuration注解，所以可以理解为@SpringBootConfiguration就是一个配置类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target</span>(&#123;ElementType.TYPE&#125;)</span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> SpringBootConfiguration &#123;</span><br><span class="line">    <span class="meta">@AliasFor</span>(</span><br><span class="line">        annotation = Configuration.class</span><br><span class="line">    )</span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">proxyBeanMethods</span><span class="params">()</span> <span class="keyword">default</span> <span class="keyword">true</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="ComponentScan"><a href="#ComponentScan" class="headerlink" title="@ComponentScan"></a>@ComponentScan</h3><p>使用过Spring的应该都很熟悉了，这个注解用来配置扫描包里的文件，将符合条件的bean注册到Spring容器中。<br>excludeFilters:配置不进行扫描的过滤器。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ComponentScan</span>(</span><br><span class="line">    excludeFilters = &#123;<span class="meta">@Filter</span>(</span><br><span class="line">    type = FilterType.CUSTOM,</span><br><span class="line">    classes = &#123;TypeExcludeFilter.class&#125;</span><br><span class="line">), <span class="meta">@Filter</span>(</span><br><span class="line">    type = FilterType.CUSTOM,</span><br><span class="line">    classes = &#123;AutoConfigurationExcludeFilter.class&#125;</span><br><span class="line">)&#125;</span><br></pre></td></tr></table></figure>
<h3 id="EnableAutoConfiguration"><a href="#EnableAutoConfiguration" class="headerlink" title="@EnableAutoConfiguration"></a>@EnableAutoConfiguration</h3><p>@EnableAutoConfiguration是SpringBoot自动装配的核心，它由@AutoConfigurationPackage和@Import组成，@Import导入了AutoConfigurationImportSelector类：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">@Target(&#123;ElementType.TYPE&#125;)</span><br><span class="line">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="line">@Documented</span><br><span class="line">@Inherited</span><br><span class="line">@AutoConfigurationPackage</span><br><span class="line">@Import(&#123;AutoConfigurationImportSelector.class&#125;)</span><br><span class="line">public @interface EnableAutoConfiguration &#123;</span><br><span class="line">    String ENABLED_OVERRIDE_PROPERTY = &quot;spring.boot.enableautoconfiguration&quot;;</span><br><span class="line"></span><br><span class="line">    Class&lt;?&gt;[] exclude() default &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    String[] excludeName() default &#123;&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="AutoConfigurationPackages"><a href="#AutoConfigurationPackages" class="headerlink" title="@AutoConfigurationPackages"></a>@AutoConfigurationPackages</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target</span>(&#123;ElementType.TYPE&#125;)</span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Inherited</span></span><br><span class="line"><span class="meta">@Import</span>(&#123;Registrar.class&#125;)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> AutoConfigurationPackage &#123;</span><br><span class="line">    String[] basePackages() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    Class&lt;?&gt;[] basePackageClasses() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>AutoConfigurationPackages表示使用该注解的类所在的包会被加入到自动扫描package中，也就是SpringBoot会将主程序类所在的包及其下面的所有子包下的组件扫描到Spring容器中，主要是通过导入Registrar类实现的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Registrar</span> <span class="keyword">implements</span> <span class="title">ImportBeanDefinitionRegistrar</span>, <span class="title">DeterminableImports</span> </span>&#123;</span><br><span class="line">       Registrar() &#123;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerBeanDefinitions</span><span class="params">(AnnotationMetadata metadata, BeanDefinitionRegistry registry)</span> </span>&#123;</span><br><span class="line">           AutoConfigurationPackages.register(registry, (String[])(<span class="keyword">new</span> AutoConfigurationPackages.PackageImports(metadata)).getPackageNames().toArray(<span class="keyword">new</span> String[<span class="number">0</span>]));</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="function"><span class="keyword">public</span> Set&lt;Object&gt; <span class="title">determineImports</span><span class="params">(AnnotationMetadata metadata)</span> </span>&#123;</span><br><span class="line">           <span class="keyword">return</span> Collections.singleton(<span class="keyword">new</span> AutoConfigurationPackages.PackageImports(metadata));</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<h4 id="AutoConfigurationImportSelector"><a href="#AutoConfigurationImportSelector" class="headerlink" title="AutoConfigurationImportSelector"></a>AutoConfigurationImportSelector</h4><p>在AutoConfigurationImportSelector的selectImports方法中，调用了getAutoConfigurationEntry方法，在getAutoConfigurationEntry又调用了getCandidateConfigurations，获取所有候选的配置：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AutoConfigurationImportSelector</span> <span class="keyword">implements</span> <span class="title">DeferredImportSelector</span>, <span class="title">BeanClassLoaderAware</span>, <span class="title">ResourceLoaderAware</span>, <span class="title">BeanFactoryAware</span>, <span class="title">EnvironmentAware</span>, <span class="title">Ordered</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> String[] selectImports(AnnotationMetadata annotationMetadata) &#123;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="keyword">this</span>.isEnabled(annotationMetadata)) &#123;</span><br><span class="line">            <span class="keyword">return</span> NO_IMPORTS;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 调用getAutoConfigurationEntry方法</span></span><br><span class="line">            AutoConfigurationImportSelector.AutoConfigurationEntry autoConfigurationEntry = <span class="keyword">this</span>.getAutoConfigurationEntry(annotationMetadata);</span><br><span class="line">            <span class="keyword">return</span> StringUtils.toStringArray(autoConfigurationEntry.getConfigurations());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">protected</span> AutoConfigurationImportSelector.<span class="function">AutoConfigurationEntry <span class="title">getAutoConfigurationEntry</span><span class="params">(AnnotationMetadata annotationMetadata)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="keyword">this</span>.isEnabled(annotationMetadata)) &#123;</span><br><span class="line">            <span class="keyword">return</span> EMPTY_ENTRY;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            AnnotationAttributes attributes = <span class="keyword">this</span>.getAttributes(annotationMetadata);</span><br><span class="line">            <span class="comment">// 调用getCandidateConfigurations，获取所有候选的配置</span></span><br><span class="line">            List&lt;String&gt; configurations = <span class="keyword">this</span>.getCandidateConfigurations(annotationMetadata, attributes);</span><br><span class="line">            configurations = <span class="keyword">this</span>.removeDuplicates(configurations);</span><br><span class="line">            Set&lt;String&gt; exclusions = <span class="keyword">this</span>.getExclusions(annotationMetadata, attributes);</span><br><span class="line">            <span class="keyword">this</span>.checkExcludedClasses(configurations, exclusions);</span><br><span class="line">            configurations.removeAll(exclusions);</span><br><span class="line">            configurations = <span class="keyword">this</span>.getConfigurationClassFilter().filter(configurations);</span><br><span class="line">            <span class="keyword">this</span>.fireAutoConfigurationImportEvents(configurations, exclusions);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> AutoConfigurationImportSelector.AutoConfigurationEntry(configurations, exclusions);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 获取所有候选的配置</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> List&lt;String&gt; <span class="title">getCandidateConfigurations</span><span class="params">(AnnotationMetadata metadata, AnnotationAttributes attributes)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// SpringFactoriesLoader.loadFactoryNames可以获取指定类的自动配置类</span></span><br><span class="line">        List&lt;String&gt; configurations = SpringFactoriesLoader.loadFactoryNames(<span class="keyword">this</span>.getSpringFactoriesLoaderFactoryClass(), <span class="keyword">this</span>.getBeanClassLoader());</span><br><span class="line">        Assert.notEmpty(configurations, <span class="string">"No auto configuration classes found in META-INF/spring.factories. If you are using a custom packaging, make sure that file is correct."</span>);</span><br><span class="line">        <span class="keyword">return</span> configurations;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>
<p>在getCandidateConfigurations中，有一步是调用loadFactoryNames，并且传入了两个参数，其中有一个是通过getSpringFactoriesLoaderFactoryClass返回的EnableAutoConfiguration类，另外一个传入的是类的加载器：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 返回EnableAutoConfiguration类</span></span><br><span class="line">  <span class="keyword">protected</span> Class&lt;?&gt; getSpringFactoriesLoaderFactoryClass() &#123;</span><br><span class="line">      <span class="keyword">return</span> EnableAutoConfiguration.class;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 返回类的加载器</span></span><br><span class="line">  <span class="function"><span class="keyword">protected</span> ClassLoader <span class="title">getBeanClassLoader</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">this</span>.beanClassLoader;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></p>
<p>再进入到SpringFactoriesLoader的loadFactoryNames方法，主要的处理在loadSpringFactories方法中，在这个方法中，先通过给定的类的加载器从缓存中获取对应的自动配置类，如果不为空直接返回接口，如果为空，根据指定的类加载器加载META-INF下的spring.factories文件(使用了SPI机制)，然后将内容解析放到Map中，并加入到缓存中，之后就可以根据类的加载器名称获取对应自动配置类，加载到Spring容器中：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringFactoriesLoader</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    ......</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;String&gt; <span class="title">loadFactoryNames</span><span class="params">(Class&lt;?&gt; factoryType, @Nullable ClassLoader classLoader)</span> </span>&#123;</span><br><span class="line">        ClassLoader classLoaderToUse = classLoader;</span><br><span class="line">        <span class="keyword">if</span>(classLoader == <span class="keyword">null</span>) &#123;</span><br><span class="line">            classLoaderToUse = SpringFactoriesLoader.class.getClassLoader();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        String factoryTypeName = factoryType.getName();</span><br><span class="line">        <span class="keyword">return</span> (List)loadSpringFactories(classLoaderToUse).getOrDefault(factoryTypeName, Collections.emptyList());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Map&lt;String, List&lt;String&gt;&gt; loadSpringFactories(ClassLoader classLoader) &#123;</span><br><span class="line">        <span class="comment">// 根据当前的类加载器，从缓存中获取数据</span></span><br><span class="line">        Map&lt;String, List&lt;String&gt;&gt; result = (Map)cache.get(classLoader);</span><br><span class="line">        <span class="keyword">if</span>(result != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            HashMap result = <span class="keyword">new</span> HashMap();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 通过给定的类加载器从META-INF下的spring.factories文件</span></span><br><span class="line">                Enumeration urls = classLoader.getResources(<span class="string">"META-INF/spring.factories"</span>);</span><br><span class="line">                <span class="comment">// 解析spring.factories文件的内容</span></span><br><span class="line">                <span class="keyword">while</span>(urls.hasMoreElements()) &#123;</span><br><span class="line">                    URL url = (URL)urls.nextElement();</span><br><span class="line">                    UrlResource resource = <span class="keyword">new</span> UrlResource(url);</span><br><span class="line">                    Properties properties = PropertiesLoaderUtils.loadProperties(resource);</span><br><span class="line">                    Iterator var6 = properties.entrySet().iterator();</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">while</span>(var6.hasNext()) &#123;</span><br><span class="line">                        Entry&lt;?, ?&gt; entry = (Entry)var6.next();</span><br><span class="line">                        </span><br><span class="line">                        String factoryTypeName = ((String)entry.getKey()).trim();</span><br><span class="line">                        String[] factoryImplementationNames = StringUtils.commaDelimitedListToStringArray((String)entry.getValue());</span><br><span class="line">                        String[] var10 = factoryImplementationNames;</span><br><span class="line">                        <span class="keyword">int</span> var11 = factoryImplementationNames.length;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">for</span>(<span class="keyword">int</span> var12 = <span class="number">0</span>; var12 &lt; var11; ++var12) &#123;</span><br><span class="line">                            <span class="comment">// 将spring.factories文件的内容解析放入到result中</span></span><br><span class="line">                            String factoryImplementationName = var10[var12];</span><br><span class="line">                            ((List)result.computeIfAbsent(factoryTypeName, (key) -&gt; &#123;</span><br><span class="line">                                <span class="keyword">return</span> <span class="keyword">new</span> ArrayList();</span><br><span class="line">                            &#125;)).add(factoryImplementationName.trim());</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                result.replaceAll((factoryType, implementations) -&gt; &#123;</span><br><span class="line">                    <span class="keyword">return</span> (List)implementations.stream().distinct().collect(Collectors.collectingAndThen(Collectors.toList(), Collections::unmodifiableList));</span><br><span class="line">                &#125;);</span><br><span class="line">                <span class="comment">// 将result的内容加入到缓存中</span></span><br><span class="line">                cache.put(classLoader, result);</span><br><span class="line">                <span class="keyword">return</span> result;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException var14) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Unable to load factories from location [META-INF/spring.factories]"</span>, var14);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>选取了spring-boot-autoconfiguer下的spring.factories文件内容，key为接口名称，value为对应的自动装配类：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"># Application Listeners</span><br><span class="line">org.springframework.context.ApplicationListener=\</span><br><span class="line">org.springframework.boot.autoconfigure.BackgroundPreinitializer</span><br><span class="line"></span><br><span class="line"># Auto Configuration Import Listeners</span><br><span class="line">org.springframework.boot.autoconfigure.AutoConfigurationImportListener=\</span><br><span class="line">org.springframework.boot.autoconfigure.condition.ConditionEvaluationReportAutoConfigurationImportListener</span><br><span class="line"></span><br><span class="line"># Auto Configuration Import Filters</span><br><span class="line">org.springframework.boot.autoconfigure.AutoConfigurationImportFilter=\</span><br><span class="line">org.springframework.boot.autoconfigure.condition.OnBeanCondition,\</span><br><span class="line">org.springframework.boot.autoconfigure.condition.OnClassCondition,\</span><br><span class="line">org.springframework.boot.autoconfigure.condition.OnWebApplicationCondition</span><br><span class="line"></span><br><span class="line"># Auto Configure</span><br><span class="line">org.springframework.boot.autoconfigure.EnableAutoConfiguration=\</span><br><span class="line">org.springframework.boot.autoconfigure.admin.SpringApplicationAdminJmxAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.aop.AopAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.amqp.RabbitAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.batch.BatchAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.cache.CacheAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.cassandra.CassandraAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.context.ConfigurationPropertiesAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.context.LifecycleAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.context.MessageSourceAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.context.PropertyPlaceholderAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.couchbase.CouchbaseAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.dao.PersistenceExceptionTranslationAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.cassandra.CassandraDataAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.cassandra.CassandraReactiveDataAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.cassandra.CassandraReactiveRepositoriesAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.cassandra.CassandraRepositoriesAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.couchbase.CouchbaseDataAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.couchbase.CouchbaseReactiveDataAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.couchbase.CouchbaseReactiveRepositoriesAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.couchbase.CouchbaseRepositoriesAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.elasticsearch.ElasticsearchDataAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.elasticsearch.ElasticsearchRepositoriesAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.elasticsearch.ReactiveElasticsearchRepositoriesAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.elasticsearch.ReactiveElasticsearchRestClientAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.jdbc.JdbcRepositoriesAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.jpa.JpaRepositoriesAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.ldap.LdapRepositoriesAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.mongo.MongoDataAutoConfiguration,\</span><br></pre></td></tr></table></figure></p>
<p>回到getCandidateConfigurations方法中，调用loadFactoryNames方法时传入的类为EnableAutoConfiguration类，所以loadFactoryNames最终可以根据传入的类加载器，从缓存中获取EnableAutoConfiguration在spring.factories中对应的自动配置类（如果缓存中没有获取到，就去加载spring.factories文件并解析后放入缓存），之后将自动配置类导入Spring容器，自动配置类生效，完成自动装配。</p>
<p><strong>参考：</strong><br><a href="https://juejin.cn/book/6844733814560784397" target="_blank" rel="noopener">掘金小册-SpringBoot 源码解读与原理分析</a><br><a href="https://cloud.tencent.com/developer/article/1510727" target="_blank" rel="noopener">SpringBoot自动装配原理解析</a><br><a href="https://juejin.cn/post/6844904009577267207" target="_blank" rel="noopener">SpringBoot自动装配原理初探</a><br><a href="https://zhuanlan.zhihu.com/p/136469945" target="_blank" rel="noopener">SpringBoot自动配置的原理详解</a><br><a href="https://my.oschina.net/u/3872757/blog/3059922" target="_blank" rel="noopener">SpringBoot 2.X课程学习 | 第三篇：自动配置（Auto-configuration）</a></p>
<p><strong>SpringBoot版本：2.4.1</strong></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/05/16/【MySQL】sort buffer和join buffer/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="shan">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="SHAN">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/05/16/【MySQL】sort buffer和join buffer/" itemprop="url">【MySQL】sort buffer和join buffer</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-05-16T21:00:00+08:00">
                2020-05-16
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>sort buffer和join buffer两者没什么关系，只是最近重读了极客时间的MySQL实战，又加深了对MySQL的认知，这里记录一下sort buffer和join buffer两个知识点，以便加深印象。</p>
<h3 id="sort-buffer"><a href="#sort-buffer" class="headerlink" title="sort buffer"></a>sort buffer</h3><p>sort buffer从名字上就可以看出肯定和排序有关，MySQL会为每个线程分配一块内存，用于排序，这个内存就称为sort buffer。</p>
<p>内存的大小可以通过sort_buffer_size参数控制，如果需要排序的数据量超过了sort_buffer_size的大小，就需要借助磁盘临时文件进行外部排序，一般使用归并排序算法，所以排序的数据可能需要被切分，每一份单独排序后存在临时文件中，最后将所有的文件合并成一个有序的大文件。</p>
<blockquote>
<p>可以通过打开optimizer_trace，查看optimizer_trace结果中的number_of_tmp_files，判断是否使用了临时文件以及临时文件的个数。</p>
</blockquote>
<h4 id="全字段排序"><a href="#全字段排序" class="headerlink" title="全字段排序"></a>全字段排序</h4><p>假设有一个表t有name、age、city字段，在city上创建了索引，现在执行：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> city,<span class="keyword">name</span>,age <span class="keyword">from</span> t <span class="keyword">where</span> city = <span class="string">'杭州'</span> <span class="keyword">order</span> <span class="keyword">by</span> <span class="keyword">name</span> <span class="keyword">limit</span> <span class="number">1000</span>;</span><br></pre></td></tr></table></figure>
<p><img src="/images/sort_buffer.png" alt=""> </p>
<p><strong>语句的执行流程：</strong></p>
<p>（1）初始化sort_buffer，放入city、name、age三个字段；</p>
<p>（2）通过city上的索引，找到第一个city是杭州的节点，通过节点中保存的主键id去主键索引寻找该条记录，取出name、city和age字段的值，放入到sort_buffer中；</p>
<p>（3）继续寻找下一个满足条件的主键，通过id在主键索引中取出三个字段的值放入sort_buffer；</p>
<p>（4）重复步骤2和3，直到找到不满足条件的city为止；</p>
<p>（5）对sort_buffer中的数据按照name字段做排序；</p>
<p>（6）按照排序结果取前1000行返回给客户端；</p>
<h4 id="rowid排序"><a href="#rowid排序" class="headerlink" title="rowid排序"></a>rowid排序</h4><p>在全字段排序中，假如select中取的字段太多，sort_buffer可能放不下，就需要借助外部排序，排序的性能会下降，max_length_for_sort_data参数可以修改排序的单行最大长度，在全字段排序中取了city、name和age字段，三个字段的数据类型长度加起来就是排序的单行长度，假设全排序中单行长度超过了max_length_for_sort_data，MySQL为了提高性能，会采用rowid排序。</p>
<p><strong>rowid的排序流程：</strong></p>
<p>（1）初始化sort_buffer，放入name（因为需要根据name进行排序）和id；</p>
<p>（2）从city索引中找到第一个city为杭州的数据的id，到主键索引中找到对应的记录，取name和id两个字段的值，放入sort_buffer；</p>
<p>（3）继续寻找下一个满足条件的值，将id和name放入sort_buffer；</p>
<p>（4）重复步骤2和3，知道找到不满足的条件的city为止；</p>
<p>（5）对sort_buffer中的数据按照name排序；</p>
<p>（6）根据排序的结果取前1000行，因为sort_buffer中只放了name和id，没有age和city，所以此时需要根据id再次从主键所以中回表取出city 、name和age的值，最后返回给客户端；</p>
<p><img src="/images/rowid.jpg" alt=""> </p>
<center>注：图片来源于极客时间-林晓斌（丁奇）：MySQL实战</center>

<p>可以发现与字段全排序相比，rowid比字段全排序多了一次最后根据id从主键索引回表的过程。</p>
<p><strong>总结：</strong></p>
<p>1.如果sort_buffer足够大，会优先选择字段全排序，把需要的字段全放入sort_buffer中，排序后可直接返回结果；</p>
<p>2.如果sort_buffer无法满足排序的数量，会采用rowid排序算法，但是需要根据id回表查询所需的字段；</p>
<p><strong>优化：</strong></p>
<p>如果根据索引取到的数据就是有序的，那么就可以省去排序的过程了，所以可以在表上建一个city和name的联合索引，此时的查询流程如下：</p>
<p><img src="/images/cityname.png" alt=""> </p>
<center>注：图片来源于极客时间-林晓斌（丁奇）：MySQL实战</center>

<p>（1）从联合索引(city,name)中找到第一个满足city是杭州的数据的主键id;</p>
<p>（2）到主键索引中根据主键id取name、city、age三个字段的值，返回结果到客户端；</p>
<p>（3）继续取下一个记录的id；</p>
<p>（4）重复步骤2和3，直到第1000条记录或者不满足条件的时候为止；</p>
<p>可以看到如果加了city和name的联合索引，可以省去排序的过程，再继续优化，借助覆盖索引，创建city、name和age的联合索引，这样可以把回表的步骤也省掉了：</p>
<p>（1）从联合索引(city,name,age)中找到第一个满足city是杭州的节点，因为创建的是联合索引，索引节点中包含city、name、age的值，直接将结果集返回给客户端即可；</p>
<p>（2）从联合索引取下一个满足条件的记录，返回数据给客户端；</p>
<p>（3）重复执行步骤2，直到第1000条记录或者不满足条件为止；</p>
<h3 id="join-buffer"><a href="#join-buffer" class="headerlink" title="join buffer"></a>join buffer</h3><h4 id="Index-Nested-Loop-Join（NLJ）"><a href="#Index-Nested-Loop-Join（NLJ）" class="headerlink" title="Index Nested-Loop Join（NLJ）"></a>Index Nested-Loop Join（NLJ）</h4><p>假设有两张表t1和t2，表结构一致，除了主键id之外只有两个字段a和b，在a字段上创建索引，然后执行语句：</p>
<p><img src="/images/table.png" alt=""> </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> t1 <span class="keyword">straight_join</span> t2 <span class="keyword">on</span> (t1.a=t2.a);</span><br></pre></td></tr></table></figure>
<p>执行流程：</p>
<p>（1）从表t1读入一行数据R；</p>
<p>（2）从数据行R中读取a字段的值，到表t2中查找，由于t2表中a字段创建了索引，所以可以借助索引在表t2中查找；</p>
<p>（3）将t2表中查找到满足条件的所有行，与t1做关联；</p>
<p>（4）重复执行步骤1到3，遍历表t1，直到所有数据被读完；</p>
<p>在这个过程中，t1属于驱动表，t2属于被驱动表，驱动表t1做了全表扫描，每次取出一行，然后取出字段a的值再从t2中借助索引进行查找，完成表数据行的关联，由于在被驱动表中查找时使用到了索引，所以这种查询流程称为Index Nested-Loop Join。</p>
<h4 id="Simple-Nested-Loop-Join"><a href="#Simple-Nested-Loop-Join" class="headerlink" title="Simple Nested-Loop Join"></a>Simple Nested-Loop Join</h4><p>修改一下查询语句，假如执行下面这个查询：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> t1 <span class="keyword">straight_join</span> t2 <span class="keyword">on</span> (t1.a=t2.b);</span><br></pre></td></tr></table></figure>
<p>表t2的字段b是没有索引的，所以此时的查询流程如下：</p>
<p>（1）从表t1读入一行数据R；</p>
<p>（2）从数据行R中读取a字段的值，到表t2中查找，由于t2表中b字段没有索引，所以只能对t2进行全表扫描，查找满足条件的值；</p>
<p>（3）将t2表中查找到满足条件的所有行，与t1做关联；</p>
<p>（4）重复执行步骤1到3，遍历表t1，直到所有数据被读完；</p>
<p>假如驱动表的行数为N，被驱动表的行数为M，如果被驱动表上没有可用的索引，那么将会扫描N<em>M行，可以看到在N=100，M=1000时，N</em>M = 100000，只是这么小的数据量下就要扫描10万行，使用此算法代价会比较大，所以有了BNL算法Block Nested-Loop Join。</p>
<h4 id="Block-Nested-Loop-Join（BNL）"><a href="#Block-Nested-Loop-Join（BNL）" class="headerlink" title="Block Nested-Loop Join（BNL）"></a>Block Nested-Loop Join（BNL）</h4><p>在被驱动表上没有可用的索引时，BNL算法的执行流程：</p>
<p>（1）将表t1的数据放入线程内存join_buffer中，由于语句是select * 所以t1的所有数据会被加载到join_buffer中；</p>
<p>（2）扫描表t2，取出表t2的每一行，与join_buffer中的数据做对比，如果满足条件，将数据关联，作为结果集的一部分返回；</p>
<p><img src="/images/bnl.jpg" alt=""> </p>
<center>注：图片来源于极客时间-林晓斌（丁奇）：MySQL实战</center>

<p>假设表t1的行数为N，t2的行数为M：</p>
<ul>
<li>两张表都做了一次全表扫描，扫描行数是M+N；</li>
<li>表t1的每一行都要和表t2的每一行作比较，判断次数为M<em>N，虽然还是M</em>N但是是在内存中做的判断，因此性能会提示很多；</li>
</ul>
<p>假如表t1的数据量太大，join_buffer中放不下，那么将会采用分段放的方式：</p>
<p>（1）将表t1的数据放入join_buffer中，假设在第50行的时候join_buffer满了，进行第2步；</p>
<p>（2）扫描表t2，取出表t2的每一行，与join_buffer中的数据做对比，如果满足条件，将数据关联，作为结果集的一部分返回；</p>
<p>（3）清空join_buffer；</p>
<p>（4）继续扫描t1，将剩余的行放入join_buffer，重复步骤1、2、3；</p>
<p><strong>总结：</strong></p>
<p>（1）尽量使用小表做驱动表；</p>
<p>（2）使用BNL算法在大表上的join操作可能要扫描被驱动表多次，占用大量的IO资源，在判断join条件时可能需要大量的判断占用CPU资源，尽量避免这种join；</p>
<p>（3）会导致Buffer Pool的热数据被淘汰，影响内存命中率；</p>
<h4 id="Multi-Range-Read-优化"><a href="#Multi-Range-Read-优化" class="headerlink" title="Multi-Range Read 优化"></a>Multi-Range Read 优化</h4><p>我们知道，MySQL InnoDB的二级索引叶子节点中存储的是主键的值，如果需要查询其他字段的值，需要根据主键的值去主键索引上查找，才能拿到其他字段的值，这个操作称为回表，假设有一表t，在字段a上创建了索引，执行如下语句：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> t1 <span class="keyword">where</span> a&gt;=<span class="number">1</span> <span class="keyword">and</span> a&lt;=<span class="number">100</span>;</span><br></pre></td></tr></table></figure>
<p>执行流程：</p>
<p>（1）在字段a上建立的二级索引中找到第一个a值大于1的节点，找到对应的主键；</p>
<p>（2）根据主键值去主键索引中查找，获取该行记录所有字段的值，作为返回结果集；</p>
<p>（3）循环步骤1和2，直到把小于等于100的值全部寻找完毕；</p>
<blockquote>
<p>在这个过程中，由于每次只根据一个主键ID去主键索引中查找，每次查找就变成了随机访问，性能相对较差，因为大部分数据都是按照主键递增顺序插入得到的，假如按照主键递增顺序查找的话，对磁盘的读比较接近顺序读，这样就可以提升读性能，这就是MRR优化的思路。</p>
</blockquote>
<p>MRR优化后的执行流程：</p>
<p>（1）根据a字段上的二级索引找到所有满足条件的记录，将所有的主键ID值放入read_rnd_buffer中；</p>
<p>（2）将read_rnd_buffer中的id进行递增排序；</p>
<p>（3）根据read_rnd_buffer中排好序的id依次到主键索引中查询记录，并作为返回结果；</p>
<p><strong>MRR的核心思想在于得到足够多的主键ID，然后对ID排序，再去主键索引查找数据，将随机访问改为尽量接近顺序访问。</strong></p>
<h4 id="Batched-Key-Access优化"><a href="#Batched-Key-Access优化" class="headerlink" title="Batched Key Access优化"></a>Batched Key Access优化</h4><p>MySQL在5.6版本之后引入了Batched Key Access(BKA) 算法，它可以对 Index Nested-Loop Join（NLJ） 进行优化。</p>
<p>NLJ算法的流程是从驱动表t1，一行一行的取出a值，再到被驱动表t2中根据字段a的索引去查找，对于表t2每次只匹配一个值，为了让t2表可以一次性多拿到一些值，可以把t1表的数据取出来之后先放到临时内存中，然后批量的去t2表的索引上去查询，我们知道在NLJ算法中并没有用到join_buffer，所以join_buffer就可以充当临时内存。</p>
<p><strong>BKA算法的核心思想就是借助join_buffer批量的从被驱动表的索引中查询数据。</strong></p>
<p><strong>参考</strong></p>
<p>极客时间 — 林晓斌（丁奇）：MySQL实战</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/05/03/【MySQL】MVVC机制/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="shan">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="SHAN">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/05/03/【MySQL】MVVC机制/" itemprop="url">【MySQL】MVVC机制</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-05-03T11:30:00+08:00">
                2020-05-03
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="MySQL隔离级别"><a href="#MySQL隔离级别" class="headerlink" title="MySQL隔离级别"></a>MySQL隔离级别</h3><p><strong>读未提交(Read Uncommitted)</strong>：某个事务读到了其他还未提交的事务对数据所作的修改，也就是某个事务只要修改了数据，其他事务就可以看到所作的修改。</p>
<blockquote>
<p>这种隔离级别下会发生脏读、不可重复读、幻读。</p>
</blockquote>
<p><strong>读提交(Read Committed)</strong>：某个事务提交之后，才可以被其他事务看到。</p>
<blockquote>
<p>这种隔离级别下会发生不可重复读、幻读。</p>
</blockquote>
<p><strong>可重复读(Repeatable Read)</strong>：一个事务在执行过程中看到的数据，总是跟这个事务在启动的时候看到的数据是一致的。</p>
<blockquote>
<p>MySQL的默认隔离级别，这种隔离级别下会发生幻读。</p>
</blockquote>
<blockquote>
<p>不可重复读侧重于数据的修改，幻读侧重于数据的新增。假设事务A开始之前某个字段的值是A，事务B将它的值修改为了B，此时事务A再次查询得到的结果是B，与事务A开始时查到的值A不一致，就是不可重复读。假设事务A开始之前查询某个表只有一条记录，事务B往表中又插入了一条记录，此时事务A再次查询莫名多出一条记录，就是幻读。</p>
</blockquote>
<p><strong>串行化(Serializable)</strong>：对于同一条记录，读会加读锁，写会加写锁，读和读之间不会冲突，但是读和写之间会冲突，假如读写冲突，后访问的事务需要等待前一个事务执行完毕才可以继续执行。</p>
<blockquote>
<p>因为不允许事务并发执行，只能串行执行，因此不会有脏读、不可重复读、幻读问题，但是由于串行执行，性能比较差。</p>
</blockquote>
<h3 id="Read-View一致性视图"><a href="#Read-View一致性视图" class="headerlink" title="Read View一致性视图"></a>Read View一致性视图</h3><p>InnoDB中，每个事务在开始的时候都会申请一个事物id，这样每个事务会有一个唯一的事务id，每行数据也会有多个版本，每次事务更新的时候，会生成对应的事务版本，将事物id设置到这个事务版本的trx_id中,旧的事务版本也会保留:</p>
<p><img src="/images/trx_version.png" alt=""> </p>
<p><strong>注意：图中的版本链不是物理上真实存在的，实际上是根据undo log版本链计算出来的。</strong></p>
<p><strong>undo log版本链</strong></p>
<p>由于对数据的修改会生成undo log回滚日志，每个事务又会生成对应的事务版本，那么多个事务修改的时候就会形成一个undo log 版本链，每条数据包含两个隐藏字段，trx_id和roll_pointer：</p>
<p><img src="/images/undolog_version.png" alt=""> </p>
<p>trx_id：最近一次更新这条数据的事务id</p>
<p>roll_pointer：指向当前事务之前生成的那个undo log</p>
<blockquote>
<p>所以多个事务串行执行的时候，每个事务都会生成一条undo log，通过roll_pointer将undo log串起来，形成undo log版本链，当没有事务需要用到这些undo log时，undo log才会被删除，假如有长事务，由于随时可能访问数据库的任何数据，在这个事务提交之前，它可能用到的undo log都将会保留，就会导致大量的占用存储空间，因此需要尽量避免长事务。</p>
</blockquote>
<p><strong>一致性视图</strong></p>
<p>事务在启动的时候，InnoDb会为每一个事务创建一个数组，保存这个事务启动时，当前所有正在活跃（事务已启动但是还没提交）的事务ID，数组中事务ID最小值为低水位，已经生成过的事务的最大值的ID加1记作高水位，视图数组和高水位组成了当前事务的一致性视图，基于事务的trx_id和一致性视图可以实现读提交和不可重复读这两个隔离级别：</p>
<p><img src="/images/readview.png" alt=""> </p>
<p>注：图片来自于极客时间 — 林晓斌（丁奇）：MySQL实战</p>
<p>对于当前事务来说，一个事务的id可能有以下三种情况：</p>
<p>1.在视图数组中已提交的事务中，表示这个版本是已提交的事务，那么它是可以被当前事务读到的;</p>
<p>2.在未开始事务中，表示这个版本的数据是由将来启动的事务生成的，对当前事务来说必然是不可见的;</p>
<p>3.在未提交的事务集合中，有两种情况：</p>
<p>（1）如果trx_id在当前事务的活跃数组中，表示这个版本是由未提交的事务生成的，对当前事务来说不可见;</p>
<p>（2）如果trx_id不在当前事务的活跃数组中，表示这个版本的事务已提交，对当前事务来说可见;</p>
<p><strong>基于ReadView实现读提交</strong></p>
<p>假设系统当前存在两个活跃的事务B和事务C：</p>
<p><img src="/images/rc.png" alt=""> </p>
<p>（1）事务B第一次查询id值时会顺着undo log版本链寻找，首先会读取undo log版本链最新的值，undo log版本链中当前值为30，对应的trx_id 为30，trx_id比事务B中max_trx_id小，说明事务B在生成read view之前就存在这个活跃的事务，由于trx_id为30的事务在事务B的活跃列表中<br>在读提交隔离级别下，是不能读取到30这个值的，继续顺着版本链往前找，下一个是trx_id为10更新的值，trx_id =10 比事务B中的min_trx_id小，说明事务B生成read view之前，trx_id为10的事务就已经提交，所以可以读取trx_id=10的事务更新的值，事务B第一次查询得到ID的值为10;</p>
<p>（2）事务B在第二次查询时,会重新生成read view，此时由于事务C已提交，trx_id为30的事务不在事务B的活跃事务列表中，此时事务B是可以读取到30的，所以事务B第二次读取到ID的值为30;</p>
<blockquote>
<p>实现读提交比较重要的一点就是每次在查询时都会重新生成read view。</p>
</blockquote>
<p><strong>基于ReadView实现可重复读</strong></p>
<p>假设系统当前存在两个活跃的事务B和事务C：</p>
<p><img src="/images/rr.png" alt=""> </p>
<p>（1）与读提交中的第一次查询一致，得到的值为10;</p>
<p>（2）事务B在第二次查询时,会继续使用第一次查询生成的一致性视图，此时虽然事务C已提交，但是由于没有重新生成一致性视图，trx_id为30的事务依旧在事务B的活跃事务列表中，此时事务B是不可以读取到30的，所以事务B第二次读取到ID的值为10;</p>
<blockquote>
<p>实现不可重复读比较重要的一点就是整个事务都会使用一个一致性视图，不是每次查询都重新生成一致性视图。</p>
</blockquote>
<p><strong>总结：</strong></p>
<p>在读提交隔离级别下，每个语句执行前都会重新算出一个一致性视图。</p>
<p>在可重复读隔离级别下，只在事务开始的时候创建一致性视图，之后事务里的其他查询都共用这个一致性视图。</p>
<p><strong>当前读</strong></p>
<p>当前读指的是读取undo log版本链中最新的记录</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> xx <span class="keyword">from</span> xx <span class="keyword">lock</span> <span class="keyword">in</span> <span class="keyword">share</span>;</span><br><span class="line"><span class="keyword">select</span> xx <span class="keyword">from</span> xx <span class="keyword">for</span> <span class="keyword">update</span>;</span><br></pre></td></tr></table></figure>
<p>lock in share mode会加读锁，for update会加写锁，这两种语句都会进行当前读。</p>
<p><strong>快照读</strong></p>
<p>指的是按照生成的一致性视图读取数据。</p>
<blockquote>
<p>需要注意的时，如果是更新操作都是当前读。</p>
</blockquote>
<p>创建持续整个事务的一个一致性快照：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">start</span> <span class="keyword">transaction</span> <span class="keyword">with</span> <span class="keyword">consistent</span> <span class="keyword">snapshot</span>;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>在读提交隔离级别下，没有意义，等效于普通的start transaction。</p>
</blockquote>
<p><strong>参考：</strong></p>
<p>极客时间 — 林晓斌（丁奇）：MySQL实战</p>
<p>救火队队长：从零开始带你成为MySQL实战优化高</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/03/15/Eureka缓存机制/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="shan">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="SHAN">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/03/15/Eureka缓存机制/" itemprop="url">Eureka缓存机制</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-03-15T15:00:00+08:00">
                2020-03-15
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Eureka分为Client端和Server端，Client端向Server端注册自己的服务信息，并且拉取所有服务的注册信息，Server端作为注册中心，负责接收Client端的注册信息，维护所有服务的注册信息，Server端也可以开启集群模式，相互之间同步服务的注册信息。</p>
<p><strong>与缓存相关的三个变量</strong></p>
<h5 id="1-registry"><a href="#1-registry" class="headerlink" title="1.registry"></a>1.registry</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ConcurrentHashMap&lt;String, Map&lt;String, Lease&lt;InstanceInfo&gt;&gt;&gt; registry</span><br></pre></td></tr></table></figure>
<p>AbstractInstanceRegistry的成员变量，相当于服务端的注册表，维护所有服务的注册信息，第一层Map的key是服务的应用名称，value也是一个map,其中key是实例id,value是实例的详细信息(Lease<instanceinfo>)。</instanceinfo></p>
<h5 id="2-readWriteCacheMap"><a href="#2-readWriteCacheMap" class="headerlink" title="2.readWriteCacheMap"></a>2.readWriteCacheMap</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> LoadingCache&lt;Key, ResponseCacheImpl.Value&gt; readWriteCacheMap;</span><br></pre></td></tr></table></figure>
<p>ResponseCacheImpl的成员变量,使用的是guava的LoadingCache构建的缓存，其中key为com.netflix.eureka.registry包下的Key对象，value是ResponseCacheImpl的内部类Value对象，从名称上可以看出它是一个读写缓存。</p>
<h5 id="3-readOnlyCacheMap"><a href="#3-readOnlyCacheMap" class="headerlink" title="3.readOnlyCacheMap"></a>3.readOnlyCacheMap</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ConcurrentMap&lt;Key, ResponseCacheImpl.Value&gt; readOnlyCacheMap = <span class="keyword">new</span> ConcurrentHashMap();</span><br></pre></td></tr></table></figure>
<p>ResponseCacheImpl的成员变量，同样是一个ConcurrentMap，从名称上可以看出它是一个只读的缓存对象。</p>
<p>所以Eureka Server使用了一个读写分离的两级缓存机制，registry负责维护所有服务的注册信息，当register数据有变化，将会更新readWriteCacheMap的内容，后台开启定时任务，默认30s从readWriteCacheMap同步数据到readOnlyCacheMap，Eureka Client拉取服务的注册信息时，从readOnlyCacheMap读取数据，并没有直接从readWriteCacheMap中获取数据:</p>
<p><img src="/images/cache.png" alt=""> </p>
<p>Client从Server端拉取数据流程：</p>
<p>（1）Client端DiscoveryClient的构造函数中，会初始化定时任务；</p>
<p>（2）缓存刷新任务，定时发送请求到Server端，拉取服务的注册数据，Server端收到请求，首先会根据请求信息构建key，根据key从缓存中获取数据；</p>
<p>（3）Server端根据key获取缓存数据时，会判断是否开启了使用readOnly缓存：</p>
<pre><code>如果开启：先从readOnlyCacheMap获取，如果从readOnlyCacheMap未获取到数据，再从readWriteCacheMap中查找；

如果未开启：直接从readWriteCacheMap中获取；
</code></pre><p>（4）从readWriteCacheMap获取数据也有两种结果：</p>
<pre><code>第一：获取到数据，如果开启了readOnly缓存，会将结果设置到readOnlyCacheMap中，否则直接返回结果即可；

第二：未获取到数据，由于readWriteCacheMap使用的是guava构建的缓存，从readWriteCacheMap根据key获取数据，假如key不存在的活，就会触发load方法，在这个方法中会调用generatePayload方法从registry中获取数据构并建缓存数据返回；
</code></pre><p>（5）Server端将结果设置到response返回到Client端；</p>
<p><img src="/images/fetchregistry.png" alt=""> </p>
<h3 id="源码"><a href="#源码" class="headerlink" title="源码"></a>源码</h3><h4 id="Eureka-Server"><a href="#Eureka-Server" class="headerlink" title="Eureka Server"></a>Eureka Server</h4><p><strong>AbstractInstanceRegistry</strong></p>
<p>以register服务注册方法看一下缓存更新的流程，在register方法中，服务进行注册的时候，会根据服务的应用名称appName,调用invalidateCache方法清除之前存在的缓存。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractInstanceRegistry</span> <span class="keyword">implements</span> <span class="title">InstanceRegistry</span></span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// server端的注册表，key是服务的应用名称，value又是一个map, key是实例id,value是实例的详细信息(Lease&lt;InstanceInfo&gt;)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ConcurrentHashMap&lt;String, Map&lt;String, Lease&lt;InstanceInfo&gt;&gt;&gt; registry = <span class="keyword">new</span> ConcurrentHashMap();</span><br><span class="line">    </span><br><span class="line">    ...</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 注册服务</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">register</span><span class="params">(InstanceInfo registrant, <span class="keyword">int</span> leaseDuration, <span class="keyword">boolean</span> isReplication)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.read.lock();</span><br><span class="line">            <span class="comment">// 根据应用名称从注册表中获取实例</span></span><br><span class="line">            Map&lt;String, Lease&lt;InstanceInfo&gt;&gt; gMap = (Map)<span class="keyword">this</span>.registry.get(registrant.getAppName());</span><br><span class="line">            EurekaMonitors.REGISTER.increment(isReplication);</span><br><span class="line">            <span class="comment">// 如果获取的实例为空</span></span><br><span class="line">            <span class="keyword">if</span>(gMap == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// 创建一个hashmap</span></span><br><span class="line">                ConcurrentHashMap&lt;String, Lease&lt;InstanceInfo&gt;&gt; gNewMap = <span class="keyword">new</span> ConcurrentHashMap();</span><br><span class="line">                <span class="comment">// 加入注册表</span></span><br><span class="line">                gMap = (Map)<span class="keyword">this</span>.registry.putIfAbsent(registrant.getAppName(), gNewMap);</span><br><span class="line">                <span class="keyword">if</span>(gMap == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    gMap = gNewMap;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 根据实例ID获取，实例的详细信息</span></span><br><span class="line">            Lease&lt;InstanceInfo&gt; existingLease = (Lease)((Map)gMap).get(registrant.getId());</span><br><span class="line">            </span><br><span class="line">            ...</span><br><span class="line">            </span><br><span class="line">            registrant.setActionType(ActionType.ADDED);</span><br><span class="line">            <span class="keyword">this</span>.recentlyChangedQueue.add(<span class="keyword">new</span> AbstractInstanceRegistry.RecentlyChangedItem(lease));</span><br><span class="line">            registrant.setLastUpdatedTimestamp();</span><br><span class="line">            <span class="comment">// 清除缓存</span></span><br><span class="line">            <span class="keyword">this</span>.invalidateCache(registrant.getAppName(), registrant.getVIPAddress(), registrant.getSecureVipAddress());</span><br><span class="line">            logger.info(<span class="string">"Registered instance &#123;&#125;/&#123;&#125; with status &#123;&#125; (replication=&#123;&#125;)"</span>, <span class="keyword">new</span> Object[]&#123;registrant.getAppName(), registrant.getId(), registrant.getStatus(), Boolean.valueOf(isReplication)&#125;);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.read.unlock();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 清除缓存</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">invalidateCache</span><span class="params">(String appName, @Nullable String vipAddress, @Nullable String secureVipAddress)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.responseCache.invalidate(appName, vipAddress, secureVipAddress);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>ResponseCacheImpl</strong></p>
<p>（1）ResponseCacheImpl中包含了readOnlyCacheMap只读缓存对象和readWriteCacheMap读写缓存对象，其中readWriteCacheMap使用的是guava的缓存机制，如果根据key从readWriteCacheMap获取数据时没有这个key，将会调用load方法，在load方法中是调用generatePayload构建Value对象的，在generatePayload是从registry获取数据的，也就是说当readWriteCacheMap不存在某个key是会从registry获取数据。</p>
<p>（2）在构造函数中，初始化了readWriteCacheMap对象，并判断是否使用readOnlyCacheMap缓存，如果开启，设置定时任务getCacheUpdateTask，定时从readWriteCacheMap同步数据到readOnlyCacheMap，同步方式是遍历readOnlyCacheMap，判断value是否与readWriteCacheMap的数据一致，如果不一致，以readWriteCacheMap的数据为准，更新readOnlyCacheMap的数据。</p>
<p>（3）invalidate方法用来清除readWriteCacheMap中的缓存.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ResponseCacheImpl</span> <span class="keyword">implements</span> <span class="title">ResponseCache</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// readOnlyCacheMap缓存</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ConcurrentMap&lt;Key, ResponseCacheImpl.Value&gt; readOnlyCacheMap = <span class="keyword">new</span> ConcurrentHashMap();</span><br><span class="line">    <span class="comment">// guava构建的readWriteCacheMap缓存</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> LoadingCache&lt;Key, ResponseCacheImpl.Value&gt; readWriteCacheMap;</span><br><span class="line">    ...</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 构造函数</span></span><br><span class="line">    ResponseCacheImpl(EurekaServerConfig serverConfig, ServerCodecs serverCodecs, AbstractInstanceRegistry registry) &#123;</span><br><span class="line">        <span class="keyword">this</span>.serverConfig = serverConfig;</span><br><span class="line">        <span class="keyword">this</span>.serverCodecs = serverCodecs;</span><br><span class="line">        <span class="comment">// 是否使用只读缓存</span></span><br><span class="line">        <span class="keyword">this</span>.shouldUseReadOnlyResponseCache = serverConfig.shouldUseReadOnlyResponseCache();</span><br><span class="line">        <span class="keyword">this</span>.registry = registry;</span><br><span class="line">        <span class="comment">// 缓存更新间隔</span></span><br><span class="line">        <span class="keyword">long</span> responseCacheUpdateIntervalMs = serverConfig.getResponseCacheUpdateIntervalMs();</span><br><span class="line">        <span class="comment">// 构建缓存对象，初始容量为1000</span></span><br><span class="line">        <span class="keyword">this</span>.readWriteCacheMap = CacheBuilder.newBuilder().initialCapacity(<span class="number">1000</span>).expireAfterWrite(serverConfig.getResponseCacheAutoExpirationInSeconds(), TimeUnit.SECONDS).removalListener(<span class="keyword">new</span> RemovalListener&lt;Key, ResponseCacheImpl.Value&gt;() &#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onRemoval</span><span class="params">(RemovalNotification&lt;Key, ResponseCacheImpl.Value&gt; notification)</span> </span>&#123;</span><br><span class="line">                Key removedKey = (Key)notification.getKey();</span><br><span class="line">                <span class="keyword">if</span>(removedKey.hasRegions()) &#123;</span><br><span class="line">                    Key cloneWithNoRegions = removedKey.cloneWithoutRegions();</span><br><span class="line">                    ResponseCacheImpl.<span class="keyword">this</span>.regionSpecificKeys.remove(cloneWithNoRegions, removedKey);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).build(<span class="keyword">new</span> CacheLoader&lt;Key, ResponseCacheImpl.Value&gt;() &#123;</span><br><span class="line">            <span class="comment">// 如果缓存中key不存在，会调用load方法</span></span><br><span class="line">            <span class="keyword">public</span> ResponseCacheImpl.<span class="function">Value <span class="title">load</span><span class="params">(Key key)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                <span class="keyword">if</span>(key.hasRegions()) &#123;</span><br><span class="line">                    Key cloneWithNoRegions = key.cloneWithoutRegions();</span><br><span class="line">                    ResponseCacheImpl.<span class="keyword">this</span>.regionSpecificKeys.put(cloneWithNoRegions, key);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 根据key构建缓存数据</span></span><br><span class="line">                ResponseCacheImpl.Value value = ResponseCacheImpl.<span class="keyword">this</span>.generatePayload(key);</span><br><span class="line">                <span class="keyword">return</span> value;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">// 如果使用只读缓存</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">this</span>.shouldUseReadOnlyResponseCache) &#123;</span><br><span class="line">            <span class="comment">// 注册定时任务，同步数据</span></span><br><span class="line">            <span class="keyword">this</span>.timer.schedule(<span class="keyword">this</span>.getCacheUpdateTask(), <span class="keyword">new</span> Date(System.currentTimeMillis() / responseCacheUpdateIntervalMs * responseCacheUpdateIntervalMs + responseCacheUpdateIntervalMs), responseCacheUpdateIntervalMs);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Monitors.registerObject(<span class="keyword">this</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable var7) &#123;</span><br><span class="line">            logger.warn(<span class="string">"Cannot register the JMX monitor for the InstanceRegistry"</span>, var7);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 清除缓存</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">invalidate</span><span class="params">(String appName, @Nullable String vipAddress, @Nullable String secureVipAddress)</span> </span>&#123;</span><br><span class="line">        KeyType[] var4 = KeyType.values();</span><br><span class="line">        <span class="keyword">int</span> var5 = var4.length;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> var6 = <span class="number">0</span>; var6 &lt; var5; ++var6) &#123;</span><br><span class="line">            KeyType type = var4[var6];</span><br><span class="line">            Version[] var8 = Version.values();</span><br><span class="line">            <span class="keyword">int</span> var9 = var8.length;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> var10 = <span class="number">0</span>; var10 &lt; var9; ++var10) &#123;</span><br><span class="line">                Version v = var8[var10];</span><br><span class="line">                <span class="comment">// 实际上调用的invalidate(Key... keys)方法</span></span><br><span class="line">                <span class="keyword">this</span>.invalidate(<span class="keyword">new</span> Key[]&#123;<span class="keyword">new</span> Key(EntityType.Application, appName, type, v, EurekaAccept.full), <span class="keyword">new</span> Key(EntityType.Application, appName, type, v, EurekaAccept.compact), <span class="keyword">new</span> Key(EntityType.Application, <span class="string">"ALL_APPS"</span>, type, v, EurekaAccept.full), <span class="keyword">new</span> Key(EntityType.Application, <span class="string">"ALL_APPS"</span>, type, v, EurekaAccept.compact), <span class="keyword">new</span> Key(EntityType.Application, <span class="string">"ALL_APPS_DELTA"</span>, type, v, EurekaAccept.full), <span class="keyword">new</span> Key(EntityType.Application, <span class="string">"ALL_APPS_DELTA"</span>, type, v, EurekaAccept.compact)&#125;);</span><br><span class="line">                <span class="keyword">if</span>(<span class="keyword">null</span> != vipAddress) &#123;</span><br><span class="line">                    <span class="keyword">this</span>.invalidate(<span class="keyword">new</span> Key[]&#123;<span class="keyword">new</span> Key(EntityType.VIP, vipAddress, type, v, EurekaAccept.full)&#125;);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span>(<span class="keyword">null</span> != secureVipAddress) &#123;</span><br><span class="line">                    <span class="keyword">this</span>.invalidate(<span class="keyword">new</span> Key[]&#123;<span class="keyword">new</span> Key(EntityType.SVIP, secureVipAddress, type, v, EurekaAccept.full)&#125;);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">invalidate</span><span class="params">(Key... keys)</span> </span>&#123;</span><br><span class="line">        Key[] var2 = keys;</span><br><span class="line">        <span class="keyword">int</span> var3 = keys.length;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> var4 = <span class="number">0</span>; var4 &lt; var3; ++var4) &#123;</span><br><span class="line">            Key key = var2[var4];</span><br><span class="line">            logger.debug(<span class="string">"Invalidating the response cache key : &#123;&#125; &#123;&#125; &#123;&#125; &#123;&#125;, &#123;&#125;"</span>, <span class="keyword">new</span> Object[]&#123;key.getEntityType(), key.getName(), key.getVersion(), key.getType(), key.getEurekaAccept()&#125;);</span><br><span class="line">            <span class="comment">// 根据key清除缓存</span></span><br><span class="line">            <span class="keyword">this</span>.readWriteCacheMap.invalidate(key);</span><br><span class="line">            Collection&lt;Key&gt; keysWithRegions = <span class="keyword">this</span>.regionSpecificKeys.get(key);</span><br><span class="line">            <span class="keyword">if</span>(<span class="keyword">null</span> != keysWithRegions &amp;&amp; !keysWithRegions.isEmpty()) &#123;</span><br><span class="line">                Iterator var7 = keysWithRegions.iterator();</span><br><span class="line"></span><br><span class="line">                <span class="keyword">while</span>(var7.hasNext()) &#123;</span><br><span class="line">                    Key keysWithRegion = (Key)var7.next();</span><br><span class="line">                    logger.debug(<span class="string">"Invalidating the response cache key : &#123;&#125; &#123;&#125; &#123;&#125; &#123;&#125; &#123;&#125;"</span>, <span class="keyword">new</span> Object[]&#123;key.getEntityType(), key.getName(), key.getVersion(), key.getType(), key.getEurekaAccept()&#125;);</span><br><span class="line">                    <span class="keyword">this</span>.readWriteCacheMap.invalidate(keysWithRegion);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 定时任务，从readWriteCacheMap同步数据到readOnlyCacheMap</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> TimerTask <span class="title">getCacheUpdateTask</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> TimerTask() &#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                ResponseCacheImpl.logger.debug(<span class="string">"Updating the client cache from response cache"</span>);</span><br><span class="line">                Iterator var1 = ResponseCacheImpl.<span class="keyword">this</span>.readOnlyCacheMap.keySet().iterator();</span><br><span class="line">                <span class="comment">// 遍历readOnlyCacheMap</span></span><br><span class="line">                <span class="keyword">while</span>(var1.hasNext()) &#123;</span><br><span class="line">                    Key key = (Key)var1.next();</span><br><span class="line">                    <span class="keyword">if</span>(ResponseCacheImpl.logger.isDebugEnabled()) &#123;</span><br><span class="line">                        ResponseCacheImpl.logger.debug(<span class="string">"Updating the client cache from response cache for key : &#123;&#125; &#123;&#125; &#123;&#125; &#123;&#125;"</span>, <span class="keyword">new</span> Object[]&#123;key.getEntityType(), key.getName(), key.getVersion(), key.getType()&#125;);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        CurrentRequestVersion.set(key.getVersion());</span><br><span class="line">                        <span class="comment">// 从readWriteCacheMap根据key获取数据</span></span><br><span class="line">                        ResponseCacheImpl.Value cacheValue = (ResponseCacheImpl.Value)ResponseCacheImpl.<span class="keyword">this</span>.readWriteCacheMap.get(key);</span><br><span class="line">                        <span class="comment">// 从readOnlyCacheMap获取数据</span></span><br><span class="line">                        ResponseCacheImpl.Value currentCacheValue = (ResponseCacheImpl.Value)ResponseCacheImpl.<span class="keyword">this</span>.readOnlyCacheMap.get(key);</span><br><span class="line">                        <span class="comment">// 对比数据是否一致</span></span><br><span class="line">                        <span class="keyword">if</span>(cacheValue != currentCacheValue) &#123;</span><br><span class="line">                           <span class="comment">// 如果数据不一致，更新readOnlyCacheMap的数据 ResponseCacheImpl.this.readOnlyCacheMap.put(key, cacheValue);</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Throwable var5) &#123;</span><br><span class="line">                        ResponseCacheImpl.logger.error(<span class="string">"Error while updating the client cache from response cache for key &#123;&#125;"</span>, key.toStringCompact(), var5);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 根据key生成ResponseCacheImpl.Value对象</span></span><br><span class="line">    <span class="keyword">private</span> ResponseCacheImpl.<span class="function">Value <span class="title">generatePayload</span><span class="params">(Key key)</span> </span>&#123;</span><br><span class="line">        Stopwatch tracer = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        ResponseCacheImpl.Value var8;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String payload;</span><br><span class="line">            <span class="keyword">switch</span>(<span class="keyword">null</span>.$SwitchMap$com$netflix$eureka$registry$Key$EntityType[key.getEntityType().ordinal()]) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">                <span class="keyword">boolean</span> isRemoteRegionRequested = key.hasRegions();</span><br><span class="line">                <span class="comment">// 全量获取</span></span><br><span class="line">                <span class="keyword">if</span>(<span class="string">"ALL_APPS"</span>.equals(key.getName())) &#123;</span><br><span class="line">                    <span class="keyword">if</span>(isRemoteRegionRequested) &#123;</span><br><span class="line">                        tracer = <span class="keyword">this</span>.serializeAllAppsWithRemoteRegionTimer.start();</span><br><span class="line">                        payload = <span class="keyword">this</span>.getPayLoad(key, <span class="keyword">this</span>.registry.getApplicationsFromMultipleRegions(key.getRegions()));</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        tracer = <span class="keyword">this</span>.serializeAllAppsTimer.start();</span><br><span class="line">                        <span class="comment">// 从registry获取数据</span></span><br><span class="line">                        payload = <span class="keyword">this</span>.getPayLoad(key, <span class="keyword">this</span>.registry.getApplications());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span>(<span class="string">"ALL_APPS_DELTA"</span>.equals(key.getName())) &#123;<span class="comment">// 增量获取</span></span><br><span class="line">                    <span class="keyword">if</span>(isRemoteRegionRequested) &#123;</span><br><span class="line">                        tracer = <span class="keyword">this</span>.serializeDeltaAppsWithRemoteRegionTimer.start();</span><br><span class="line">                        <span class="keyword">this</span>.versionDeltaWithRegions.incrementAndGet();</span><br><span class="line">                        versionDeltaWithRegionsLegacy.incrementAndGet();</span><br><span class="line">                        payload = <span class="keyword">this</span>.getPayLoad(key, <span class="keyword">this</span>.registry.getApplicationDeltasFromMultipleRegions(key.getRegions()));</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        tracer = <span class="keyword">this</span>.serializeDeltaAppsTimer.start();</span><br><span class="line">                        <span class="keyword">this</span>.versionDelta.incrementAndGet();</span><br><span class="line">                        versionDeltaLegacy.incrementAndGet();</span><br><span class="line">                        payload = <span class="keyword">this</span>.getPayLoad(key, <span class="keyword">this</span>.registry.getApplicationDeltas());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    tracer = <span class="keyword">this</span>.serializeOneApptimer.start();</span><br><span class="line">                    payload = <span class="keyword">this</span>.getPayLoad(key, <span class="keyword">this</span>.registry.getApplication(key.getName()));</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">            <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">                tracer = <span class="keyword">this</span>.serializeViptimer.start();</span><br><span class="line">                payload = <span class="keyword">this</span>.getPayLoad(key, getApplicationsForVip(key, <span class="keyword">this</span>.registry));</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                logger.error(<span class="string">"Unidentified entity type: &#123;&#125; found in the cache key."</span>, key.getEntityType());</span><br><span class="line">                payload = <span class="string">""</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            var8 = <span class="keyword">new</span> ResponseCacheImpl.Value(payload);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span>(tracer != <span class="keyword">null</span>) &#123;</span><br><span class="line">                tracer.stop();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> var8;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>ApplicationsResource</strong></p>
<p>ApplicationsResource的getContainers接收Client端的拉取请求，在getContainers方法中，首先会根据请求信息构建缓存Key，根据key从缓存中获取数据，并设置到response中返回给Client端。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ApplicationsResource</span> </span>&#123;</span><br><span class="line">    <span class="meta">@GET</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Response <span class="title">getContainers</span><span class="params">(@PathParam(<span class="string">"version"</span>)</span> String version, @<span class="title">HeaderParam</span><span class="params">(<span class="string">"Accept"</span>)</span> String acceptHeader, @<span class="title">HeaderParam</span><span class="params">(<span class="string">"Accept-Encoding"</span>)</span> String acceptEncoding, @<span class="title">HeaderParam</span><span class="params">(<span class="string">"X-Eureka-Accept"</span>)</span> String eurekaAccept, @Context UriInfo uriInfo, @Nullable @<span class="title">QueryParam</span><span class="params">(<span class="string">"regions"</span>)</span> String regionsStr) </span>&#123;</span><br><span class="line">        <span class="keyword">boolean</span> isRemoteRegionRequested = <span class="keyword">null</span> != regionsStr &amp;&amp; !regionsStr.isEmpty();</span><br><span class="line">        String[] regions = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span>(!isRemoteRegionRequested) &#123;</span><br><span class="line">            EurekaMonitors.GET_ALL.increment();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            regions = regionsStr.toLowerCase().split(<span class="string">","</span>);</span><br><span class="line">            Arrays.sort(regions);</span><br><span class="line">            EurekaMonitors.GET_ALL_WITH_REMOTE_REGIONS.increment();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(!<span class="keyword">this</span>.registry.shouldAllowAccess(isRemoteRegionRequested)) &#123;</span><br><span class="line">            <span class="keyword">return</span> Response.status(Status.FORBIDDEN).build();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            CurrentRequestVersion.set(Version.toEnum(version));</span><br><span class="line">            KeyType keyType = KeyType.JSON;</span><br><span class="line">            String returnMediaType = <span class="string">"application/json"</span>;</span><br><span class="line">            <span class="keyword">if</span>(acceptHeader == <span class="keyword">null</span> || !acceptHeader.contains(<span class="string">"json"</span>)) &#123;</span><br><span class="line">                keyType = KeyType.XML;</span><br><span class="line">                returnMediaType = <span class="string">"application/xml"</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 构建缓存key</span></span><br><span class="line">            Key cacheKey = <span class="keyword">new</span> Key(EntityType.Application, <span class="string">"ALL_APPS"</span>, keyType, CurrentRequestVersion.get(), EurekaAccept.fromString(eurekaAccept), regions);</span><br><span class="line">            Response response;</span><br><span class="line">            <span class="comment">// 如果acceptEncoding是gizp</span></span><br><span class="line">            <span class="keyword">if</span>(acceptEncoding != <span class="keyword">null</span> &amp;&amp; acceptEncoding.contains(<span class="string">"gzip"</span>)) &#123;</span><br><span class="line">                response = Response.ok(<span class="keyword">this</span>.responseCache.getGZIP(cacheKey)).header(<span class="string">"Content-Encoding"</span>, <span class="string">"gzip"</span>).header(<span class="string">"Content-Type"</span>, returnMediaType).build();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 从缓存中根据key获取数据设置到response中</span></span><br><span class="line">                response = Response.ok(<span class="keyword">this</span>.responseCache.get(cacheKey)).build();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> response;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>回到ResponseCacheImpl，get方法用来根据key从缓存中获取数据，最终调用的是getValue方法，在getValue方法中可以看到，如果开启了只读缓存，先从readOnlyCacheMap中获取数据，如果未获取到再从readWriteCacheMap中获取，如果未开启只读缓存，直接从readWriteCacheMap中获取，如果readWriteCacheMap不存在某个key，可以回看ResponseCacheImpl构造函数初始化readWriteCacheMap时有一个load方法，不存在某个key时触发该方法，实际上是去registry中取数据并构建缓存数据：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ResponseCacheImpl</span> <span class="keyword">implements</span> <span class="title">ResponseCache</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// 根据keky获取缓存数据</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">get</span><span class="params">(Key key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.get(key, <span class="keyword">this</span>.shouldUseReadOnlyResponseCache);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@VisibleForTesting</span></span><br><span class="line">    <span class="function">String <span class="title">get</span><span class="params">(Key key, <span class="keyword">boolean</span> useReadOnlyCache)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 根据key从缓存map中获取value</span></span><br><span class="line">        ResponseCacheImpl.Value payload = <span class="keyword">this</span>.getValue(key, useReadOnlyCache);</span><br><span class="line">        <span class="keyword">return</span> payload != <span class="keyword">null</span> &amp;&amp; !payload.getPayload().equals(<span class="string">""</span>)?payload.getPayload():<span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">     <span class="meta">@VisibleForTesting</span></span><br><span class="line">    ResponseCacheImpl.<span class="function">Value <span class="title">getValue</span><span class="params">(Key key, <span class="keyword">boolean</span> useReadOnlyCache)</span> </span>&#123;</span><br><span class="line">        ResponseCacheImpl.Value payload = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 如果使用ReadOnlyCache</span></span><br><span class="line">            <span class="keyword">if</span>(useReadOnlyCache) &#123;</span><br><span class="line">                <span class="comment">// 从ReadOnlyCache获取缓存数据</span></span><br><span class="line">                ResponseCacheImpl.Value currentPayload = (ResponseCacheImpl.Value)<span class="keyword">this</span>.readOnlyCacheMap.get(key);</span><br><span class="line">                <span class="comment">// 如果获取不为空</span></span><br><span class="line">                <span class="keyword">if</span>(currentPayload != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    payload = currentPayload;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// 如果获取为空，从readWriteCacheMap中获取数据</span></span><br><span class="line">                    payload = (ResponseCacheImpl.Value)<span class="keyword">this</span>.readWriteCacheMap.get(key);</span><br><span class="line">                    <span class="comment">// 将获取的数据加入readOnlyCacheMap中</span></span><br><span class="line">                    <span class="keyword">this</span>.readOnlyCacheMap.put(key, payload);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 如果不使用readOnlyCacheMap，直接从readWriteCacheMap获取数据</span></span><br><span class="line">                payload = (ResponseCacheImpl.Value)<span class="keyword">this</span>.readWriteCacheMap.get(key);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable var5) &#123;</span><br><span class="line">            logger.error(<span class="string">"Cannot get value for key : &#123;&#125;"</span>, key, var5);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> payload;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="Eureka-Client"><a href="#Eureka-Client" class="headerlink" title="Eureka Client"></a>Eureka Client</h4><p><strong>DiscoveryClient</strong></p>
<p>（1）在DiscoveryClient的构造方法中，会判断是否需要拉取数据，并且初始化定时任务；</p>
<p>（2）初始化定时任务方法中，会添加缓存更新的定时任务，是在CacheRefreshThread的run方法中实现的，在run方法中调用refreshRegistry刷新缓存，在refreshRegistry方法中又调用了fetchRegistry，所以最终使用的fetchRegistry方法从服务端拉取数据；</p>
<p>（3）fetchRegistry方法中会判断是全量还是增量从Server端拉取数据；<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DiscoveryClient</span> <span class="keyword">implements</span> <span class="title">EurekaClient</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">     DiscoveryClient(ApplicationInfoManager applicationInfoManager, EurekaClientConfig config, AbstractDiscoveryClientOptionalArgs args, Provider&lt;BackupRegistry&gt; backupRegistryProvider) &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">// 如果需要拉取数据</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">this</span>.clientConfig.shouldFetchRegistry() &amp;&amp; !<span class="keyword">this</span>.fetchRegistry(<span class="keyword">false</span>)) &#123;</span><br><span class="line">            <span class="comment">// 从备用服务拉取数据</span></span><br><span class="line">            <span class="keyword">this</span>.fetchRegistryFromBackup();</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 初始化定时任务</span></span><br><span class="line">        <span class="keyword">this</span>.initScheduledTasks();</span><br><span class="line">        </span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 初始化定时任务</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initScheduledTasks</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> renewalIntervalInSecs;</span><br><span class="line">        <span class="keyword">int</span> expBackOffBound;</span><br><span class="line">        <span class="comment">// 是否需要拉取数据</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">this</span>.clientConfig.shouldFetchRegistry()) &#123;</span><br><span class="line">            renewalIntervalInSecs = <span class="keyword">this</span>.clientConfig.getRegistryFetchIntervalSeconds();</span><br><span class="line">            expBackOffBound = <span class="keyword">this</span>.clientConfig.getCacheRefreshExecutorExponentialBackOffBound();</span><br><span class="line">            <span class="comment">// 注册刷新缓存的定时任务</span></span><br><span class="line">            <span class="keyword">this</span>.scheduler.schedule(<span class="keyword">new</span> TimedSupervisorTask(<span class="string">"cacheRefresh"</span>, <span class="keyword">this</span>.scheduler, <span class="keyword">this</span>.cacheRefreshExecutor, renewalIntervalInSecs, TimeUnit.SECONDS, expBackOffBound, <span class="keyword">new</span> DiscoveryClient.CacheRefreshThread()), (<span class="keyword">long</span>)renewalIntervalInSecs, TimeUnit.SECONDS);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">this</span>.clientConfig.shouldRegisterWithEureka()) &#123;</span><br><span class="line">            renewalIntervalInSecs = <span class="keyword">this</span>.instanceInfo.getLeaseInfo().getRenewalIntervalInSecs();</span><br><span class="line">            expBackOffBound = <span class="keyword">this</span>.clientConfig.getHeartbeatExecutorExponentialBackOffBound();</span><br><span class="line">            logger.info(<span class="string">"Starting heartbeat executor: renew interval is: &#123;&#125;"</span>, Integer.valueOf(renewalIntervalInSecs));</span><br><span class="line">            <span class="comment">// 注册发送心跳的定时任务</span></span><br><span class="line">            <span class="keyword">this</span>.scheduler.schedule(<span class="keyword">new</span> TimedSupervisorTask(<span class="string">"heartbeat"</span>, <span class="keyword">this</span>.scheduler, <span class="keyword">this</span>.heartbeatExecutor, renewalIntervalInSecs, TimeUnit.SECONDS, expBackOffBound, <span class="keyword">new</span> DiscoveryClient.HeartbeatThread(<span class="keyword">null</span>)), (<span class="keyword">long</span>)renewalIntervalInSecs, TimeUnit.SECONDS);</span><br><span class="line">            <span class="comment">// 构建InstanceInfoReplicator，其run方法中会调用discoveryClient.register()发送HTTP请求进行服务注册</span></span><br><span class="line">            <span class="keyword">this</span>.instanceInfoReplicator = <span class="keyword">new</span> InstanceInfoReplicator(<span class="keyword">this</span>, <span class="keyword">this</span>.instanceInfo, <span class="keyword">this</span>.clientConfig.getInstanceInfoReplicationIntervalSeconds(), <span class="number">2</span>);</span><br><span class="line">            <span class="keyword">this</span>.statusChangeListener = <span class="keyword">new</span> StatusChangeListener() &#123;</span><br><span class="line">                <span class="function"><span class="keyword">public</span> String <span class="title">getId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="string">"statusChangeListener"</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">notify</span><span class="params">(StatusChangeEvent statusChangeEvent)</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">if</span>(InstanceStatus.DOWN != statusChangeEvent.getStatus() &amp;&amp; InstanceStatus.DOWN != statusChangeEvent.getPreviousStatus()) &#123;</span><br><span class="line">                        DiscoveryClient.logger.info(<span class="string">"Saw local status change event &#123;&#125;"</span>, statusChangeEvent);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        DiscoveryClient.logger.warn(<span class="string">"Saw local status change event &#123;&#125;"</span>, statusChangeEvent);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    DiscoveryClient.<span class="keyword">this</span>.instanceInfoReplicator.onDemandUpdate();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="keyword">if</span>(<span class="keyword">this</span>.clientConfig.shouldOnDemandUpdateStatusChange()) &#123;</span><br><span class="line">                <span class="keyword">this</span>.applicationInfoManager.registerStatusChangeListener(<span class="keyword">this</span>.statusChangeListener);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">this</span>.instanceInfoReplicator.start(<span class="keyword">this</span>.clientConfig.getInitialInstanceInfoReplicationIntervalSeconds());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            logger.info(<span class="string">"Not registering with Eureka server per configuration"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 缓存刷新任务</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">CacheRefreshThread</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">        CacheRefreshThread() &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="comment">// 调用refreshRegistry刷新缓存</span></span><br><span class="line">            DiscoveryClient.<span class="keyword">this</span>.refreshRegistry();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@VisibleForTesting</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">refreshRegistry</span><span class="params">()</span> </span>&#123; </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ...</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 调用fetchRegistry从服务端拉取数据</span></span><br><span class="line">            <span class="keyword">boolean</span> success = <span class="keyword">this</span>.fetchRegistry(remoteRegionsModified);</span><br><span class="line">            <span class="keyword">if</span>(success) &#123;</span><br><span class="line">                <span class="keyword">this</span>.registrySize = ((Applications)<span class="keyword">this</span>.localRegionApps.get()).size();</span><br><span class="line">                <span class="keyword">this</span>.lastSuccessfulRegistryFetchTimestamp = System.currentTimeMillis();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ...</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable var9) &#123;</span><br><span class="line">            logger.error(<span class="string">"Cannot fetch registry from server"</span>, var9);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 拉取数据</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">fetchRegistry</span><span class="params">(<span class="keyword">boolean</span> forceFullRegistryFetch)</span> </span>&#123;</span><br><span class="line">        Stopwatch tracer = <span class="keyword">this</span>.FETCH_REGISTRY_TIMER.start();</span><br><span class="line"></span><br><span class="line">        label122: &#123;</span><br><span class="line">            <span class="keyword">boolean</span> var4;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Applications applications = <span class="keyword">this</span>.getApplications();</span><br><span class="line">                <span class="keyword">if</span>(!<span class="keyword">this</span>.clientConfig.shouldDisableDelta() &amp;&amp; Strings.isNullOrEmpty(<span class="keyword">this</span>.clientConfig.getRegistryRefreshSingleVipAddress()) &amp;&amp; !forceFullRegistryFetch &amp;&amp; applications != <span class="keyword">null</span> &amp;&amp; applications.getRegisteredApplications().size() != <span class="number">0</span> &amp;&amp; applications.getVersion().longValue() != -<span class="number">1L</span>) &#123;</span><br><span class="line">                    <span class="comment">// 增量拉取数据</span></span><br><span class="line">                    <span class="keyword">this</span>.getAndUpdateDelta(applications);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    logger.info(<span class="string">"Disable delta property : &#123;&#125;"</span>, Boolean.valueOf(<span class="keyword">this</span>.clientConfig.shouldDisableDelta()));</span><br><span class="line">                    logger.info(<span class="string">"Single vip registry refresh property : &#123;&#125;"</span>, <span class="keyword">this</span>.clientConfig.getRegistryRefreshSingleVipAddress());</span><br><span class="line">                    logger.info(<span class="string">"Force full registry fetch : &#123;&#125;"</span>, Boolean.valueOf(forceFullRegistryFetch));</span><br><span class="line">                    logger.info(<span class="string">"Application is null : &#123;&#125;"</span>, Boolean.valueOf(applications == <span class="keyword">null</span>));</span><br><span class="line">                    logger.info(<span class="string">"Registered Applications size is zero : &#123;&#125;"</span>, Boolean.valueOf(applications.getRegisteredApplications().size() == <span class="number">0</span>));</span><br><span class="line">                    logger.info(<span class="string">"Application version is -1: &#123;&#125;"</span>, Boolean.valueOf(applications.getVersion().longValue() == -<span class="number">1L</span>));</span><br><span class="line">                    <span class="comment">// 全量拉取数据</span></span><br><span class="line">                    <span class="keyword">this</span>.getAndStoreFullRegistry();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                applications.setAppsHashCode(applications.getReconcileHashCode());</span><br><span class="line">                <span class="keyword">this</span>.logTotalInstances();</span><br><span class="line">                <span class="keyword">break</span> label122;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable var8) &#123;</span><br><span class="line">                logger.error(<span class="string">"DiscoveryClient_&#123;&#125; - was unable to refresh its cache! status = &#123;&#125;"</span>, <span class="keyword">new</span> Object[]&#123;<span class="keyword">this</span>.appPathIdentifier, var8.getMessage(), var8&#125;);</span><br><span class="line">                var4 = <span class="keyword">false</span>;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="keyword">if</span>(tracer != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    tracer.stop();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> var4;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 缓存刷新事件</span></span><br><span class="line">        <span class="keyword">this</span>.onCacheRefreshed();</span><br><span class="line">        <span class="keyword">this</span>.updateInstanceRemoteStatus();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>参考：</strong></p>
<p><a href="https://blog.csdn.net/u012394095/article/details/80894140" target="_blank" rel="noopener">sharedCode:深入理解Eureka缓存机制（八）</a></p>
<p>[xmz_java:Eureka 缓存结构以及服务感知优化](<a href="https://www.cnblogs.com/xmzJava/p/11359636.html）" target="_blank" rel="noopener">https://www.cnblogs.com/xmzJava/p/11359636.html）</a></p>
<p>[宜信技术:详解Eureka 缓存机制](<a href="https://www.cnblogs.com/yixinjishu/p/10871243.html）" target="_blank" rel="noopener">https://www.cnblogs.com/yixinjishu/p/10871243.html）</a></p>
<p><strong>Spring Cloud版本：Finchley.RELEASE</strong></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/02/09/【MySQL】更新语句执行流程/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="shan">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="SHAN">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/02/09/【MySQL】更新语句执行流程/" itemprop="url">【MySQL】更新语句执行流程</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-02-09T22:00:00+08:00">
                2020-02-09
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong>buffer pool</strong></p>
<blockquote>
<p>buffer pool缓冲池，用来缓存数据页，避免每次都从磁盘上加载数据，由于buffer pool是基于内存的，所以查询速度非常快。</p>
</blockquote>
<p><strong>undo log</strong></p>
<blockquote>
<p>undo log回滚日志，记录了SQL执行之前的旧值，用来做数据回滚。</p>
</blockquote>
<p><strong>redo log</strong></p>
<blockquote>
<p>redo log重做日志，是InnoDB存储引擎的日志，记录的是数据页的物理修改，在某个数据页上做了什么修改，用来恢复数据使用。</p>
</blockquote>
<p><strong>binlog</strong></p>
<blockquote>
<p>binlog 数据库的二进制日志，同样记录了数据的修改，binlog是MySQL的Server层实现的，所有引擎都可以使用。</p>
</blockquote>
<ol>
<li>当一条更新SQL语句执行时，首先会查看数据是否在缓冲池中，如果在更新缓冲池中的数据，如果不在，会从磁盘中将数据加载到缓冲池buffer pool（对于非唯一索引来说，可以使用change buffer,将修改先记录在change buffer中，之后再merge到原数据页）。</li>
<li>当数据加载到buffer pool中之后，首先会在undo log中记录修改前的数据，便于数据回滚。</li>
<li>更新buffer pool中的缓存数据，注意此时只是在缓存池中更新了数据，并没有更新到磁盘上，如果数据库宕机，数据会丢失。</li>
<li>将修改写入redo log中，redo log也有缓冲区redo log buffer,所以也就是会将数据先写入redo log buffer中，记录对数据的修改，由于redo log buffer也基于内存，所以此时数据库宕机依旧有丢失数据的风险。</li>
<li>提交事务，当提交事务之后，会根据一定的策略将redo log buffer的数据刷入redo log磁盘文件中，此时如果数据库宕机，重启的时候即可根据redo log文件进行数据恢复。</li>
<li>将更新内容写入binlog磁盘文件。</li>
<li>将更新对应的binlog文件名称和更新的binlog日志文件位置写入redo log文件中，并写入commit标记，用来保持redo log和binlog的一致性，此时mysql异常宕机，可以通过redo log和binlog的一致性判断是否需要恢复数据。</li>
<li>此时事务完成提交，需要注意的是此时数据只是在buffer pool中修改了，并且记录到了redo log和binlog，此时磁盘数据文件中还是旧数据，所以MySql有一个后台的IO线程，会根据配置决定何时将buffer pool中的脏数据刷新到磁盘上的数据文件中。</li>
</ol>
<p><img src="/images/update_process.png" alt=""> </p>
<h3 id="redo-log的写入机制"><a href="#redo-log的写入机制" class="headerlink" title="redo log的写入机制"></a>redo log的写入机制</h3><p><strong>innodb_flush_log_at_trx_commit</strong>:</p>
<ul>
<li>设置为 0 的时候，表示每次事务提交时都只是把 redo log 留在 redo log buffer 中 ;</li>
<li>设置为 1 的时候，表示每次事务提交时都将 redo log 直接持久化到磁盘；</li>
<li>设置为 2 的时候，表示每次事务提交时都只是把 redo log 写到 page cache。</li>
</ul>
<p>InnoDB 有一个后台线程，每隔 1 秒，就会把 redo log buffer 中的日志，调用 write 写到文件系统的 page cache，然后调用 fsync 持久化到磁盘。</p>
<p><img src="/images/redolog_write.png" alt=""> </p>
<h3 id="binlog的写入机制"><a href="#binlog的写入机制" class="headerlink" title="binlog的写入机制"></a>binlog的写入机制</h3><p>系统为每个线程分配一片内存为binlog做缓存(binlog cache)，事务执行过程中，先将内容写入binlog cache，当事务提交时，会把binlog cache写到binlog文件中，然后清空binlog cache，由于binlog存储在文件系统的 page cache，并没有持久化到磁盘，所以系统根据sync_binlog的配置判断何时将binlog文件的内容fsync到磁盘。</p>
<p><strong>binlog_cache_size:</strong></p>
<p>在事务写入binlog cache时，一个事务的binlog是不能被拆分的，需要确保一次性写入,binlog_cache_size用于控制binlog cache的大小。</p>
<p><strong>sync_binlog：</strong></p>
<ul>
<li>sync_binlog=0 的时候，表示每次提交事务都只 write，不 fsync；</li>
<li>sync_binlog=1 的时候，表示每次提交事务都会执行 fsync；</li>
<li>sync_binlog=N(N&gt;1) 的时候，表示每次提交事务都 write，但累积 N 个事务后才 fsync。</li>
</ul>
<p><img src="/images/binlog_write.png" alt=""> </p>
<h3 id="change-buffer"><a href="#change-buffer" class="headerlink" title="change buffer"></a>change buffer</h3><p>我们知道，更新一条数据的时候，如果数据页就在buffer pool中，直接更新buffer pool中的数据，如果数据页不在buffer pool中，对于非唯一索引来说，由于不需要检查唯一性，InnoDb会将这些更新操作先缓存在change buffer中，可以避免从磁盘中加载数据页，减少磁盘的IO，在下次需要访问这个数据页的数据时，再从磁盘加载到内存，将changer buffer中的更新操作应用到原数据页中，这个过程被称为merge：</p>
<p><img src="/images/changebuffer.png" alt=""> </p>
<blockquote>
<p>对于唯一索引，所有的更新操作必须要检查是否违法唯一约束，假如数据页不在buffer pool，必须要将数据页读入内存才可以判断（这里可以理解为读取索引页，通过索引判断唯一性），所以change buffer对于唯一索引并不适用。</p>
</blockquote>
<p>change buffer是buffer pool的一部分，innodb_change_buffer_max_size参数可以设置其在buffer pool中的占比。</p>
<p><strong>change buffer的适用场景：</strong></p>
<p>适用于写多读少的场景，假如写入之后马上就要查询，即便已经将更新记录在了change buffer，由于需要查询，必须要从磁盘加载数据页才能读取到数据，然后触发merge操作，这样并不会减少磁盘的IO操作。</p>
<p><strong>change buffer和redo log的侧重点：</strong></p>
<p>change buffer主要是为了减少随机读磁盘的IO消耗。</p>
<p>redo log主要是为了减少随机写磁盘的IO消耗，redo log将磁盘的随机IO转为了顺序写，提升了速度。</p>
<p><strong>参考：</strong></p>
<p>救火队队长：从零开始带你成为MySQL实战优化高手</p>
<p>极客时间 — 林晓斌（丁奇）：MySQL实战</p>
<p><a href="https://blog.csdn.net/qq_36652619/article/details/89460786" target="_blank" rel="noopener">MySQL 之 InnoDB引擎 Change Buffer</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/11/18/AbstractQueuedSynchronizer源码学习/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="shan">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="SHAN">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/11/18/AbstractQueuedSynchronizer源码学习/" itemprop="url">AbstractQueuedSynchronizer源码学习</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-11-18T23:30:00+08:00">
                2019-11-18
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong>AQS内部的同步队列</strong></p>
<p>AQS内部的同步队列是一个双向队列，队列中的元素是AQS中的Node节点：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Node</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 共享锁</span></span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">final</span> Node SHARED = <span class="keyword">new</span> Node();</span><br><span class="line">        <span class="comment">// 独占锁</span></span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">final</span> Node EXCLUSIVE = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/** 取消状态，处于取消状态的线程不再竞争锁，等待被GC回收 */</span></span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CANCELLED =  <span class="number">1</span>;</span><br><span class="line">       </span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SIGNAL    = -<span class="number">1</span>;</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CONDITION = -<span class="number">2</span>;</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> PROPAGATE = -<span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 等待状态</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">volatile</span> <span class="keyword">int</span> waitStatus;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 前置节点，当前节点的前一个节点</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">volatile</span> Node prev;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 后置节点，当前节点的下一个节点</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">volatile</span> Node next;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 节点绑定的线程</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">volatile</span> Thread thread;</span><br><span class="line">        </span><br><span class="line">        Node nextWaiter;</span><br><span class="line">        </span><br><span class="line">        ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>waitStatus等待状态的五种情况</strong></p>
<ul>
<li>CANCELLED：对应的值为1，表示节点对应的线程被取消，处于取消状态的节点不会再竞争锁</li>
<li>SIGNAL：对应的值为-1，表示该节点后面的节点的线程处于等待获取锁的状态</li>
<li>CONDITION：对应的值为-2，表示节点在等待队列中</li>
<li>PROPAGATE：对应的值为-3，表示下一次共享式同步状态获取将被无条件的传播</li>
<li>节点的初始状态：对应的值为0</li>
</ul>
<h2 id="源码"><a href="#源码" class="headerlink" title="源码"></a>源码</h2><h3 id="1-acquire"><a href="#1-acquire" class="headerlink" title="1. acquire()"></a>1. acquire()</h3><p>（1）调用tryAcquire获取锁，如果获取失败调用addWaiter为当前的线程创建Node节点，并调用acquireQueued处理创建的节点：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取锁</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> arg</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">acquire</span><span class="params">(<span class="keyword">int</span> arg)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 调用tryAcquire获取锁，如果获取失败，调用addWaiter将任务封装成Node加入队列，调用acquireQueued处理创建的节点</span></span><br><span class="line">    <span class="keyword">if</span> (!tryAcquire(arg) &amp;&amp;</span><br><span class="line">            acquireQueued(addWaiter(Node.EXCLUSIVE), arg))</span><br><span class="line">        selfInterrupt();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>AQS中并没有实现tryAcquire方法，只是在方法中抛出了一个异常，需要由AQS的子类来实现该方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">tryAcquire</span><span class="params">(<span class="keyword">int</span> arg)</span> </span>&#123;</span><br><span class="line">     <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException();</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-addWaiter"><a href="#2-addWaiter" class="headerlink" title="2. addWaiter()"></a>2. addWaiter()</h3><p>addWaiter方法主要为当前线程创建节点，然后返回创建的节点，在这个方法中有一个队列尾节点为空的判断：</p>
<p>（1）如果尾节点tail不为空，说明队列中已经存在节点，直接将新建的节点加到队列的尾部，然后通过CAS方式将当前节点置为尾节点即可。</p>
<p>（2）如果尾节点为空，说明同步队列中还没有节点，调用enq方法初始化队列的头结点和尾节点，并将当前节点加入队列。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 创建节点</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> Node <span class="title">addWaiter</span><span class="params">(Node mode)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 创建节点，绑定当前线程</span></span><br><span class="line">    Node node = <span class="keyword">new</span> Node(Thread.currentThread(), mode);</span><br><span class="line">    <span class="comment">// 尾节点</span></span><br><span class="line">    Node pred = tail;</span><br><span class="line">    <span class="comment">// 如果尾节点不为空</span></span><br><span class="line">    <span class="keyword">if</span> (pred != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 将新的节点加入到尾节点之后</span></span><br><span class="line">        node.prev = pred;</span><br><span class="line">        <span class="comment">// CAS将新建的节点设置成尾节点</span></span><br><span class="line">        <span class="keyword">if</span> (compareAndSetTail(pred, node)) &#123;</span><br><span class="line">            pred.next = node;</span><br><span class="line">            <span class="keyword">return</span> node;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果尾节点为空，在enq中初始化head和tail节点之后再把新节点插入到队列后边</span></span><br><span class="line">    enq(node);</span><br><span class="line">    <span class="keyword">return</span> node;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="enq"><a href="#enq" class="headerlink" title="enq()"></a>enq()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 初始化队列的头结点和尾节点，并将传入的节点加入队列</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> node</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">private</span> Node <span class="title">enq</span><span class="params">(<span class="keyword">final</span> Node node)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">          Node t = tail;</span><br><span class="line">          <span class="keyword">if</span> (t == <span class="keyword">null</span>) &#123;</span><br><span class="line">              <span class="comment">// 创建一个新节点，当做头结点，并设置尾节点</span></span><br><span class="line">              <span class="keyword">if</span> (compareAndSetHead(<span class="keyword">new</span> Node()))</span><br><span class="line">                  tail = head;</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">              <span class="comment">// 将传入的节点插入到头结点之后并设为尾节点</span></span><br><span class="line">              node.prev = t;</span><br><span class="line">              <span class="keyword">if</span> (compareAndSetTail(t, node)) &#123;</span><br><span class="line">                  t.next = node;</span><br><span class="line">                  <span class="keyword">return</span> t;</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h3 id="3-acquireQueued"><a href="#3-acquireQueued" class="headerlink" title="3. acquireQueued()"></a>3. acquireQueued()</h3><p>acquireQueued方法主要用来对节点进行处理，在方法中有一个for循环不断的在尝试获取锁以及判断当前任务是否应该被阻塞等待：</p>
<p>判断当前节点的前一个节点是否为头结点：</p>
<p>（1）当前节点的前一个节点是头结点，因为当前节点的前一个节点是头结点，此时重新调用tryAcquire方法尝试获取锁，如果获取成功将当前节点置为头结点，并将之前的头结点的next置为空，等待被回收，然后返回线程的中断状态，如果获取失败继续for循环的流程。</p>
<p>（2）当前节点的前一个节点不是头结点，调用shouldParkAfterFailedAcquire方法设置节点的等待状态，shouldParkAfterFailedAcquire方法如果返回true（返回true表示当前节点已处于等待状态可以被阻塞），执行parkAndCheckInterrupt方法，这个方法用来阻塞当前线程直到被唤醒，之后返回线程的中断状态。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">acquireQueued</span><span class="params">(<span class="keyword">final</span> Node node, <span class="keyword">int</span> arg)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">boolean</span> failed = <span class="keyword">true</span>;</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           <span class="keyword">boolean</span> interrupted = <span class="keyword">false</span>;</span><br><span class="line">           <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">               <span class="keyword">final</span> Node p = node.predecessor();</span><br><span class="line">               <span class="comment">// 如果当前节点的前一个节点为头结点，重新调用tryAcquire方法尝试获取锁</span></span><br><span class="line">               <span class="keyword">if</span> (p == head &amp;&amp; tryAcquire(arg)) &#123;</span><br><span class="line">                   <span class="comment">// 如果获取锁成功，将当前节点置为头结点</span></span><br><span class="line">                   setHead(node);</span><br><span class="line">                   <span class="comment">// 将之前的头结点的next置为空</span></span><br><span class="line">                   p.next = <span class="keyword">null</span>; <span class="comment">// help GC</span></span><br><span class="line">                   failed = <span class="keyword">false</span>;</span><br><span class="line">                   <span class="comment">// 返回中断状态</span></span><br><span class="line">                   <span class="keyword">return</span> interrupted;</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="comment">// 如果当前节点的前一个节点不是头结点</span></span><br><span class="line">               <span class="comment">// shouldParkAfterFailedAcquire中设置当前节点的前一个节点的等待状态，让前一个节点知道当前节点进入等待</span></span><br><span class="line">               <span class="comment">// parkAndCheckInterrupt让当前线程进入阻塞状态，直到被唤醒之后，继续执行，并返回中断状态</span></span><br><span class="line">               <span class="keyword">if</span> (shouldParkAfterFailedAcquire(p, node) &amp;&amp;</span><br><span class="line">                       parkAndCheckInterrupt())</span><br><span class="line">                   interrupted = <span class="keyword">true</span>;<span class="comment">// 记录中断状态</span></span><br><span class="line">           &#125;</span><br><span class="line">       &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">           <span class="keyword">if</span> (failed)</span><br><span class="line">               cancelAcquire(node);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<h4 id="shouldParkAfterFailedAcquire"><a href="#shouldParkAfterFailedAcquire" class="headerlink" title="shouldParkAfterFailedAcquire()"></a>shouldParkAfterFailedAcquire()</h4><p> 在shouldParkAfterFailedAcquire方法中，==主要是为了让当前节点处于等待状态==，设置的方式是找到当前节点之前第一个waitStatus等于或小于0的节点，然后设置prev的waitStatus。</p>
<blockquote>
<p><strong>为什么要找到waitStatus等于或小于0的节点？</strong></p>
<p>通过waitStatus的几种值可以知道大于0的时候表示这个节点处于取消状态，之后是要从队列中移除的，所以要不断向前找，直到找到waitStatus等于或小于0的节点。</p>
</blockquote>
<p> 因为节点的等待状态可能会发生变化，所以先判断当前节点的前一个节点的等待状态waitStatus:</p>
<p> （1）等待状态是-1，表示这个节点之后的节点处于等待锁的状态，此时直接返回true即可。</p>
<p> （2）等待状态大于0，表示pred节点可能已被取消，此时要跳过这个节点，一直往上一个节点找，直到找到一个等待状态小于或者等于0的节点，并将这个节点的next指向当前节点（此时shouldParkAfterFailedAcquire返回的结果为false）。</p>
<p> （3）如果当前节点的前一个节点perd的等待状态既不等于-1，也不大于0，此时将pred的等待状态设为-1，表示这个节点之后的节点处于等待锁的状态（此时shouldParkAfterFailedAcquire返回的结果为false）。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">shouldParkAfterFailedAcquire</span><span class="params">(Node pred, Node node)</span> </span>&#123;</span><br><span class="line">     <span class="comment">// 当前节点的前一个节点的等待状态</span></span><br><span class="line">     <span class="keyword">int</span> ws = pred.waitStatus;</span><br><span class="line">     <span class="comment">// 如果是signal状态（-1），返回true</span></span><br><span class="line">     <span class="keyword">if</span> (ws == Node.SIGNAL)</span><br><span class="line">         <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">     <span class="keyword">if</span> (ws &gt; <span class="number">0</span>) &#123;</span><br><span class="line">         <span class="comment">// 如果当前节点的前一个节点的等待状态大于0，从前一个节点开始一直往前找，直到找到等待状态不大于0的节点，返回false</span></span><br><span class="line">         <span class="keyword">do</span> &#123;</span><br><span class="line">             node.prev = pred = pred.prev;</span><br><span class="line">         &#125; <span class="keyword">while</span> (pred.waitStatus &gt; <span class="number">0</span>);</span><br><span class="line">         pred.next = node;</span><br><span class="line">     &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">         <span class="comment">// 当前节点的前一个节点的状态既不等于-1，也不大于0，设置当前节点的前一个节点的状态为signal（-1）</span></span><br><span class="line">         compareAndSetWaitStatus(pred, ws, Node.SIGNAL);</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>由上可知shouldParkAfterFailedAcquire中当前节点的前一个节点的等待状态是-1时返回的是true，其他情况返回false，但是返回false之后下一次再执行shouldParkAfterFailedAcquire，就可以满足条件返回true（因为调用了compareAndSetWaitStatus方法设置前一个节点的等待状态是-1，所以第二次进入可以满足条件）。</p>
<h4 id="parkAndCheckInterrupt"><a href="#parkAndCheckInterrupt" class="headerlink" title="parkAndCheckInterrupt()"></a>parkAndCheckInterrupt()</h4><p>parkAndCheckInterrupt方法用来阻塞当前线程，然后返回线程的中断状态。LockSupport.park(this)会让当前线程进入阻塞状态，直到被其他线程唤醒（或者被中断），然后会调用Thread.interrupted()返回线程的中断位：</p>
<ul>
<li>如果当前线程处于中断状态，Thread.interrupted()返回true，下次调用Thread.interrupted()将会返回false，因为中断位被重置了。</li>
<li>如果当前线程处于非中断状态，Thread.interrupted()返回false。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 阻塞线程</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">parkAndCheckInterrupt</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 阻塞当前的线程</span></span><br><span class="line">    LockSupport.park(<span class="keyword">this</span>);</span><br><span class="line">    <span class="comment">// 返回当前线程的中断位</span></span><br><span class="line">    <span class="keyword">return</span> Thread.interrupted();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>回到acquiredQueue方法：</p>
<p>如果parkAndCheckInterrupt返回true，将 interrupted 设为 true，记录了线程的中断状态，当线程尝试获取锁成功之后，将interrupted中断中断状态返回：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">acquireQueued</span><span class="params">(<span class="keyword">final</span> Node node, <span class="keyword">int</span> arg)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> failed = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">boolean</span> interrupted = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            <span class="keyword">final</span> Node p = node.predecessor();</span><br><span class="line">            <span class="keyword">if</span> (p == head &amp;&amp; tryAcquire(arg)) &#123;</span><br><span class="line">                setHead(node);</span><br><span class="line">                p.next = <span class="keyword">null</span>; <span class="comment">// help GC</span></span><br><span class="line">                failed = <span class="keyword">false</span>;</span><br><span class="line">                <span class="keyword">return</span> interrupted;<span class="comment">//返回中断状态</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (shouldParkAfterFailedAcquire(p, node) &amp;&amp;</span><br><span class="line">                parkAndCheckInterrupt())</span><br><span class="line">                interrupted = <span class="keyword">true</span>;<span class="comment">//设置中断状态</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (failed)</span><br><span class="line">            cancelAcquire(node);<span class="comment">//取消竞争锁</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>为什么要记录中断状态</strong>？</p>
<p> 假设一个线程被中断唤醒，Thread.interrupted()返回线程的中断状态true，之后在acquireQueued方法中并没有中断线程的相关操作，被中断之后还在尝试获取锁，获取成功之后将中断状态返回（此时返回true），再回到acquire方法中，如果acquireQueued返回true代表线程被中断过，此时调用selfInterrupt方法，来中断当前线程，由于调用Thread.interrupted()的时候会重置中断位，此时不能靠Thread.interrupted()判断中断位，所以要记录一下中断状态表明线程被中断过，然后根据这个状态在acquire方法做中断处理。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">acquire</span><span class="params">(<span class="keyword">int</span> arg)</span> </span>&#123;</span><br><span class="line">          <span class="comment">// 调用tryAcquire获取锁，如果获取失败，调用addWaiter将任务封装成Node，调用acquireQueued将node加入队列</span></span><br><span class="line">          <span class="keyword">if</span> (!tryAcquire(arg) &amp;&amp;</span><br><span class="line">                  acquireQueued(addWaiter(Node.EXCLUSIVE), arg))</span><br><span class="line">              selfInterrupt();</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h4 id="4-cancelAcquire"><a href="#4-cancelAcquire" class="headerlink" title="4.cancelAcquire()"></a>4.cancelAcquire()</h4><p>在acquireQueued方法的finally语句块中，如果在循环的过程中出现了异常，则执行cancelAcquire方法，用于将该节点标记为取消状态。<br>cancelAcquire()方法中，首先也要找到当前节点之前第一个waitStatus&lt;=0的节点pred，此时当前节点有三种情况：</p>
<p>（1）当前节点如果是尾节点，当前节点直接从队尾删掉即可，先将pred的next置为空，然后pred设为尾节点。</p>
<p>（2）pred不是头结点，也就是说当前节点处于队列中间，并且它的前一个节点pred（指的是第一个waitStatus&lt;=0的节点）不是头结点，此时判断pred的等待状态，如果是SIGNAL或者非SIGNAL，就调用compareAndSetWaitStatus方法将它的状态置为SIGNAL，然后将当前节点的下一个节点置为到pred的下一个节点。</p>
<p>（3）pred是头结点，也就是当前节点在头结点之后，此时直接唤醒后继节点即可。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">cancelAcquire</span><span class="params">(Node node)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 节点为直接返回</span></span><br><span class="line">    <span class="keyword">if</span> (node == <span class="keyword">null</span>)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    <span class="comment">// 将节点绑定的线程置为空</span></span><br><span class="line">    node.thread = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取当前节点的前一个节点</span></span><br><span class="line">    Node pred = node.prev;</span><br><span class="line">    <span class="comment">// 从当前节点的前一个节点开始，直到找到waitStatus&lt;=0的节点记为pred</span></span><br><span class="line">    <span class="keyword">while</span> (pred.waitStatus &gt; <span class="number">0</span>)</span><br><span class="line">        node.prev = pred = pred.prev;</span><br><span class="line">    <span class="comment">// pred的下一个节点</span></span><br><span class="line">    Node predNext = pred.next;</span><br><span class="line">    <span class="comment">// 将当前节点的等待状态置为取消</span></span><br><span class="line">    node.waitStatus = Node.CANCELLED;</span><br><span class="line">    <span class="comment">// （1）如果当前节点是尾节点，将pred置为尾节点</span></span><br><span class="line">    <span class="keyword">if</span> (node == tail &amp;&amp; compareAndSetTail(node, pred)) &#123;</span><br><span class="line">        <span class="comment">//将pred的next置为空</span></span><br><span class="line">        compareAndSetNext(pred, predNext, <span class="keyword">null</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">int</span> ws;</span><br><span class="line">        <span class="comment">//（2）当前节点位于队列中间的情况</span></span><br><span class="line">        <span class="comment">// 当前节点不是head节点的下一个节点，或者pred的等待状态是SIGNAL 再或者不是SIGNAL，就将pred的等待状态置为SIGNAL</span></span><br><span class="line">        <span class="keyword">if</span> (pred != head &amp;&amp;</span><br><span class="line">                ((ws = pred.waitStatus) == Node.SIGNAL ||</span><br><span class="line">                        (ws &lt;= <span class="number">0</span> &amp;&amp; compareAndSetWaitStatus(pred, ws, Node.SIGNAL))) &amp;&amp;</span><br><span class="line">                pred.thread != <span class="keyword">null</span>) &#123;<span class="comment">// pred绑定的线程也不能为空</span></span><br><span class="line">            <span class="comment">//当前节点的下一个节点</span></span><br><span class="line">            Node next = node.next;</span><br><span class="line">            <span class="comment">// 如果下一个节点不为空并且不是取消状态</span></span><br><span class="line">            <span class="keyword">if</span> (next != <span class="keyword">null</span> &amp;&amp; next.waitStatus &lt;= <span class="number">0</span>)</span><br><span class="line">                <span class="comment">// 将pred的下一个节点指向当前节点的下一个节点</span></span><br><span class="line">                compareAndSetNext(pred, predNext, next);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//（3）当前节点是头结点的下一个节点,唤醒后继节点</span></span><br><span class="line">            unparkSuccessor(node);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 当前节点的下一个节点指向自己等待回收</span></span><br><span class="line">        node.next = node;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="5-release"><a href="#5-release" class="headerlink" title="5.release()"></a>5.release()</h4><p>release方法用来释放锁，释放锁的实现在tryRelease方法，由AQS的子类来实现这个方法，释放锁成功之后，调用unparkSuccessor方法从头结点开始唤醒之后的节点。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">release</span><span class="params">(<span class="keyword">int</span> arg)</span> </span>&#123;</span><br><span class="line">     <span class="comment">// tryRelease由AQS子类实现，用来释放锁，如果释放锁成功</span></span><br><span class="line">     <span class="keyword">if</span> (tryRelease(arg)) &#123;</span><br><span class="line">         <span class="comment">// 头结点</span></span><br><span class="line">         Node h = head;</span><br><span class="line">         <span class="comment">// 如果队列头节点不为空并且等待装不是0，头结点初始化时等待状态为0，不为0表示它之后的节点处于等待状态</span></span><br><span class="line">         <span class="keyword">if</span> (h != <span class="keyword">null</span> &amp;&amp; h.waitStatus != <span class="number">0</span>)</span><br><span class="line">             <span class="comment">// 唤醒头结点的后继节点</span></span><br><span class="line">             unparkSuccessor(h);</span><br><span class="line">         <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"> <span class="comment">// 唤醒后继节点</span></span><br><span class="line"> <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">unparkSuccessor</span><span class="params">(Node node)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">int</span> ws = node.waitStatus;</span><br><span class="line">     <span class="comment">// 如果当前节点的等待状态小于0，将等待状态置为0</span></span><br><span class="line">     <span class="keyword">if</span> (ws &lt; <span class="number">0</span>)</span><br><span class="line">         compareAndSetWaitStatus(node, ws, <span class="number">0</span>);</span><br><span class="line">     <span class="comment">// 当前节点的下一个节点</span></span><br><span class="line">     Node s = node.next;</span><br><span class="line">     <span class="comment">// 下一个节点为空或者状态是取消</span></span><br><span class="line">     <span class="keyword">if</span> (s == <span class="keyword">null</span> || s.waitStatus &gt; <span class="number">0</span>) &#123;</span><br><span class="line">         s = <span class="keyword">null</span>;</span><br><span class="line">         <span class="comment">// 从队列的尾部开始向前查找，直到找到第一个等待状态&lt;=0的节点</span></span><br><span class="line">         <span class="keyword">for</span> (Node t = tail; t != <span class="keyword">null</span> &amp;&amp; t != node; t = t.prev)</span><br><span class="line">             <span class="keyword">if</span> (t.waitStatus &lt;= <span class="number">0</span>)</span><br><span class="line">                 s = t;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">if</span> (s != <span class="keyword">null</span>)</span><br><span class="line">         <span class="comment">// 唤醒节点绑定的线程</span></span><br><span class="line">         LockSupport.unpark(s.thread);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>参考：</strong></p>
<p>[Idea Buffer:深入理解AbstractQueuedSynchronizer（一）]（<a href="http://www.ideabuffer.cn/2017/03/15/深入理解AbstractQueuedSynchronizer（一）/）" target="_blank" rel="noopener">http://www.ideabuffer.cn/2017/03/15/深入理解AbstractQueuedSynchronizer（一）/）</a></p>
<p><a href="https://mp.weixin.qq.com/s/3eUiYIxCU4XVw3p3wy4bKA" target="_blank" rel="noopener">我们都是小青蛙：java并发性能（五）</a></p>
<p><a href="http://blog.zhangjikai.com/2017/04/15/【Java-并发】详解-AbstractQueuedSynchronizer/" target="_blank" rel="noopener">jk’s Blog:【Java并发】详解 AbstractQueuedSynchronizer</a></p>
<p><a href="https://www.cnblogs.com/waterystone/p/4920797.html" target="_blank" rel="noopener">waterystone：Java并发之AQS详解</a></p>
<p><a href="https://www.cnblogs.com/go2sea/p/5618628.html" target="_blank" rel="noopener">go2sea：Java多线程之JUC包：AbstractQueuedSynchronizer（AQS）源码学习笔记</a></p>
<p><strong>jdk版本:1.8</strong></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">shan</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">24</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                
                  <span class="site-state-item-count">7</span>
                  <span class="site-state-item-name">tags</span>
                
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">shan</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
